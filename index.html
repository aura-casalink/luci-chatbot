<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luci - Asistente Inmobiliario</title>
    <link href="https://fonts.googleapis.com/css2?family=Graphik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Graphik', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Menú lateral */
        .sidebar {
            width: 250px;
            background-color: #edf2f4;
            padding: 20px;
            border-right: 1px solid #ddd;
        }

        .sidebar h3 {
            color: black;
            margin-bottom: 15px;
            font-size: 16px;
            font-family: 'Graphik', sans-serif;
            font-weight: bold;
        }

        .new-chat-button {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            margin-bottom: 20px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            color: black;
            font-size: 14px;
            font-family: 'Graphik', sans-serif;
            cursor: pointer;
            transition: background-color 0.2s;
            border: none;
            width: 100%;
        }

        .new-chat-button:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }

        .conversation-section {
            margin-bottom: 20px;
        }

        .conversation-section-title {
            font-size: 12px;
            color: #666;
            font-family: 'Graphik', sans-serif;
            font-weight: bold;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .conversation-item {
            padding: 10px;
            margin-bottom: 8px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: black;
            font-size: 14px;
            font-family: 'Graphik', sans-serif;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .conversation-item:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .conversation-item.active {
            background-color: rgba(255, 255, 255, 0.5);
            border-left: 3px solid #007bff;
        }

        .no-conversations {
            text-align: center;
            color: #666;
            font-size: 14px;
            font-style: italic;
            padding: 20px 0;
        }

        /* Área principal */
        .main-area {
            flex: 1;
            background-color: white;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Estado inicial */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 40px;
            opacity: 1;
            transition: opacity 0.3s ease-out;
        }

        .welcome-screen.fade-out {
            opacity: 0;
        }

        .welcome-title {
            font-family: 'Graphik', sans-serif;
            font-weight: bold;
            font-size: 32px;
            color: black;
            margin-bottom: 40px;
            text-align: center;
        }

        .buttons-container {
            background-color: #fbfcfd;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .option-button {
            flex: 1;
            min-width: 300px;
            padding: 15px 20px;
            background-color: white;
            color: #b8c1c8;
            border: 1px solid #ddd;
            border-radius: 12px;
            font-family: 'Graphik', sans-serif;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .option-button:hover {
            background-color: #f8f9fa;
            border-color: #007bff;
            color: black;
        }

        .option-button:last-child {
            margin-bottom: 0;
        }

        /* Estado de chat */
        .chat-screen {
            display: none;
            flex-direction: column;
            height: 100%;
            opacity: 0;
            transition: opacity 0.3s ease-in;
        }

        .chat-screen.fade-in {
            opacity: 1;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: none;
        }

        .chat-title {
            font-family: 'Graphik', sans-serif;
            font-weight: bold;
            font-size: 24px;
            color: black;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .message {
            max-width: 70%;
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 18px;
            word-wrap: break-word;
            font-family: 'Graphik', sans-serif;
        }

        .message.assistant {
            background-color: white;
            border: 1px solid #ddd;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .message.user {
            background-color: #edf2f4;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.error {
            background-color: #fee;
            color: #c53030;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .chat-input-container {
            padding: 30px;
            border-top: 1px solid #eee;
            width: 100%;
        }

        .chat-input-wrapper {
            display: flex;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 25px;
            padding: 5px;
            align-items: flex-end;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 100%;
        }

        .chat-input {
            flex: 1;
            border: none;
            outline: none;
            padding: 15px 20px;
            font-size: 16px;
            font-family: 'Graphik', sans-serif;
            border-radius: 20px;
            resize: none;
            max-height: 120px;
            min-height: 80px;
            width: 100%;
        }

        .send-button {
            background-color: #edf2f4;
            color: #333;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-right: 5px;
            margin-bottom: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }

        .send-button:hover {
            background-color: #d1d9db;
        }

        .send-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        /* Estilos para las tarjetas de propiedades */
        .properties-container {
            display: flex;
            gap: 15px;
            margin: 10px 0;
            justify-content: flex-start;
        }
        
        .property-thumbnail {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .property-thumbnail::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.7);
            transition: opacity 0.3s ease;
            z-index: 1;
        }
        
        .property-thumbnail:hover::before {
            opacity: 0;
        }
        
        .property-thumbnail:hover {
            transform: scale(1.1);
        }
        
        .property-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: zoom-in;
        }
        
        /* Modal de propiedad */
        .property-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .property-card {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        .property-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 1001;
        }
        
        .property-close:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
        }
        
        .property-title {
            font-family: 'Graphik', sans-serif;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
            color: black;
        }
        
        .property-price {
            font-size: 16px;
            color: #007bff;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .property-images {
            position: relative;
            margin-bottom: 15px;
        }
        
        .property-carousel {
            width: 100%;
            height: 200px;
            overflow: hidden;
            border-radius: 8px;
            position: relative;
        }
        
        .property-carousel img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        
        .property-carousel img.active {
            display: block;
        }
        
        .carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
        }
        
        .carousel-prev {
            left: 10px;
        }
        
        .carousel-next {
            right: 10px;
        }
        
        .property-details {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .property-specs {
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-family: 'Graphik', sans-serif;
            font-size: 14px;
        }
        
        .property-spec {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .property-info-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Graphik', sans-serif;
            margin-top: 20px;
            width: 100%;
        }
        
        .property-info-button:hover {
            background-color: #0056b3;
        }

        /* Loader */
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-message {
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 70%;
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 18px;
            background-color: white;
            border: 1px solid #ddd;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            font-family: 'Graphik', sans-serif;
        }

        /* Sidebar colapsada */
        .sidebar.collapsed {
            width: 60px;
            transition: width 0.3s ease;
        }
        
        .sidebar {
            transition: width 0.3s ease;
        }
        
        /* Header de la sidebar */
        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px 0;
            justify-content: flex-start;
        }

        .sidebar.collapsed .sidebar-header {
            justify-content: center;
            gap: 0;
        }
        
        .toggle-sidebar-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background-color 0.2s;
            color: #666;
            z-index: 10;
            position: relative;
        }
        
        .toggle-sidebar-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .toggle-sidebar-btn {
            z-index: 10;
            position: relative;
        }
        
        .show-chats-btn {
            z-index: 10;
            position: relative;
        }
        
        .brand-name {
            font-family: 'Montserrat', sans-serif;
            font-weight: bold;
            font-size: 32px;
            color: black;
            white-space: nowrap;
        }
        
        .sidebar.collapsed .brand-name {
            display: none;
        }
        
        .sidebar.collapsed .conversation-section-title,
        .sidebar.collapsed .conversation-item {
            display: none;
        }
        
        .sidebar.collapsed .new-chat-button {
            justify-content: center;
            align-items: center;
            padding: 0;
            width: 40px;
            height: 40px;
            margin: 10px auto;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            position: relative;
            display: flex;
        }

        .sidebar.collapsed .toggle-sidebar-btn,
        .sidebar.collapsed .show-chats-btn {
            margin: 0 auto;
        }

        .sidebar.collapsed .new-chat-button span:last-child {
            display: none;
        }

        .sidebar.collapsed .new-chat-button span:first-child {
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
                
        .sidebar.collapsed .new-chat-button:hover {
            transform: scale(1.1);
            background-color: rgba(255, 255, 255, 0.4);
        }
        
        /* Botón para mostrar conversaciones */
        .show-chats-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
            color: #666;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px auto;
            z-index: 10;
            position: relative;
        }
        
        .show-chats-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .sidebar.collapsed .show-chats-btn {
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            margin: 0 auto 10px auto;
        }
        
        .sidebar.collapsed .show-chats-btn:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }
        
        .sidebar.collapsed .toggle-sidebar-btn {
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            margin: 0 auto;
        }
        
        .sidebar.collapsed .toggle-sidebar-btn:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }

        .show-conversations-btn {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }
        
        .show-conversations-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .conversations-list {
            transition: all 0.3s ease;
        }
        
        .show-conversations-btn {
            transition: transform 0.3s ease;
        }
                        
        .sidebar:not(.collapsed) .show-chats-btn {
            display: none;
        }
                
        /* Tooltip */
        .tooltip {
            position: relative;
        }
        
        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 60px;
            top: 50%;
            transform: translateY(-50%);
            background-color: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        
        /* Ajustar tooltips cuando la sidebar está expandida */
        .sidebar:not(.collapsed) .tooltip::after {
            top: calc(100% + 10px);
            left: 0;
            transform: none;
        }
        
        .tooltip:hover::after {
            opacity: 1;
        }
        
        /* Botón eliminar conversación */
        .conversation-item {
            position: relative;
        }
        
        .conversation-item:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }
        
        .delete-conversation {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #999;
            font-size: 16px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .conversation-item:hover .delete-conversation {
            opacity: 1;
        }
        
        .delete-conversation:hover {
            background-color: rgba(255, 0, 0, 0.1);
            color: #ff4444;
        }
        
        /* Mensajes antiguos en gris */
        .message.old {
            color: #888;
        }
        
        /* Loading con animación */
        .search-loading-messages {
            animation: fadeInOut 4s infinite;
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
        
        /* Pop-ups */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .popup-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        
        .popup-title {
            font-family: 'Graphik', sans-serif;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 20px;
            color: black;
        }
        
        .popup-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Graphik', sans-serif;
            margin: 10px 0;
            font-size: 16px;
        }
        
        .popup-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .popup-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-family: 'Graphik', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .popup-btn.primary {
            background-color: #007bff;
            color: white;
        }
        
        .popup-btn.secondary {
            background-color: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
        }
        
        .popup-btn:hover {
            transform: translateY(-1px);
        }
        
        .contact-method-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }
        
        .contact-method-btn {
            padding: 10px 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .contact-method-btn.selected {
            border-color: #007bff;
            background-color: #e3f2fd;
        }
        
        .input-with-send {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 15px;
        }
        
        .input-with-send input {
            flex: 1;
        }
        
        .send-icon-btn {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sidebar:not(.collapsed) .new-chat-button {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 10px;
            padding: 12px;
            padding-left: 8px;
            margin-bottom: 20px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            color: black;
            font-size: 14px;
            font-family: 'Graphik', sans-serif;
            cursor: pointer;
            transition: background-color 0.2s;
            border: none;
            width: 100%;
        }
        
        /* Hover mejorado para nuevo chat expandido */
        .sidebar:not(.collapsed) .new-chat-button:hover {
            background-color: rgba(0, 123, 255, 0.1);
            border-color: #007bff;
        }

        /* Modal de zoom para imágenes */
        .image-zoom-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            cursor: zoom-out;
        }
        
        .image-zoom-modal img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        
        .zoom-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            cursor: pointer;
            z-index: 2001;
        }

        .toggle-sidebar-btn img,
        .new-chat-button img,
        .show-chats-btn img {
            transition: all 0.3s ease;
            filter: opacity(0.7);
        }
        
        .toggle-sidebar-btn:hover img,
        .new-chat-button:hover img,
        .show-chats-btn:hover img {
            filter: opacity(1);
            transform: scale(1.1);
        }
        
        /* Ajuste específico para el botón collapsed */
        .sidebar.collapsed .new-chat-button img {
            margin: 0;
            display: block;
        }
        
        /* Mejorar el comportamiento del tooltip cuando hay imágenes */
        .toggle-sidebar-btn,
        .show-chats-btn,
        .new-chat-button {
            display: flex;
            align-items: center;
            justify-content: flex-start !important;
        }
        
        /* Asegurar que las imágenes no interfieran con el tooltip */
        .tooltip img {
            pointer-events: none;
        }
        
       .sidebar.collapsed .new-chat-button::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 50px;
            top: 50%;
            transform: translateY(-50%);
            background-color: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        
        .sidebar.collapsed .new-chat-button:hover::after {
            opacity: 1;
            transition-delay: 0.1s;
        }

        .conversations-toggle-container .new-chat-button {
            padding-left: 8px !important;
            justify-content: flex-start !important;
        }
        
        /* Efectos de aparición suave para textos */
        .sidebar:not(.collapsed) .new-chat-button span:last-child,
        .sidebar:not(.collapsed) .brand-name,
        .sidebar:not(.collapsed) .conversation-section-title,
        .sidebar:not(.collapsed) .conversation-item {
            animation: fadeInText 0.4s ease-in-out;
            animation-fill-mode: both;
        }
        
        .sidebar:not(.collapsed) .new-chat-button span:last-child {
            animation-delay: 0.1s;
        }
        
        .sidebar:not(.collapsed) .brand-name {
            animation-delay: 0.05s;
        }
        
        .sidebar:not(.collapsed) .conversation-section-title {
            animation-delay: 0.15s;
        }
        
        .sidebar:not(.collapsed) .conversation-item {
            animation-delay: 0.2s;
        }
        
        @keyframes fadeInText {
            0% {
                opacity: 0;
                transform: translateX(-10px);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* Para el container de conversaciones también */
        .conversations-toggle-container .new-chat-button span:last-child {
            animation: fadeInText 0.4s ease-in-out 0.1s;
            animation-fill-mode: both;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }
            
            .welcome-title {
                font-size: 24px;
            }
            
            .buttons-container {
                padding: 20px;
                flex-direction: column;
            }
            
            .option-button {
                min-width: auto;
            }
            
            .message {
                max-width: 85%;
            }
        }

        .sidebar:not(.collapsed) .new-chat-button,
        .sidebar:not(.collapsed) .conversations-toggle-container .new-chat-button {
            padding-left: 8px !important;
        }
    </style>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <!-- Menú lateral -->
        <div class="sidebar collapsed" id="sidebar">
            <div class="sidebar-header">
                <button class="toggle-sidebar-btn tooltip" id="toggleSidebar" data-tooltip="Expandir barra principal">
                    <img src="https://cdn-icons-png.flaticon.com/512/10023/10023169.png" alt="Expand" style="width: 21.6px; height: 21.6px; filter: opacity(0.7);">
                </button>
                <span class="brand-name">AURA</span>
            </div>
            
            <button class="new-chat-button tooltip" onclick="newChat()" data-tooltip="Nuevo Chat">
                <span>
                    <img src="https://cdn-icons-png.flaticon.com/512/8922/8922789.png" alt="Plus" style="width: 21.6px; height: 21.6px; filter: opacity(0.7);">
                </span>
                <span>Nuevo Chat</span>
            </button>
            
            <button class="show-chats-btn tooltip" id="showChatsBtn" data-tooltip="Mostrar conversaciones">
                <img src="https://cdn-icons-png.flaticon.com/512/1178/1178067.png" alt="Conversations" style="width: 21.6px; height: 21.6px; filter: opacity(0.7);">
            </button>
            
            <div id="conversationsContainer">
                <!-- Las conversaciones se cargarán dinámicamente aquí -->
            </div>
        </div>

        <!-- Área principal -->
        <div class="main-area">
            <!-- Pantalla de bienvenida -->
            <div class="welcome-screen" id="welcomeScreen">
                <h1 class="welcome-title">Hola, soy Luci. ¿Con qué te puedo ayudar?</h1>
                <div class="buttons-container">
                    <button class="option-button" onclick="selectOption('Buscar propiedades para comprar')">
                        Buscar propiedades para comprar
                    </button>
                    <button class="option-button" onclick="selectOption('Buscar propiedades para alquilar')">
                        Buscar propiedades para alquilar
                    </button>
                    <button class="option-button" onclick="selectOption('Gestión de alquiler')">
                        Gestión de alquiler
                    </button>
                    <button class="option-button" onclick="selectOption('Gestión de financiación')">
                        Gestión de financiación
                    </button>
                </div>
            </div>

            <!-- Pantalla de chat -->
            <div class="chat-screen" id="chatScreen">
                <div class="chat-header">
                    <h2 class="chat-title">Hola, soy Luci. ¿Con qué te puedo ayudar?</h2>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <!-- Los mensajes aparecerán aquí -->
                </div>

                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <textarea 
                            class="chat-input" 
                            id="chatInput" 
                            placeholder="Escribe tu mensaje..."
                            rows="1"
                        ></textarea>
                        <button class="send-button" id="sendButton" onclick="sendMessage()">
                            ➤
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let isWaitingForResponse = false;
        let currentSessionId = null;
        let deviceId = null;
        let userIP = null;
        let currentConversation = [];
        let supabase = null;
        let supabaseClient = null;
        let currentTopic = null;
        let currentConversationTitle = null;
        let pendingCallback = false;
        let realtimeChannel = null;
        // Variables para timeout y popup
        let callbackTimeout = null;
        let searchMessageInterval = null;
        let currentSearchMessageIndex = 0;
        
        const searchMessages = [
            "Buscando Propiedades",
            "Tardamos 3 minutos de media",
            "Ajustando búsqueda a tus Criterios"
        ];
        
        // Configuración de Supabase
        const SUPABASE_URL = 'https://uxyxxhsgkprnuxohjhbc.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV4eXh4aHNna3BybnV4b2hqaGJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1NTM3ODEsImV4cCI6MjA1ODEyOTc4MX0.P_ggSy3oU2AvS55fQdwpnk3aFgznfVr6uCdqWH36IwY';
        
        // Inicializar Supabase cuando la librería esté cargada
       function initializeSupabase() {
            return new Promise((resolve) => {
                const checkSupabase = () => {                    
                    if (window.supabase) {
                        try {
                            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                            resolve(true);
                        } catch (error) {
                            console.error('Error al inicializar Supabase:', error);
                            resolve(false);
                        }
                    } else {
                        console.log('window.supabase no está disponible aún, reintentando...');
                        setTimeout(checkSupabase, 200);
                    }
                };
                
                // Esperar un poco antes de la primera verificación
                setTimeout(checkSupabase, 500);
            });
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeSupabase();
            await initializeApp();
            supabaseClient = supabase;

            // Event listeners para sidebar
            document.getElementById('toggleSidebar').addEventListener('click', toggleSidebar);
            document.getElementById('showChatsBtn').addEventListener('click', expandSidebar);
            
            // Exponemos estas dos funciones para poder invocarlas desde consola o botones
            window.activateTestMode = function(sessionId) {
                currentSessionId = sessionId;
                pendingCallback = true; 
                addMessage('Hola, soy Luci. ¿Con qué te puedo ayudar?', 'assistant');
                addMessage(`Sesión de prueba: ${sessionId}`, 'user');
                startRealtimeSubscription(sessionId);
                console.log('Modo test activado - pendingCallback:', pendingCallback);
            };
            
            window.sendCallbackManually = async function(textoUsuario) {
                if (!currentSessionId) return;
                addMessage(textoUsuario, 'user');
                try {
                  const response = await fetch(`/api/callback?sessionId=${currentSessionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      message: textoUsuario,
                      session_id: currentSessionId
                    })
                  });
                  const json = await response.json();
                  console.log('Respuesta /api/callback:', json);
                } catch (err) {
                  console.error('Error enviando callback:', err);
                }
              };
            
              document.getElementById('sendButton').addEventListener('click', () => {
                const texto = document.getElementById('chatInput').value.trim();
                if (texto) {
                  sendCallbackManually(texto);
                  document.getElementById('chatInput').value = '';
                }
              });
            
              window.addEventListener('beforeunload', () => {
                if (realtimeChannel) {
                  supabase.removeChannel(realtimeChannel);
                  realtimeChannel = null;
                  console.log('Suscripción Realtime cancelada por navegación');
                }
              });
        });

        function startRealtimeSubscription(sessionId) {
            if (realtimeChannel) {
                supabase.removeChannel(realtimeChannel);
                realtimeChannel = null;
            }
            currentSessionId = sessionId;
            realtimeChannel = supabase
                .channel('public:callbacks')
                .on(
                'postgres_changes',
                {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'callbacks',
                },
                (payload) => {
                    const row = payload.new;
                    if (row.session_id !== sessionId || !row.pending) {
                        return;
                    }
                    const messageObj = row.payload;
                    const id = row.id;
                    handleCallback({ type: 'callback', ...messageObj });
                    markProcessed(id);
                    supabase.removeChannel(realtimeChannel);
                    realtimeChannel = null;
                }
                )
                .subscribe((status) => {
                if (status === 'CHANNEL_ERROR') {
                    console.error('Error en canal Realtime');
                } else if (status === 'TIMED_OUT') {
                    console.error('Timeout en suscripción Realtime');
                }
                });
            }
            
        async function markProcessed(id) {
            try {
                const response = await fetch(`/api/mark_processed?id=${id}`, {
                    method: 'POST'
                });
                const json = await response.json();
            } catch (err) {
                console.error('Error marcando como procesado:', err);
            }
            }
            
        function handleCallback(data) {
            addMessage(data.message || 'Sin mensaje', 'assistant');
        }

        // Función para generar device_id único
        function generateDeviceId() {
            // Primero intentar obtener desde localStorage
            let deviceId = localStorage.getItem('lucy_device_id');
            if (deviceId) {
                return deviceId;
            }
            
            // Si no existe, intentar generar uno basado en características del navegador
            const fingerprint = [
                navigator.userAgent,
                navigator.language,
                screen.width + 'x' + screen.height,
                navigator.platform,
                Intl.DateTimeFormat().resolvedOptions().timeZone
            ].join('|');
            
            // Generar hash simple del fingerprint
            let hash = 0;
            for (let i = 0; i < fingerprint.length; i++) {
                const char = fingerprint.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convertir a 32-bit integer
            }
            
            // Convertir a string hexadecimal positivo
            deviceId = Math.abs(hash).toString(16) + Date.now().toString(16);
            
            localStorage.setItem('lucy_device_id', deviceId);
            return deviceId;
        }

        // Función para intentar recuperar conversaciones por IP cuando no hay device_id match
        async function tryRecoverConversationsByIP() {
            if (!supabase || !userIP) return [];
            
            try {
                console.log('Intentando recuperar conversaciones por IP:', userIP);
                
                const { data, error } = await supabase
                    .from('chat_sessions')
                    .select('*')
                    .eq('ip', userIP)
                    .order('updated_at', { ascending: false })
                    .limit(5); // Solo las 5 más recientes para no sobrecargar
                    
                if (error) {
                    console.error('Error al recuperar por IP:', error);
                    return [];
                }
                
                console.log('Conversaciones encontradas por IP:', data);
                return data || [];
            } catch (error) {
                console.error('Error en recuperación por IP:', error);
                return [];
            }
        }

        // Función para generar session_id único
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Función para obtener la IP del usuario
        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.error('Error al obtener IP:', error);
                return 'unknown';
            }
        }

        // Función para obtener información del navegador
        function getBrowserInfo() {
            return {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                screenResolution: `${screen.width}x${screen.height}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                timestamp: new Date().toISOString()
            };
        }

        // Función para inicializar la aplicación
        async function initializeApp() {
            deviceId = generateDeviceId();
            userIP = await getUserIP();
            
            // Esperar un poco para asegurar que Supabase esté listo
            setTimeout(async () => {
                await loadPreviousConversations();
            }, 500);
        }

        // Función para cargar conversaciones previas
        async function loadPreviousConversations() {
            if (!supabase) {
                console.log('Supabase no está inicializado aún');
                return;
            }
            
            try {
                
                // Primero intentar por device_id
                const { data, error } = await supabase
                    .from('chat_sessions')
                    .select('*')
                    .eq('device_id', deviceId)
                    .neq('hide', true)
                    .order('updated_at', { ascending: false });
        
                if (error) {
                    console.error('Error al cargar conversaciones:', error);
                    return;
                }
                
                // Si no hay conversaciones por device_id, intentar recuperar por IP
                let conversationsToShow = data;
                if (!data || data.length === 0) {
                    conversationsToShow = await tryRecoverConversationsByIP();
                }
                
                displayConversations(conversationsToShow);
            } catch (error) {
                console.error('Error al cargar conversaciones:', error);
            }
        }

        // Función para mostrar conversaciones en el sidebar
        function displayConversations(conversations) {
            const container = document.getElementById('conversationsContainer');
            container.innerHTML = '';
        
            if (!conversations || conversations.length === 0) {
                container.innerHTML = '<div class="no-conversations">No hay conversaciones previas</div>';
                return;
            }
        
            // Añadir botón "Conversaciones" solo cuando sidebar está expandido
            const sidebar = document.getElementById('sidebar');
            if (!sidebar.classList.contains('collapsed')) {
                const showConversationsContainer = document.createElement('div');
                showConversationsContainer.className = 'conversations-toggle-container';
                showConversationsContainer.innerHTML = `
                    <button class="new-chat-button tooltip" onclick="toggleAllConversations(this)" data-tooltip="Ocultar conversaciones">
                        <span>
                            <img src="https://cdn-icons-png.flaticon.com/512/1178/1178067.png" alt="Conversations" style="width: 21.6px; height: 21.6px; filter: opacity(0.7);">
                        </span>
                        <span>Conversaciones</span>
                    </button>
                `;
                container.appendChild(showConversationsContainer);
            }
        
            // Agrupar conversaciones por fecha
            const grouped = groupConversationsByDate(conversations);
        
            for (const [dateLabel, convs] of Object.entries(grouped)) {
                const section = document.createElement('div');
                section.className = 'conversation-section';
                
                const title = document.createElement('div');
                title.className = 'conversation-section-title';
                title.innerHTML = `<span>${dateLabel}</span>`;
                section.appendChild(title);
        
                const conversationsDiv = document.createElement('div');
                conversationsDiv.className = 'conversations-list';
        
                convs.forEach(conv => {
                    const item = document.createElement('div');
                    item.className = 'conversation-item';
                    item.textContent = getConversationTitle(conv);
                    item.onclick = () => loadConversation(conv);
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-conversation';
                    deleteBtn.innerHTML = '×';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        hideConversation(conv.session_id);
                    };
                    
                    item.appendChild(deleteBtn);
                    conversationsDiv.appendChild(item);
                });
        
                section.appendChild(conversationsDiv);
                container.appendChild(section);
            }
        }

        // Función para agrupar conversaciones por fecha
        function groupConversationsByDate(conversations) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
            const oneWeekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

            const grouped = {
                'Hoy': [],
                'Ayer': [],
                'La semana pasada': [],
                'Anteriores': []
            };

            conversations.forEach(conv => {
                const convDate = new Date(conv.updated_at);
                const convDateOnly = new Date(convDate.getFullYear(), convDate.getMonth(), convDate.getDate());

                if (convDateOnly.getTime() === today.getTime()) {
                    grouped['Hoy'].push(conv);
                } else if (convDateOnly.getTime() === yesterday.getTime()) {
                    grouped['Ayer'].push(conv);
                } else if (convDateOnly >= oneWeekAgo) {
                    grouped['La semana pasada'].push(conv);
                } else {
                    grouped['Anteriores'].push(conv);
                }
            });

            // Eliminar grupos vacíos
            Object.keys(grouped).forEach(key => {
                if (grouped[key].length === 0) {
                    delete grouped[key];
                }
            });

            return grouped;
        }

        // Función para obtener el título de una conversación
        function getConversationTitle(conversation) {
            // Usar conversation_title si está disponible
            if (conversation.conversation_title) {
                return conversation.conversation_title;
            }
            
            // Fallback al comportamiento anterior
            if (conversation.conversations && conversation.conversations.length > 0) {
                const firstUserMessage = conversation.conversations.find(msg => msg.sender === 'user');
                if (firstUserMessage) {
                    return firstUserMessage.text.substring(0, 30) + (firstUserMessage.text.length > 30 ? '...' : '');
                }
            }
            return 'Nueva conversación';
        }

        // Función para cargar una conversación específica
        function loadConversation(conversation) {
            currentSessionId = conversation.session_id;
            currentConversation = conversation.conversations || [];
            currentTopic = conversation.topic || null;
        
            // Cambiar a vista de chat
            showChatScreen();
        
            // Cargar mensajes
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';
        
            currentConversation.forEach(msg => {
                if (msg.properties && Array.isArray(msg.properties)) {
                    // Si el mensaje tiene propiedades, mostrarlas SIN GUARDAR (del historial)
                    addPropertiesMessageFromHistory(msg.properties);
                } else {
                    addMessage(msg.text, msg.sender, false);
                }
            });
            
            // Marcar conversación como activa
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Encontrar el elemento clickeado y marcarlo como activo
            const clickedItem = event.target.closest('.conversation-item');
            if (clickedItem) {
                clickedItem.classList.add('active');
            }
        }

        // Función para mostrar la pantalla de chat
        function showChatScreen() {
            const welcomeScreen = document.getElementById('welcomeScreen');
            const chatScreen = document.getElementById('chatScreen');

            welcomeScreen.style.display = 'none';
            chatScreen.style.display = 'flex';
            setTimeout(() => {
                chatScreen.classList.add('fade-in');
            }, 50);
        }

        // Función para guardar conversación en Supabase
        async function saveConversationToSupabase() {
            if (!supabase) {
                console.log('Supabase no está disponible para guardar');
                return;
            }
            
            try {
                const conversationData = {
                    device_id: deviceId,
                    session_id: currentSessionId,
                    ip: userIP,
                    topic: currentTopic,
                    conversation_title: currentConversationTitle,
                    conversations: currentConversation,
                    browser_info: getBrowserInfo(),
                    updated_at: new Date().toISOString()
                };

                const { data, error } = await supabase
                    .from('chat_sessions')
                    .upsert(conversationData, { 
                        onConflict: 'session_id' 
                    });

                if (error) {
                    console.error('Error al guardar conversación:', error);
            } 
            } catch (error) {
                console.error('Error al guardar conversación:', error);
            }
        }

        
        function selectOption(optionText) {
            // Crear nueva sesión
            currentSessionId = generateSessionId();
            currentConversation = [];
            currentTopic = optionText;

            // Fade out de la pantalla de bienvenida
            const welcomeScreen = document.getElementById('welcomeScreen');
            welcomeScreen.classList.add('fade-out');
            
            setTimeout(() => {
                showChatScreen();
                
                // Añadir mensaje del asistente primero
                addMessage('Hola, soy Luci. ¿Con qué te puedo ayudar?', 'assistant');
                
                // Añadir mensaje del usuario
                addMessage(optionText, 'user');
                
                // Enviar webhook
                sendWebhook(optionText);
            }, 300);
        }

        function addMessage(text, sender, save = true) {
            const messagesContainer = document.getElementById('chatMessages');
            
            // Marcar todos los mensajes existentes como antiguos
            const existingMessages = messagesContainer.querySelectorAll('.message:not(.loading-message)');
            existingMessages.forEach(msg => {
                if (!msg.classList.contains('old')) {
                    msg.classList.add('old');
                }
            });
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.textContent = text;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
            if (save) {
                currentConversation.push({
                    text: text,
                    sender: sender,
                    timestamp: new Date().toISOString()
                });
        
                saveConversationToSupabase();
        
                if (sender === 'user') {
                    setTimeout(() => loadPreviousConversations(), 1000);
                }
            }
        }

        function showLoading() {
            const messagesContainer = document.getElementById('chatMessages');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading-message';
            loadingDiv.id = 'loadingMessage';
            loadingDiv.innerHTML = '<div class="loader"></div>';
            messagesContainer.appendChild(loadingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideLoading() {
            const loadingMessage = document.getElementById('loadingMessage');
            if (loadingMessage) {
                loadingMessage.remove();
            }
        }

        function showSearchLoading() {
            const messagesContainer = document.getElementById('chatMessages');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading-message search-loading-messages';
            loadingDiv.id = 'searchLoadingMessage';
            loadingDiv.innerHTML = '<div class="loader"></div><span id="searchMessageText" style="color: #666;">Buscando Propiedades</span>';
            messagesContainer.appendChild(loadingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Iniciar rotación de mensajes
            currentSearchMessageIndex = 0;
            searchMessageInterval = setInterval(() => {
                currentSearchMessageIndex = (currentSearchMessageIndex + 1) % searchMessages.length;
                const messageText = document.getElementById('searchMessageText');
                if (messageText) {
                    messageText.textContent = searchMessages[currentSearchMessageIndex];
                }
            }, 4000);
            
            // Iniciar timeout de 4 minutos
            callbackTimeout = setTimeout(() => {
                showTimeoutPopup();
            }, 240000); // 4 minutos
        }
        
        function hideSearchLoading() {
            const searchLoadingMessage = document.getElementById('searchLoadingMessage');
            if (searchLoadingMessage) {
                searchLoadingMessage.remove();
            }
            
            if (searchMessageInterval) {
                clearInterval(searchMessageInterval);
                searchMessageInterval = null;
            }
            
            if (callbackTimeout) {
                clearTimeout(callbackTimeout);
                callbackTimeout = null;
            }
        }

        function formatConversationAsText() {
            let conversationText = "Historial de conversación:\n\n";
            
            currentConversation.forEach((msg, index) => {
                const role = msg.sender === 'user' ? 'Usuario' : 'Luci';
                conversationText += `${role}: ${msg.text}\n\n`;
            });
            
            return conversationText;
        }
        
        function sendWebhook(message) {
            isWaitingForResponse = true;
            updateSendButton();
            showLoading();
            
            const conversationText = formatConversationAsText();
            const webhookData = {
                method: 'POST',
                url: 'https://luci-aura.app.n8n.cloud/webhook/c3b65321-b14c-47b5-80e2-0d6646bf00cd/chat', 
                data: {
                    conversation_text: conversationText,
                    current_message: message,
                    session_id: currentSessionId,
                    device_id: deviceId,
                    topic: currentTopic,
                    timestamp: new Date().toISOString(),
                    user_ip: userIP,
                    conversation_stats: {
                        total_messages: currentConversation.length,
                        user_messages: currentConversation.filter(m => m.sender === 'user').length,
                        assistant_messages: currentConversation.filter(m => m.sender === 'assistant').length
                    }
                }
            };


            fetch(webhookData.url, {
                method: webhookData.method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(webhookData.data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                return response.json();
            })
            .then(data => {
                hideLoading();
                
                // Actualizar topic si viene en la respuesta
                if (data.topic && data.topic !== currentTopic) {
                    currentTopic = data.topic;
                }

                // Actualizar título de conversación si viene en la respuesta
                if (data.conversation_title) {
                    currentConversationTitle = data.conversation_title;
                }

                 // Verificar si se espera un callback
                if (data.started_search === "yes") {
                    pendingCallback = true;
                    startRealtimeSubscription(currentSessionId);
                    showSearchLoading();
                } else {
                    pendingCallback = false;
                }
                
                // Añadir respuesta del asistente
                addMessage(data.message || data.response || 'Respuesta recibida del servidor', 'assistant');
                isWaitingForResponse = false;
                updateSendButton();
            })
            .catch(error => {
                hideLoading();
                addErrorMessage('Error de conexión, inténtalo de nuevo más tarde');
                isWaitingForResponse = false;
                updateSendButton();
                console.error('Error:', error);
            });
        }

        function addErrorMessage(text) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message error';
            messageDiv.textContent = text;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Función para manejar callbacks desde n8n
        function handleCallback(data) {
            // Verificar que el callback es para la sesión actual
            if (!data.session_id || data.session_id !== currentSessionId) {
                return { success: false, message: 'Session ID mismatch or missing' };
            }
            
            if (!currentSessionId || !pendingCallback) {
                return { success: false, message: 'No active session or callback not expected' };
            }
            
            // Actualizar topic si viene en la respuesta
            if (data.topic && data.topic !== currentTopic) {
                currentTopic = data.topic;
            }
            
            // Si hay propiedades, mostrar las tarjetas
            if (data.properties && Array.isArray(data.properties)) {
                addPropertiesMessage(data.properties);
            }
            
            // Añadir mensaje del asistente después de las propiedades
            if (data.message) {
                addMessage(data.message, 'assistant');
            }
            
            // Resetear estado de callback pendiente
            pendingCallback = false;
            hideSearchLoading(); 
            
            return { success: true, message: 'Callback procesado correctamente' };
        }
        
        // Exponer función globalmente para el endpoint
        window.handleCallback = handleCallback;

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message && !isWaitingForResponse) {
                // Si no hay sesión actual, crear una nueva
                if (!currentSessionId) {
                    currentSessionId = generateSessionId();
                    currentConversation = [];
                    
                    // Si estamos en pantalla de bienvenida, cambiar a chat
                    if (document.getElementById('welcomeScreen').style.display !== 'none') {
                        showChatScreen();
                        addMessage('Hola, soy Luci. ¿Con qué te puedo ayudar?', 'assistant');
                    }
                }

                addMessage(message, 'user');
                input.value = '';
                input.style.height = 'auto';
                sendWebhook(message);
            }
        }

        function updateSendButton() {
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = isWaitingForResponse;
        }

        function newChat() {
            currentSessionId = null;
            currentConversation = [];
            currentTopic = null;
            pendingCallback = false;
            
            // Mostrar pantalla de bienvenida
            const welcomeScreen = document.getElementById('welcomeScreen');
            const chatScreen = document.getElementById('chatScreen');
            
            chatScreen.style.display = 'none';
            chatScreen.classList.remove('fade-in');
            welcomeScreen.style.display = 'flex';
            welcomeScreen.classList.remove('fade-out');

            // Limpiar mensajes
            document.getElementById('chatMessages').innerHTML = '';

            // Remover clase activa de conversaciones
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
        }

        // Event listeners
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Auto-resize textarea
        document.getElementById('chatInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Endpoint para recibir callbacks de n8n
        if (typeof window !== 'undefined') {
            // Crear endpoint simulado usando postMessage para desarrollo local
            window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'n8n_callback') {
                    handleCallback(event.data.payload);
                }
            });
            
            // Endpoint real para producción (esto requerirá configuración adicional en Vercel)
            window.callbackEndpoint = function(data) {
                return handleCallback(data);
            };
        }
        
        // Para desarrollo: función de prueba del callback
        window.testCallback = function(message) {
            const testData = {
                message: message || 'Mensaje de prueba del callback',
                topic: currentTopic
            };
            return handleCallback(testData);
        };
        
        function addPropertiesMessage(properties) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            
            const propertiesContainer = document.createElement('div');
            propertiesContainer.className = 'properties-container';
            
            properties.forEach((property, index) => {
                const thumbnail = document.createElement('div');
                thumbnail.className = 'property-thumbnail';
                thumbnail.onclick = () => openPropertyModal(property, index);
                
                const img = document.createElement('img');
                img.src = property.thumbnail;
                img.alt = property.title;
                // CORREGIDO: Eliminar el onclick de aquí porque interfiere con el modal
                
                thumbnail.appendChild(img);
                propertiesContainer.appendChild(thumbnail);
            });
            
            messageDiv.appendChild(propertiesContainer);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Guardar en conversación
            currentConversation.push({
                text: '[Propiedades mostradas]',
                sender: 'assistant',
                timestamp: new Date().toISOString(),
                properties: properties
            });
            
            saveConversationToSupabase();
        }
        
       // Mostrar propiedades del historial sin duplicar
        function addPropertiesMessageFromHistory(properties) {
            const messagesContainer = document.getElementById('chatMessages');
            
            // Marcar todos los mensajes existentes como antiguos
            const existingMessages = messagesContainer.querySelectorAll('.message:not(.loading-message)');
            existingMessages.forEach(msg => {
                if (!msg.classList.contains('old')) {
                    msg.classList.add('old');
                }
            });
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            
            const propertiesContainer = document.createElement('div');
            propertiesContainer.className = 'properties-container';
            
            properties.forEach((property, index) => {
                const uniqueIndex = Date.now() + index; // Índice único para evitar conflictos
                const thumbnail = document.createElement('div');
                thumbnail.className = 'property-thumbnail';
                thumbnail.onclick = () => openPropertyModal(property, uniqueIndex);
                
                const img = document.createElement('img');
                img.src = property.thumbnail;
                img.alt = property.title;
                
                thumbnail.appendChild(img);
                propertiesContainer.appendChild(thumbnail);
            });
            
            messageDiv.appendChild(propertiesContainer);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // NO guardar en conversación porque ya está guardado
        }
        
        function openPropertyModal(property, index) {
            const modal = document.createElement('div');
            modal.className = 'property-modal';
            modal.id = 'propertyModal';
            
            modal.innerHTML = `
                <div class="property-card">
                    <button class="property-close" onclick="closePropertyModal()">×</button>
                    <div class="property-title">${property.title}</div>
                    <div class="property-price">${formatPrice(property.price)}</div>
                    
                    <div class="property-images">
                        <div class="property-carousel" id="carousel-${index}">
                            ${property.images.map((img, imgIndex) => 
                                `<img src="${img}" alt="${property.title}" ${imgIndex === 0 ? 'class="active"' : ''} onclick="openImageZoom('${img}')" style="cursor: zoom-in;">`
                            ).join('')}
                            ${property.images.length > 1 ? `
                                <button class="carousel-nav carousel-prev" onclick="changeImage(${index}, -1)">‹</button>
                                <button class="carousel-nav carousel-next" onclick="changeImage(${index}, 1)">›</button>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="property-details">
                        <div class="property-specs">
                            <div class="property-spec">🛏️ ${property.rooms} habitaciones</div>
                            <div class="property-spec">🚿 ${property.bathrooms} baños</div>
                            <div class="property-spec">📏 ${property.size} m²</div>
                            <div class="property-spec">🏢 Planta ${property.floor}</div>
                        </div>
                    </div>
                    
                    <button class="property-info-button" onclick="requestMoreInfo(\`${property.title}\`)">
                        Más información
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'flex';
            
            // Store current image index
            window.currentImageIndex = window.currentImageIndex || {};
            window.currentImageIndex[index] = 0;
        
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closePropertyModal();
                }
            });
        }
        
        function closePropertyModal() {
            const modal = document.getElementById('propertyModal');
            if (modal) {
                modal.remove();
            }

            // Cerrar modal con tecla Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closePropertyModal();
                }
            });
        }
        
        function changeImage(propertyIndex, direction) {
            const carousel = document.getElementById(`carousel-${propertyIndex}`);
            const images = carousel.querySelectorAll('img');
            
            if (!window.currentImageIndex) window.currentImageIndex = {};
            
            images[window.currentImageIndex[propertyIndex]].classList.remove('active');
            
            window.currentImageIndex[propertyIndex] += direction;
            
            if (window.currentImageIndex[propertyIndex] >= images.length) {
                window.currentImageIndex[propertyIndex] = 0;
            } else if (window.currentImageIndex[propertyIndex] < 0) {
                window.currentImageIndex[propertyIndex] = images.length - 1;
            }
            
            images[window.currentImageIndex[propertyIndex]].classList.add('active');
        }
        
        function formatPrice(price) {
            return new Intl.NumberFormat('es-ES', {
                style: 'currency',
                currency: 'EUR',
                maximumFractionDigits: 0
            }).format(price);
        }
        
        function requestMoreInfo(propertyTitle) {
            closePropertyModal();
            showContactInfoPopup(propertyTitle);
        }

        // Función para activar el modo test y simular estado de callback pendiente
        window.activateTestMode = function(sessionId) {
            if (!sessionId) {
                console.error('Se necesita un session_id para activar el modo test');
                return false;
            }
            
            // Activar estado de test
            currentSessionId = sessionId;
            pendingCallback = true;
            
            // Si no hay conversación activa, crear una mínima
            if (!currentConversation || currentConversation.length === 0) {
                currentConversation = [
                    {
                        text: 'Hola, soy Luci. ¿Con qué te puedo ayudar?',
                        sender: 'assistant',
                        timestamp: new Date().toISOString()
                    },
                    {
                        text: 'Buscar propiedades para comprar',
                        sender: 'user',
                        timestamp: new Date().toISOString()
                    }
                ];
                
                // Mostrar chat screen si no está visible
                if (document.getElementById('welcomeScreen').style.display !== 'none') {
                    showChatScreen();
                    // Mostrar los mensajes
                    const messagesContainer = document.getElementById('chatMessages');
                    messagesContainer.innerHTML = '';
                    currentConversation.forEach(msg => {
                        addMessage(msg.text, msg.sender, false);
                    });
                }
            }

            console.log(`Modo test activado para sesión: ${sessionId}`);
            console.log(`Callback pendiente: ${pendingCallback}`);
            return true;
        };
        
        // Función para desactivar el modo test
        window.deactivateTestMode = function() {
            pendingCallback = false;
            console.log('Modo test desactivado');
        };
        
        // Función combinada para test completo
        window.fullTestCallback = function(sessionId, testData) {
            console.log('=== INICIANDO TEST COMPLETO ===');
            
            // Activar modo test
            if (!window.activateTestMode(sessionId)) {
                return { success: false, message: 'No se pudo activar el modo test' };
            }
            
            // Simular datos de test si no se proporcionan
            const defaultTestData = {
                session_id: sessionId,
                message: "¡Claro Pablo! Aquí tienes tus propiedades!",
                properties: [
                    {
                        title: "Piso en calle Goya",
                        thumbnail: "https://img4.idealista.com/blur/WEB_DETAIL_TOP-XL-P/0/id.pro.es.image.master/e9/3a/4c/1340892243.webp",
                        price: 310000,
                        floor: "6",
                        size: 79,
                        rooms: 2,
                        bathrooms: 1,
                        images: [
                            "https://img4.idealista.com/blur/WEB_DETAIL_TOP-XL-P/0/id.pro.es.image.master/e9/3a/4c/1340892243.webp",
                            "https://img4.idealista.com/blur/WEB_DETAIL-XL-P/0/id.pro.es.image.master/c1/2d/8c/1340892242.webp"
                        ]
                    },
                    {
                        title: "Ático en Salamanca",
                        thumbnail: "https://img4.idealista.com/blur/WEB_DETAIL_TOP-XL-P/0/id.pro.es.image.master/12/34/56/1340892244.webp",
                        price: 450000,
                        floor: "7",
                        size: 95,
                        rooms: 3,
                        bathrooms: 2,
                        images: [
                            "https://img4.idealista.com/blur/WEB_DETAIL_TOP-XL-P/0/id.pro.es.image.master/12/34/56/1340892244.webp"
                        ]
                    }
                ]
            };
            
            const dataToUse = testData || defaultTestData;
            
            // Ejecutar callback
            const result = handleCallback(dataToUse);
            
            console.log('=== RESULTADO DEL TEST ===');
            console.log('Resultado:', result);
            console.log('Estado pendingCallback después del test:', pendingCallback);
            
            return result;
        };


       function toggleAllConversations(button) {
            const allConversationsLists = document.querySelectorAll('.conversations-list');
            const isAnyVisible = Array.from(allConversationsLists).some(list => list.style.display !== 'none');
            
            allConversationsLists.forEach(list => {
                if (isAnyVisible) {
                    list.style.display = 'none';
                } else {
                    list.style.display = 'block';
                }
            });
            
            // Cambiar el tooltip
            if (isAnyVisible) {
                button.setAttribute('data-tooltip', 'Mostrar conversaciones');
            } else {
                button.setAttribute('data-tooltip', 'Ocultar conversaciones');
            }
        }
        
        // Funciones para sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('toggleSidebar');
            
            sidebar.classList.toggle('collapsed');
            
            if (sidebar.classList.contains('collapsed')) {
                toggleBtn.setAttribute('data-tooltip', 'Expandir barra principal');
            } else {
                toggleBtn.setAttribute('data-tooltip', 'Recoger barra principal');
            }
            
            // Recargar conversaciones para mostrar/ocultar el botón correctamente
            loadPreviousConversations();
        }
        
        function expandSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('toggleSidebar');
            
            sidebar.classList.remove('collapsed');
            toggleBtn.setAttribute('data-tooltip', 'Recoger barra principal');
            loadPreviousConversations();
        }
        
        // Función para ocultar conversaciones
        async function hideConversation(sessionId) {
            if (!supabase) return;
            
            try {
                const { error } = await supabase
                    .from('chat_sessions')
                    .update({ hide: true })
                    .eq('session_id', sessionId);
        
                if (error) {
                    console.error('Error al ocultar conversación:', error);
                    return;
                }
                
                // Recargar conversaciones
                await loadPreviousConversations();
            } catch (error) {
                console.error('Error al ocultar conversación:', error);
            }
        }
        
        // Función para mostrar popup de timeout
        function showTimeoutPopup() {
            const popup = document.createElement('div');
            popup.className = 'popup-overlay';
            popup.id = 'timeoutPopup';
            
            popup.innerHTML = `
                <div class="popup-content">
                    <div class="popup-title">¡Continuamos con tu búsqueda exhaustiva, pero nos va a llevar algún minuto más!</div>
                    <p>Si lo prefieres, te podemos mandar los resultados por correo electrónico.</p>
                    
                    <div class="input-with-send">
                        <input type="email" class="popup-input" id="timeoutEmail" placeholder="tu@email.com">
                        <button class="send-icon-btn" onclick="sendEmailNotification()">➤</button>
                    </div>
                    
                    <div class="popup-buttons">
                        <button class="popup-btn secondary" onclick="continueWaiting()">Continuar esperando</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(popup);
            popup.style.display = 'flex';
        }
        
        function continueWaiting() {
            const popup = document.getElementById('timeoutPopup');
            if (popup) popup.remove();
            
            // Renovar timeout por otros 4 minutos
            callbackTimeout = setTimeout(() => {
                showTimeoutPopup();
            }, 240000);
            
            // Renovar suscripción realtime
            if (currentSessionId) {
                startRealtimeSubscription(currentSessionId);
            }
        }
        
        function sendEmailNotification() {
            const email = document.getElementById('timeoutEmail').value;
            if (!email) {
                alert('Por favor, introduce un email válido');
                return;
            }
            
            // Aquí puedes enviar el email al webhook
            console.log('Enviando notificación a:', email);
            
            const popup = document.getElementById('timeoutPopup');
            if (popup) popup.remove();
            
            addMessage('Te enviaremos los resultados por email cuando estén listos.', 'assistant');
        }
        
        // Función para mostrar popup de información de contacto
        function showContactInfoPopup(propertyTitle) {
            const popup = document.createElement('div');
            popup.className = 'popup-overlay';
            popup.id = 'contactInfoPopup';
            
            popup.innerHTML = `
                <div class="popup-content">
                    <div class="popup-title">¡Gracias por tu interés en esta propiedad!</div>
                    <p>Te enviaremos los datos completos al método de envío que selecciones a continuación</p>
                    
                    <input type="text" class="popup-input" id="userName" placeholder="Tu nombre">
                    
                    <p style="margin: 20px 0 10px 0;">Elige entre estos dos métodos de envío:</p>
                    
                    <div class="contact-method-buttons">
                        <button class="contact-method-btn" id="whatsappBtn" onclick="selectContactMethod('whatsapp')">WhatsApp</button>
                        <button class="contact-method-btn" id="emailBtn" onclick="selectContactMethod('email')">Email</button>
                    </div>
                    
                    <div id="contactInput" style="display: none;">
                        <div class="input-with-send">
                            <input type="text" class="popup-input" id="contactValue" placeholder="">
                            <button class="send-icon-btn" onclick="sendContactInfo('${propertyTitle}')">➤</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(popup);
            popup.style.display = 'flex';
            
            // Cerrar con click fuera
            popup.addEventListener('click', function(e) {
                if (e.target === popup) {
                    popup.remove();
                }
            });
        }
        
        function selectContactMethod(method) {
            const whatsappBtn = document.getElementById('whatsappBtn');
            const emailBtn = document.getElementById('emailBtn');
            const contactInput = document.getElementById('contactInput');
            const contactValue = document.getElementById('contactValue');
            
            // Resetear selección
            whatsappBtn.classList.remove('selected');
            emailBtn.classList.remove('selected');
            
            // Seleccionar método
            if (method === 'whatsapp') {
                whatsappBtn.classList.add('selected');
                contactValue.placeholder = 'Tu número de WhatsApp';
                contactValue.type = 'tel';
            } else {
                emailBtn.classList.add('selected');
                contactValue.placeholder = 'Tu email';
                contactValue.type = 'email';
            }
            
            contactInput.style.display = 'block';
        }
        
        function sendContactInfo(propertyTitle) {
            const name = document.getElementById('userName').value;
            const contactValue = document.getElementById('contactValue').value;
            const method = document.getElementById('whatsappBtn').classList.contains('selected') ? 'WhatsApp' : 'Email';
            
            if (!name || !contactValue) {
                alert('Por favor, completa todos los campos');
                return;
            }
            
            // Enviar información al webhook
            console.log('Enviando info de contacto:', { name, contactValue, method, propertyTitle });
            
            const popup = document.getElementById('contactInfoPopup');
            if (popup) popup.remove();
            
            addMessage(`Te enviaremos información de "${propertyTitle}" por ${method}.`, 'assistant');
        }

        function openImageZoom(imageSrc) {
            const modal = document.createElement('div');
            modal.className = 'image-zoom-modal';
            modal.innerHTML = `
                <span class="zoom-close">&times;</span>
                <img src="${imageSrc}" alt="Imagen ampliada">
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'flex';
            
            // Cerrar con click
            modal.addEventListener('click', function() {
                modal.remove();
            });
            
            // Cerrar con Escape
            const escapeHandler = function(e) {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
        }
            
    </script>
</body>
</html>
