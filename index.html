<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luci - Asistente Inmobiliario</title>
    <link href="https://fonts.googleapis.com/css2?family=Graphik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
   <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Graphik', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* =================== SIDEBAR BASE STYLES =================== */
        .sidebar {
            width: 250px;
            background-color: #edf2f4;
            padding: 20px;
            border-right: 1px solid #ddd;
            transition: width 0.3s ease;
            position: relative;
        }

        .sidebar.collapsed {
            width: 60px;
            padding: 10px 0;
        }

        .sidebar h3 {
            color: black;
            margin-bottom: 15px;
            font-size: 16px;
            font-family: 'Graphik', sans-serif;
            font-weight: bold;
        }

        /* =================== SIDEBAR HEADER =================== */
        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px 0;
            justify-content: flex-start;
            width: 100%;
        }

        .sidebar.collapsed .sidebar-header {
            justify-content: center;
            gap: 0;
            padding: 10px;
        }

        /* =================== TOGGLE BUTTON =================== */
        .toggle-sidebar-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background-color 0.2s;
            color: #666;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 10;
        }

        .toggle-sidebar-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .sidebar.collapsed .toggle-sidebar-btn {
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 8px;
        }

        .sidebar.collapsed .toggle-sidebar-btn:hover {
            background-color: rgba(255, 255, 255, 0.4);
            transform: scale(1.05);
        }

        /* =================== BRAND NAME =================== */
        .brand-name {
            font-family: 'Montserrat', sans-serif;
            font-weight: bold;
            font-size: 32px;
            color: black;
            white-space: nowrap;
        }

        .sidebar.collapsed .brand-name {
            display: none;
        }

        /* =================== NEW CHAT BUTTON =================== */
        .new-chat-button {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            margin-bottom: 20px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            color: black;
            font-size: 14px;
            font-family: 'Graphik', sans-serif;
            cursor: pointer;
            transition: background-color 0.2s;
            border: none;
            width: 100%;
            justify-content: flex-start;
            position: relative;
        }

        .new-chat-button:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }

        .sidebar.collapsed .new-chat-button {
            justify-content: center;
            align-items: center;
            padding: 8px;
            width: 40px;
            height: 40px;
            margin: 10px auto 20px auto;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            gap: 0;
        }

        .sidebar.collapsed .new-chat-button:hover {
            background-color: rgba(255, 255, 255, 0.4);
            transform: scale(1.05);
        }

        .sidebar.collapsed .new-chat-button span:last-child {
            display: none;
        }

        .sidebar.collapsed .new-chat-button span:first-child {
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .sidebar:not(.collapsed) .new-chat-button {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 10px;
            padding: 12px;
            padding-left: 8px;
            margin-bottom: 20px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            color: black;
            font-size: 14px;
            font-family: 'Graphik', sans-serif;
            cursor: pointer;
            transition: background-color 0.2s;
            border: none;
            width: 100%;
        }

        .sidebar:not(.collapsed) .new-chat-button:hover {
            background-color: rgba(0, 123, 255, 0.1);
            border-color: #007bff;
        }

        /* =================== SHOW CHATS BUTTON =================== */
        .show-chats-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
            color: #666;
            width: 40px;
            height: 40px;
            display: none;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.3);
            z-index: 10;
        }

        .show-chats-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .sidebar.collapsed .show-chats-btn {
            display: flex;
        }

        .sidebar.collapsed .show-chats-btn:hover {
            background-color: rgba(255, 255, 255, 0.4);
            transform: translateX(-50%) scale(1.05);
        }

        .sidebar:not(.collapsed) .show-chats-btn {
            display: none !important;
        }

        /* =================== CONVERSATIONS CONTAINER =================== */
        #conversationsContainer {
            margin-top: 0;
        }

        .sidebar.collapsed #conversationsContainer {
            margin-top: 40px;
        }

        /* =================== CONVERSATION SECTIONS =================== */
        .conversation-section {
            margin-bottom: 20px;
        }

        .conversation-section-title {
            font-size: 12px;
            color: #666;
            font-family: 'Graphik', sans-serif;
            font-weight: bold;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar.collapsed .conversation-section-title {
            display: none;
        }

        .conversation-item {
            padding: 10px;
            margin-bottom: 8px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: black;
            font-size: 14px;
            font-family: 'Graphik', sans-serif;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }

        .conversation-item:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .conversation-item.active {
            background-color: rgba(255, 255, 255, 0.5);
            border-left: 3px solid #007bff;
        }

        .sidebar.collapsed .conversation-item {
            display: none;
        }

        /* =================== DELETE CONVERSATION BUTTON =================== */
        .delete-conversation {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #999;
            font-size: 16px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .conversation-item:hover .delete-conversation {
            opacity: 1;
        }

        .delete-conversation:hover {
            background-color: rgba(255, 0, 0, 0.1);
            color: #ff4444;
        }

        /* =================== NO CONVERSATIONS =================== */
        .no-conversations {
            text-align: center;
            color: #666;
            font-size: 14px;
            font-style: italic;
            padding: 20px 0;
        }

        /* =================== CONVERSATIONS TOGGLE CONTAINER =================== */
        .conversations-toggle-container .new-chat-button {
            padding-left: 8px !important;
            justify-content: flex-start !important;
        }

        .conversations-toggle-container .new-chat-button span:last-child {
            animation: fadeInText 0.4s ease-in-out 0.1s;
            animation-fill-mode: both;
        }

        /* =================== TOOLTIPS =================== */
        .tooltip {
            position: relative;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 60px;
            top: 50%;
            transform: translateY(-50%);
            background-color: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .sidebar:not(.collapsed) .tooltip::after {
            top: calc(100% + 10px);
            left: 0;
            transform: none;
        }

        .tooltip:hover::after {
            opacity: 1;
        }

        .sidebar.collapsed .new-chat-button::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 50px;
            top: 50%;
            transform: translateY(-50%);
            background-color: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .sidebar.collapsed .new-chat-button:hover::after {
            opacity: 1;
            transition-delay: 0.1s;
        }

        /* =================== IMÁGENES Y ICONOS =================== */
        .toggle-sidebar-btn img,
        .new-chat-button img,
        .show-chats-btn img {
            transition: all 0.3s ease;
            filter: opacity(0.7);
        }

        .toggle-sidebar-btn:hover img,
        .new-chat-button:hover img,
        .show-chats-btn:hover img {
            filter: opacity(1);
            transform: scale(1.1);
        }

        .sidebar.collapsed .new-chat-button img {
            margin: 0;
            display: block;
        }

        .tooltip img {
            pointer-events: none;
        }

        /* =================== ANIMACIONES =================== */
        .sidebar:not(.collapsed) .conversation-section-title,
        .sidebar:not(.collapsed) .conversation-item {
            opacity: 1;
            transform: translateX(0);
        }
        .sidebar:not(.collapsed) .new-chat-button span:last-child,
       .sidebar:not(.collapsed) .brand-name {
            animation: fadeInText 0.4s ease-in-out;
            animation-fill-mode: both;
        }

        .sidebar:not(.collapsed) .new-chat-button span:last-child {
            animation-delay: 0.1s;
        }      

        .sidebar:not(.collapsed) .brand-name {
            animation-delay: 0.05s;
        }
       

        @keyframes fadeInText {
            0% {
                opacity: 0;
                transform: translateX(-10px);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* =================== OTROS ELEMENTOS DE SIDEBAR =================== */
        .show-conversations-btn {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }

        .show-conversations-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .conversations-list {
            transition: all 0.3s ease;
        }

        .show-conversations-btn {
            transition: transform 0.3s ease;
        }

        .sidebar:not(.collapsed) .new-chat-button,
        .sidebar:not(.collapsed) .conversations-toggle-container .new-chat-button {
            padding-left: 8px !important;
        }

        /* =================== ÁREA PRINCIPAL =================== */
        .main-area {
            flex: 1;
            background-color: white;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* =================== PANTALLA DE BIENVENIDA =================== */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 40px;
            opacity: 1;
            transition: opacity 0.3s ease-out;
        }

        .welcome-screen.fade-out {
            opacity: 0;
        }

        .welcome-title {
            font-family: 'Graphik', sans-serif;
            font-weight: bold;
            font-size: 32px;
            color: black;
            margin-bottom: 40px;
            text-align: center;
        }

        .buttons-container {
            background-color: #fbfcfd;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .option-button {
            flex: 1;
            min-width: 300px;
            padding: 15px 20px;
            background-color: white;
            color: #b8c1c8;
            border: 1px solid #ddd;
            border-radius: 12px;
            font-family: 'Graphik', sans-serif;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        /* Botón principal (comprar propiedades) - siempre destacado */
        .option-button.primary {
            background-color: #f8f9fa;
            border-color: #007bff;
            color: black;
            font-weight: normal;
        }
        
        /* Hover del botón principal */
        .option-button.primary:hover {
            transform: scale(1.05);
            font-weight: bold;
            border-color: #DAA520; /* Color mostaza */
            box-shadow: 0 2px 8px rgba(218, 165, 32, 0.3);
        }
        
        /* Botones secundarios - sin hover */
        .option-button:not(.primary):hover {
            /* Sin cambios en hover */
        }
        
        .option-button:last-child {
            margin-bottom: 0;
        }

       /* =================== SELECTOR DE IDIOMA =================== */
        .language-selector {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        
        .flag-btn {
            width: 32px;
            height: 24px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            opacity: 0.6;
            border: 2px solid transparent;
        }
        
        .flag-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        
        .flag-btn.active {
            opacity: 1;
            border: 2px solid #007bff;
        }

        /* =================== PANTALLA DE CHAT =================== */
        .chat-screen {
            display: none;
            flex-direction: column;
            height: 100%;
            opacity: 0;
            transition: opacity 0.3s ease-in;
        }

        .chat-screen.fade-in {
            opacity: 1;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: none;
        }

        .chat-title {
            font-family: 'Graphik', sans-serif;
            font-weight: bold;
            font-size: 24px;
            color: black;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .message {
            max-width: 70%;
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 18px;
            word-wrap: break-word;
            font-family: 'Graphik', sans-serif;
        }

        .message.assistant {
            background-color: white;
            border: 1px solid #ddd;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .message.user {
            background-color: #edf2f4;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.error {
            background-color: #fee;
            color: #c53030;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .message.old {
            color: #888;
        }

        .chat-input-container {
            padding: 30px;
            border-top: 1px solid #eee;
            width: 100%;
        }

        .chat-input-wrapper {
            display: flex;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 25px;
            padding: 5px;
            align-items: flex-end;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 100%;
        }

        .chat-input {
            flex: 1;
            border: none;
            outline: none;
            padding: 15px 20px;
            font-size: 16px;
            font-family: 'Graphik', sans-serif;
            border-radius: 20px;
            resize: none;
            max-height: 120px;
            min-height: 80px;
            width: 100%;
        }

        .send-button {
            background-color: #edf2f4;
            color: #333;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-right: 5px;
            margin-bottom: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }

        .send-button:hover {
            background-color: #d1d9db;
        }

        .send-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

       /* =================== DISCLAIMER =================== */
        .disclaimer {
            text-align: center;
            font-size: 12px;
            color: #888;
            margin-top: 10px;
            font-family: 'Graphik', sans-serif;
        }
        
        .beta-badge {
            background-color: rgba(147, 51, 234, 0.1);
            color: #9333ea;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        } 
               
       /* =================== PROPIEDADES =================== */
        .properties-container {
            display: flex;
            gap: 15px;
            margin: 10px 0;
            justify-content: flex-start;
        }
        
        .property-thumbnail {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .property-thumbnail::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.7);
            transition: opacity 0.3s ease;
            z-index: 1;
        }
        
        .property-thumbnail:hover::before {
            opacity: 0;
        }
        
        .property-thumbnail:hover {
            transform: scale(1.1);
        }
        
        .property-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: zoom-in;
        }
        
        /* =================== MODAL DE PROPIEDAD =================== */
        .property-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .property-card {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        .property-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 1001;
        }
        
        .property-close:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
        }
        
        .property-title {
            font-family: 'Graphik', sans-serif;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
            color: black;
        }
        
        .property-price {
            font-size: 16px;
            color: #007bff;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .property-images {
            position: relative;
            margin-bottom: 15px;
        }
        
        .property-carousel {
            width: 100%;
            height: 200px;
            overflow: hidden;
            border-radius: 8px;
            position: relative;
        }
        
        .property-carousel img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        
        .property-carousel img.active {
            display: block;
        }
        
        .carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
        }
        
        .carousel-prev {
            left: 10px;
        }
        
        .carousel-next {
            right: 10px;
        }
        
        .property-details {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .property-specs {
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-family: 'Graphik', sans-serif;
            font-size: 14px;
        }
        
        .property-spec {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .property-info-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Graphik', sans-serif;
            margin-top: 20px;
            width: 100%;
        }
        
        .property-info-button:hover {
            background-color: #0056b3;
        }

        /* =================== MODAL DE ZOOM PARA IMÁGENES =================== */
        .image-zoom-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            cursor: zoom-out;
        }
        
        .image-zoom-modal img {
            max-width: 95vw;
            max-height: 95vh;
            object-fit: contain;
            cursor: zoom-out;
        }
        
        .zoom-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            cursor: pointer;
            z-index: 2001;
        }

        /* =================== LOADER =================== */
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-message {
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 70%;
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 18px;
            background-color: white;
            border: 1px solid #ddd;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            font-family: 'Graphik', sans-serif;
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
        
        /* =================== POP-UPS =================== */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .popup-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        
        .popup-title {
            font-family: 'Graphik', sans-serif;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 20px;
            color: black;
        }
        
        .popup-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Graphik', sans-serif;
            margin: 10px 0;
            font-size: 16px;
        }
        
        .popup-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .popup-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-family: 'Graphik', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .popup-btn.primary {
            background-color: #007bff;
            color: white;
        }
        
        .popup-btn.secondary {
            background-color: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
        }
        
        .popup-btn:hover {
            transform: translateY(-1px);
        }
        
        .contact-method-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }
        
        .contact-method-btn {
            padding: 10px 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .contact-method-btn.selected {
            border-color: #007bff;
            background-color: #e3f2fd;
        }
        
        .input-with-send {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 15px;
        }
        
        .input-with-send input {
            flex: 1;
        }
        
        .send-icon-btn {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

       /* Transición suave para el texto de búsqueda */
        #searchMessageText {
            transition: opacity 0.5s ease-in-out;
        }
        
        .fade-out-text {
            opacity: 0;
        }

        /* Atenuar emojis en mensajes antiguos */
        .message.old {
            color: #888;
            filter: grayscale(0.7) opacity(0.8);
        }
        
        /* Contorno mostaza para propiedades */
        .message.assistant .properties-container {
            border: 2px solid #DAA520;
            border-radius: 12px;
            padding: 10px;
            background-color: rgba(218, 165, 32, 0.05);
        }
        
        /* Popup de funcionalidad no disponible */
        .not-available-popup {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .not-available-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        
        .not-available-title {
            font-family: 'Graphik', sans-serif;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 15px;
            color: black;
        }
        
        .not-available-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-family: 'Graphik', sans-serif;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            margin-top: 15px;
        }
       
        /* =================== RESPONSIVE =================== */
        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }
            
            .welcome-title {
                font-size: 24px;
            }
            
            .buttons-container {
                padding: 20px;
                flex-direction: column;
            }
            
            .option-button {
                min-width: auto;
            }
            
            .message {
                max-width: 85%;
            }
        }
    </style>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <!-- Menú lateral -->
        <div class="sidebar collapsed" id="sidebar">
            <div class="sidebar-header">
                <button class="toggle-sidebar-btn tooltip" id="toggleSidebar" data-tooltip="Expandir barra principal">
                    <img src="https://cdn-icons-png.flaticon.com/512/10023/10023169.png" alt="Expand" style="width: 21.6px; height: 21.6px; filter: opacity(0.7);">
                </button>
                <span class="brand-name">AURA</span>
            </div>
            
            <button class="new-chat-button tooltip" onclick="newChat()" data-tooltip="Nuevo Chat">
                <span>
                    <img src="https://cdn-icons-png.flaticon.com/512/8922/8922789.png" alt="Plus" style="width: 21.6px; height: 21.6px; filter: opacity(0.7);">
                </span>
                <span>Nuevo Chat</span>
            </button>
            
            <button class="show-chats-btn tooltip" id="showChatsBtn" data-tooltip="Mostrar conversaciones">
                <img src="https://cdn-icons-png.flaticon.com/512/1178/1178067.png" alt="Conversations" style="width: 21.6px; height: 21.6px; filter: opacity(0.7);">
            </button>
            
            <div id="conversationsContainer">
                <!-- Las conversaciones se cargarán dinámicamente aquí -->
            </div>
        </div>

        <!-- Área principal -->
        <div class="main-area">
            <!-- Pantalla de bienvenida -->
            <div class="welcome-screen" id="welcomeScreen">
                <div class="language-selector">
                    <img src="https://flagcdn.com/w40/es.png" alt="Español" class="flag-btn active" onclick="changeLanguage('spanish')" data-lang="spanish">
                    <img src="https://flagcdn.com/w40/gb.png" alt="English" class="flag-btn" onclick="changeLanguage('english')" data-lang="english">
                    <img src="https://flagcdn.com/w40/fr.png" alt="Français" class="flag-btn" onclick="changeLanguage('french')" data-lang="french">
                </div>
                <h1 class="welcome-title">Hola, soy Luci. ¿Con qué te puedo ayudar?</h1>
                <div class="buttons-container">
                    <button class="option-button primary" onclick="selectOption('buy_properties')">
                        Buscar propiedades para comprar
                    </button>
                    <button class="option-button" onclick="showNotAvailablePopup()">
                        Buscar propiedades para alquilar
                    </button>
                    <button class="option-button" onclick="showNotAvailablePopup()">
                        Gestión de alquiler
                    </button>
                     <button class="option-button" onclick="showNotAvailablePopup()">
                        Gestión de financiación
                    </button>
                </div>
            </div>

            <!-- Pantalla de chat -->
            <div class="chat-screen" id="chatScreen">
                <div class="chat-header">
                    <h2 class="chat-title">Hola, soy Luci. ¿Con qué te puedo ayudar?</h2>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <!-- Los mensajes aparecerán aquí -->
                </div>

                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <textarea 
                            class="chat-input" 
                            id="chatInput" 
                            placeholder="Escribe tu mensaje..."
                            rows="1"
                        ></textarea>
                        <button class="send-button" id="sendButton" onclick="sendMessage()">
                            ➤
                        </button>
                    </div>
                    <div class="disclaimer">
                    Luci se encuentra actualmente en <span class="beta-badge">BETA</span>, por lo que puede cometer errores. Considera verificar la información importante.
                </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let isWaitingForResponse = false;
        let currentSessionId = null;
        let deviceId = null;
        let userIP = null;
        let currentConversation = [];
        let supabase = null;
        let supabaseClient = null;
        let currentTopic = null;
        let currentConversationTitle = null;
        let pendingCallback = false;
        let realtimeChannel = null;
        // Variables para timeout y popup
        let callbackTimeout = null;
        let searchMessageInterval = null;
        let currentSearchMessageIndex = 0;
        let shownTimeoutPopups = new Set();
        let shownProperties = [];
        
        // Variables para idiomas
        let currentLanguage = 'spanish';
        const translations = {
            spanish: {
                welcomeTitle: 'Hola, soy Luci. ¿Con qué te puedo ayudar?',
                newChat: 'Nuevo Chat',
                expandSidebar: 'Expandir barra principal',
                collapseSidebar: 'Recoger barra principal',
                showConversations: 'Mostrar conversaciones',
                hideConversations: 'Ocultar conversaciones',
                inputPlaceholder: 'Escribe tu mensaje...',
                disclaimer: 'Luci se encuentra actualmente en <span class="beta-badge">BETA</span>, por lo que puede cometer errores. Considera verificar la información importante.',
                searchMessages: [
                    "Buscando Propiedades",
                    "Tardamos 2 minutos de media",
                    "Ajustando búsqueda a tus Criterios"
                ],
                timeoutTitle: '¡Continuamos con tu búsqueda exhaustiva de {searchContext}, pero nos va a llevar algún minuto más!',
                timeoutText: 'Si lo prefieres, te podemos mandar los resultados por correo electrónico.',
                timeoutEmailPlaceholder: 'tu@email.com',
                timeoutContinueButton: 'Continuar esperando',
                timeoutEmailSent: 'Te enviaremos los resultados por email cuando estén listos.'
            },
            english: {
                welcomeTitle: 'Hello, I\'m Luci. How can I help you?',
                newChat: 'New Chat',
                expandSidebar: 'Expand sidebar',
                collapseSidebar: 'Collapse sidebar',
                showConversations: 'Show conversations',
                hideConversations: 'Hide conversations',
                inputPlaceholder: 'Type your message...',
                disclaimer: 'Luci is currently in <span class="beta-badge">BETA</span>, so it may make mistakes. Consider verifying important information.',
                searchMessages: [
                    "Searching Properties",
                    "We take 2 minutes on average",
                    "Adjusting search to your Criteria"
                ],
                timeoutTitle: 'We continue with your exhaustive search for {searchContext}, but it will take a few more minutes!',
                timeoutText: 'If you prefer, we can send you the results by email.',
                timeoutEmailPlaceholder: 'your@email.com',
                timeoutContinueButton: 'Continue waiting',
                timeoutEmailSent: 'We will send you the results by email when they are ready.'
            },
            french: {
                welcomeTitle: 'Bonjour, je suis Luci. Comment puis-je vous aider?',
                newChat: 'Nouveau Chat',
                expandSidebar: 'Développer la barre latérale',
                collapseSidebar: 'Réduire la barre latérale',
                showConversations: 'Afficher les conversations',
                hideConversations: 'Masquer les conversations',
                inputPlaceholder: 'Tapez votre message...',
                disclaimer: 'Luci est actuellement en <span class="beta-badge">BETA</span>, elle peut donc faire des erreurs. Considérez vérifier les informations importantes.',
                searchMessages: [
                    "Recherche de Propriétés",
                    "Nous prenons 2 minutes en moyenne",
                    "Ajustement de la recherche à vos Critères"
                ],
                timeoutTitle: 'Nous continuons votre recherche exhaustive de {searchContext}, mais cela prendra quelques minutes de plus!',
                timeoutText: 'Si vous préférez, nous pouvons vous envoyer les résultats par email.',
                timeoutEmailPlaceholder: 'votre@email.com',
                timeoutContinueButton: 'Continuer à attendre',
                timeoutEmailSent: 'Nous vous enverrons les résultats par email quand ils seront prêts.'
            }
        };
        
        
        // Configuración de Supabase
        const SUPABASE_URL = 'https://uxyxxhsgkprnuxohjhbc.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV4eXh4aHNna3BybnV4b2hqaGJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1NTM3ODEsImV4cCI6MjA1ODEyOTc4MX0.P_ggSy3oU2AvS55fQdwpnk3aFgznfVr6uCdqWH36IwY';
        
        // Inicializar Supabase cuando la librería esté cargada
       function initializeSupabase() {
            return new Promise((resolve) => {
                const checkSupabase = () => {                    
                    if (window.supabase) {
                        try {
                            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                            resolve(true);
                        } catch (error) {
                            console.error('Error al inicializar Supabase:', error);
                            resolve(false);
                        }
                    } else {
                        console.log('window.supabase no está disponible aún, reintentando...');
                        setTimeout(checkSupabase, 200);
                    }
                };
                
                // Esperar un poco antes de la primera verificación
                setTimeout(checkSupabase, 500);
            });
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeSupabase();
            await initializeApp();
            updateTexts();
            supabaseClient = supabase;

            // Event listeners para sidebar
            document.getElementById('toggleSidebar').addEventListener('click', toggleSidebar);
            document.getElementById('showChatsBtn').addEventListener('click', expandSidebar);
            
            // Exponemos estas dos funciones para poder invocarlas desde consola o botones
            window.activateTestMode = function(sessionId) {
                currentSessionId = sessionId;
                pendingCallback = true; 
                addMessage('Hola, soy Luci. ¿Con qué te puedo ayudar?', 'assistant');
                addMessage(`Sesión de prueba: ${sessionId}`, 'user');
                startRealtimeSubscription(sessionId);
                console.log('Modo test activado - pendingCallback:', pendingCallback);
            };
            
            window.sendCallbackManually = async function(textoUsuario) {
                if (!currentSessionId) return;
                addMessage(textoUsuario, 'user');
                try {
                  const response = await fetch(`/api/callback?sessionId=${currentSessionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      message: textoUsuario,
                      session_id: currentSessionId
                    })
                  });
                  const json = await response.json();
                  console.log('Respuesta /api/callback:', json);
                } catch (err) {
                  console.error('Error enviando callback:', err);
                }
              };
            
              document.getElementById('sendButton').addEventListener('click', () => {
                const texto = document.getElementById('chatInput').value.trim();
                if (texto) {
                  sendCallbackManually(texto);
                  document.getElementById('chatInput').value = '';
                }
              });
            
              window.addEventListener('beforeunload', () => {
                if (realtimeChannel) {
                  supabase.removeChannel(realtimeChannel);
                  realtimeChannel = null;
                  console.log('Suscripción Realtime cancelada por navegación');
                }
              });
        });

        function startRealtimeSubscription(sessionId) {
            // Limpiar suscripción anterior más agresivamente
            if (realtimeChannel) {
                try {
                    supabase.removeChannel(realtimeChannel);
                    realtimeChannel.unsubscribe();
                } catch (error) {
                    console.log('Error limpiando canal anterior:', error);
                }
                realtimeChannel = null;
            }
            
            currentSessionId = sessionId;
            console.log('Iniciando nueva suscripción para session:', sessionId);
            
            realtimeChannel = supabase
                .channel(`public:callbacks:session_id=eq.${sessionId}`, {
                    config: {
                        broadcast: { self: false },
                        presence: { key: sessionId }
                    }
                })
                .on(
                'postgres_changes',
                {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'callbacks',
                    filter: `session_id=eq.${sessionId}` // Filtro a nivel de Supabase
                },
                (payload) => {
                    console.log('Callback recibido:', payload);
                    const row = payload.new;
                    console.log('Row data:', row);
                    console.log('Expected session:', sessionId);
                    console.log('Row session:', row.session_id);
                    console.log('Row pending:', row.pending)

                    if (row.session_id !== sessionId) {
                        console.log('Callback ignorado - session_id no coincide');
                        return;
                    }
                    
                    const messageObj = row.payload;
                    const id = row.id;
                    console.log('Message object:', messageObj);

                    
                    const result = handleCallback({ type: 'callback', ...messageObj });
                    console.log('HandleCallback result:', result);
                    markProcessed(id);
                    
                    // Limpiar suscripción después de procesar
                    if (realtimeChannel) {
                        supabase.removeChannel(realtimeChannel);
                        realtimeChannel = null;
                        console.log('Suscripción cerrada después de procesar callback');
                    }
                }
                )
                .subscribe((status, err) => {
                    console.log('Estado de suscripción:', status);
                    if (status === 'SUBSCRIBED') {
                        console.log('Suscripción activa para session:', sessionId);
                    } else if (status === 'CHANNEL_ERROR') {
                        console.error('Error en canal Realtime:', err);
                        realtimeChannel = null;
                        // Intentar reconectar después de 2 segundos
                        setTimeout(() => {
                            if (currentSessionId === sessionId && pendingCallback) {
                                console.log('Intentando reconectar...');
                                startRealtimeSubscription(sessionId);
                            }
                        }, 2000);
                    } else if (status === 'TIMED_OUT') {
                        console.error('Timeout en suscripción Realtime');
                        realtimeChannel = null;
                        // Intentar reconectar
                        setTimeout(() => {
                            if (currentSessionId === sessionId && pendingCallback) {
                                console.log('Reconectando después de timeout...');
                                startRealtimeSubscription(sessionId);
                            }
                        }, 1000);
                    } else if (status === 'CLOSED') {
                        console.log('Canal cerrado');
                        realtimeChannel = null;
                    }
                });
        }
            
        async function markProcessed(id) {
            try {
                const response = await fetch(`/api/mark_processed?id=${id}`, {
                    method: 'POST'
                });
                const json = await response.json();
            } catch (err) {
                console.error('Error marcando como procesado:', err);
            }
            }
            
        // Función para manejar callbacks desde n8n
        function handleCallback(data) {
            console.log('handleCallback ejecutado con:', data);
            console.log('currentSessionId:', currentSessionId);
            console.log('pendingCallback:', pendingCallback);
            // Verificar que el callback es para la sesión actual
            if (!data.session_id || data.session_id !== currentSessionId) {
                console.log('Session ID mismatch:', data.session_id, 'vs', currentSessionId);
                return { success: false, message: 'Session ID mismatch or missing' };
            }
            
            if (!currentSessionId) {
                console.log('No active session');
                return { success: false, message: 'No active session' };
            }

            console.log('Processing callback - pendingCallback:', pendingCallback);
            
            // Actualizar topic si viene en la respuesta
            if (data.topic && data.topic !== currentTopic) {
                currentTopic = data.topic;
            }
            
            // Si hay propiedades Y no está vacío el array, mostrar las tarjetas
            if (data.properties && Array.isArray(data.properties) && data.properties.length > 0) {
                addPropertiesMessage(data.properties);
            }
        
            // Siempre añadir el mensaje si existe
            if (data.message) {
                addMessage(data.message, 'assistant');
            }
            
            // Resetear estado de callback pendiente
            pendingCallback = false;
            hideSearchLoading(); 
            console.log('Callback procesado exitosamente');
            return { success: true, message: 'Callback procesado correctamente' };
        }

        // Función para generar device_id único
        function generateDeviceId() {
            // Primero intentar obtener desde localStorage
            let deviceId = localStorage.getItem('lucy_device_id');
            if (deviceId) {
                return deviceId;
            }
            
            // Si no existe, intentar generar uno basado en características del navegador
            const fingerprint = [
                navigator.userAgent,
                navigator.language,
                screen.width + 'x' + screen.height,
                navigator.platform,
                Intl.DateTimeFormat().resolvedOptions().timeZone
            ].join('|');
            
            // Generar hash simple del fingerprint
            let hash = 0;
            for (let i = 0; i < fingerprint.length; i++) {
                const char = fingerprint.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convertir a 32-bit integer
            }
            
            // Convertir a string hexadecimal positivo
            deviceId = Math.abs(hash).toString(16) + Date.now().toString(16);
            
            localStorage.setItem('lucy_device_id', deviceId);
            return deviceId;
        }

        // Función para intentar recuperar conversaciones por IP cuando no hay device_id match
        async function tryRecoverConversationsByIP() {
            if (!supabase || !userIP) return [];
            
            try {
                console.log('Intentando recuperar conversaciones por IP:', userIP);
                
                const { data, error } = await supabase
                    .from('chat_sessions')
                    .select('*')
                    .eq('ip', userIP)
                    .order('updated_at', { ascending: false })
                    .limit(5); // Solo las 5 más recientes para no sobrecargar
                    
                if (error) {
                    console.error('Error al recuperar por IP:', error);
                    return [];
                }
                
                console.log('Conversaciones encontradas por IP:', data);
                return data || [];
            } catch (error) {
                console.error('Error en recuperación por IP:', error);
                return [];
            }
        }

        // Función para generar session_id único
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Función para obtener la IP del usuario
        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.error('Error al obtener IP:', error);
                return 'unknown';
            }
        }

        // Función para obtener información del navegador
        function getBrowserInfo() {
            return {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                screenResolution: `${screen.width}x${screen.height}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                timestamp: new Date().toISOString()
            };
        }

        // Función para inicializar la aplicación
        async function initializeApp() {
            deviceId = generateDeviceId();
            userIP = await getUserIP();
            
            // Esperar un poco para asegurar que Supabase esté listo
            setTimeout(async () => {
                await loadPreviousConversations();
            }, 500);
        }

        // Función para cambiar idioma
        function changeLanguage(language) {
            currentLanguage = language;
            
            // Actualizar banderas activas
            document.querySelectorAll('.flag-btn').forEach(flag => {
                flag.classList.remove('active');
                if (flag.dataset.lang === language) {
                    flag.classList.add('active');
                }
            });
            
            // Actualizar textos
            updateTexts();
        }
        
        function updateTexts() {
            const texts = translations[currentLanguage];
            
            // Actualizar elementos específicos
            const welcomeTitle = document.querySelector('.welcome-title');
            if (welcomeTitle) welcomeTitle.textContent = texts.welcomeTitle;
            
            // Actualizar botones de opciones
            const optionButtons = document.querySelectorAll('.option-button');
            const optionKeys = ['buy_properties', 'rent_properties', 'rental_management', 'financing_management'];
    
            optionButtons.forEach((button, index) => {
                if (optionKeys[index]) {
                    // Solo actualizar el texto del botón principal
                    if (button.classList.contains('primary')) {
                        button.textContent = getOptionText(optionKeys[index]);
                    } else if (index === 1) {
                        button.textContent = getOptionText('rent_properties');
                    } else if (index === 2) {
                        button.textContent = getOptionText('rental_management');
                    } else if (index === 3) {
                        button.textContent = getOptionText('financing_management');
                    }
                }
            });
            
            // Actualizar nuevo chat
            const newChatSpan = document.querySelector('.new-chat-button span:last-child');
            if (newChatSpan) newChatSpan.textContent = texts.newChat;
            
            // Actualizar placeholder del input
            const chatInput = document.getElementById('chatInput');
            if (chatInput) chatInput.placeholder = texts.inputPlaceholder;
            
            // Actualizar disclaimer
            const disclaimer = document.querySelector('.disclaimer');
            if (disclaimer) disclaimer.innerHTML = texts.disclaimer;
            
            // Actualizar tooltips
            updateTooltips();
        }
        
        function updateTooltips() {
            const texts = translations[currentLanguage];
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('toggleSidebar');
            
            if (sidebar.classList.contains('collapsed')) {
                toggleBtn.setAttribute('data-tooltip', texts.expandSidebar);
            } else {
                toggleBtn.setAttribute('data-tooltip', texts.collapseSidebar);
            }
        }

        function getOptionText(optionKey) {
            const optionMap = {
                'buy_properties': {
                    spanish: 'Buscar propiedades para comprar',
                    english: 'Search properties to buy',
                    french: 'Rechercher des propriétés à acheter'
                },
                'rent_properties': {
                    spanish: 'Buscar propiedades para alquilar',
                    english: 'Search properties to rent',
                    french: 'Rechercher des propriétés à louer'
                },
                'rental_management': {
                    spanish: 'Gestión de alquiler',
                    english: 'Rental management',
                    french: 'Gestion locative'
                },
                'financing_management': {
                    spanish: 'Gestión de financiación',
                    english: 'Financing management',
                    french: 'Gestion du financement'
                }
            };
            
            return optionMap[optionKey] ? optionMap[optionKey][currentLanguage] : optionKey;
        }

        function getTopicInSpanish(optionKey) {
            const topicMap = {
                'buy_properties': 'Buscar propiedades para comprar',
                'rent_properties': 'Buscar propiedades para alquilar', 
                'rental_management': 'Gestión de alquiler',
                'financing_management': 'Gestión de financiación'
            };
            
            return topicMap[optionKey] || optionKey;
        }
        
        // Función para cargar conversaciones previas
        async function loadPreviousConversations() {
            if (!supabase) {
                console.log('Supabase no está inicializado aún');
                return;
            }
            
            try {
                
                // Primero intentar por device_id
                const { data, error } = await supabase
                    .from('chat_sessions')
                    .select('*')
                    .eq('device_id', deviceId)
                    .neq('hide', true)
                    .order('updated_at', { ascending: false });
        
                if (error) {
                    console.error('Error al cargar conversaciones:', error);
                    return;
                }
                
                // Si no hay conversaciones por device_id, intentar recuperar por IP
                let conversationsToShow = data;
                if (!data || data.length === 0) {
                    conversationsToShow = await tryRecoverConversationsByIP();
                }
                
                displayConversations(conversationsToShow, false);
            } catch (error) {
                console.error('Error al cargar conversaciones:', error);
            }
        }

       // Función para mostrar conversaciones en el sidebar
        function displayConversations(conversations, shouldAnimate = false) {
            const container = document.getElementById('conversationsContainer');
            const sidebar = document.getElementById('sidebar');
            
            // Si está colapsado, limpiar y salir
            if (sidebar.classList.contains('collapsed')) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = '';
        
            if (!conversations || conversations.length === 0) {
                container.innerHTML = '<div class="no-conversations">No hay conversaciones previas</div>';
                return;
            }
        
            // Agrupar conversaciones por fecha
            const grouped = groupConversationsByDate(conversations);
        
            for (const [dateLabel, convs] of Object.entries(grouped)) {
                const section = document.createElement('div');
                section.className = 'conversation-section';
                
                const title = document.createElement('div');
                title.className = 'conversation-section-title';
                title.textContent = dateLabel;
                section.appendChild(title);
        
                convs.forEach(conv => {
                    const item = document.createElement('div');
                    item.className = 'conversation-item';
                    if (shouldAnimate) {
                        // Inicialmente oculto para animación
                        item.style.opacity = '0';
                        item.style.transform = 'translateX(-10px)';
                        item.style.animationDelay = '0.2s';
                    } else {
                        item.style.animation = 'none';
                    }
                    item.textContent = getConversationTitle(conv);
                    item.onclick = () => loadConversation(conv);
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-conversation';
                    deleteBtn.innerHTML = '×';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        hideConversation(conv.session_id);
                    };
                    
                    item.appendChild(deleteBtn);
                    section.appendChild(item);
                });
        
                container.appendChild(section);
            }
            
            // Si debe animar, activar animaciones después de que se agreguen al DOM
            if (shouldAnimate) {
                setTimeout(() => {
                    const items = container.querySelectorAll('.conversation-item, .conversation-section-title');
                    items.forEach((item, index) => {
                        item.style.transition = 'all 0.4s ease-in-out';
                        item.style.animationDelay = `${index * 0.05}s`;
                        item.style.opacity = '1';
                        item.style.transform = 'translateX(0)';
                    });
                }, 50);
            }
        }

        // Función auxiliar para recargar conversaciones con animación
        async function reloadConversationsWithAnimation() {
            if (!supabase) return;
            
            try {
                // Obtener conversaciones igual que en loadPreviousConversations
                const { data, error } = await supabase
                    .from('chat_sessions')
                    .select('*')
                    .eq('device_id', deviceId)
                    .neq('hide', true)
                    .order('updated_at', { ascending: false });
        
                if (error) {
                    console.error('Error al cargar conversaciones:', error);
                    return;
                }
                
                let conversationsToShow = data;
                if (!data || data.length === 0) {
                    conversationsToShow = await tryRecoverConversationsByIP();
                }
                
                // Mostrar con animación
                displayConversations(conversationsToShow, true);
            } catch (error) {
                console.error('Error al cargar conversaciones:', error);
            }
        }
        
        // Función para agrupar conversaciones por fecha
        function groupConversationsByDate(conversations) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
            const oneWeekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

            const grouped = {
                'Hoy': [],
                'Ayer': [],
                'La semana pasada': [],
                'Anteriores': []
            };

            conversations.forEach(conv => {
                const convDate = new Date(conv.updated_at);
                const convDateOnly = new Date(convDate.getFullYear(), convDate.getMonth(), convDate.getDate());

                if (convDateOnly.getTime() === today.getTime()) {
                    grouped['Hoy'].push(conv);
                } else if (convDateOnly.getTime() === yesterday.getTime()) {
                    grouped['Ayer'].push(conv);
                } else if (convDateOnly >= oneWeekAgo) {
                    grouped['La semana pasada'].push(conv);
                } else {
                    grouped['Anteriores'].push(conv);
                }
            });

            // Eliminar grupos vacíos
            Object.keys(grouped).forEach(key => {
                if (grouped[key].length === 0) {
                    delete grouped[key];
                }
            });

            return grouped;
        }

        // Función para obtener el título de una conversación
        function getConversationTitle(conversation) {
            // Usar conversation_title si está disponible
            if (conversation.conversation_title) {
                return conversation.conversation_title;
            }
            
            // Fallback al comportamiento anterior
            if (conversation.conversations && conversation.conversations.length > 0) {
                const firstUserMessage = conversation.conversations.find(msg => msg.sender === 'user');
                if (firstUserMessage) {
                    return firstUserMessage.text.substring(0, 30) + (firstUserMessage.text.length > 30 ? '...' : '');
                }
            }
            return 'Nueva conversación';
        }

        // Función para cargar una conversación específica
        function loadConversation(conversation) {
            // Limpiar suscripción anterior al cargar conversación histórica
            if (realtimeChannel) {
                try {
                    supabase.removeChannel(realtimeChannel);
                    realtimeChannel.unsubscribe();
                } catch (error) {
                    console.log('Error limpiando canal en loadConversation:', error);
                }
                realtimeChannel = null;
            }
            currentSessionId = conversation.session_id;
            currentConversation = conversation.conversations || [];
            currentTopic = conversation.topic || null;
            pendingCallback = false;
            shownProperties = [];
        
            // Cambiar a vista de chat
            showChatScreen();
        
            // Cargar mensajes
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';
        
            currentConversation.forEach(msg => {
                if (msg.properties && Array.isArray(msg.properties)) {
                    // Si el mensaje tiene propiedades, mostrarlas SIN GUARDAR (del historial)
                    addPropertiesMessageFromHistory(msg.properties);
                } else {
                    addMessage(msg.text, msg.sender, false);
                }
            });
            
            // Marcar conversación como activa
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Encontrar el elemento clickeado y marcarlo como activo
            const clickedItem = event.target.closest('.conversation-item');
            if (clickedItem) {
                clickedItem.classList.add('active');
            }
        }

        // Función para mostrar la pantalla de chat
        function showChatScreen() {
            const welcomeScreen = document.getElementById('welcomeScreen');
            const chatScreen = document.getElementById('chatScreen');

            welcomeScreen.style.display = 'none';
            chatScreen.style.display = 'flex';
            setTimeout(() => {
                chatScreen.classList.add('fade-in');
            }, 50);
        }

        // Función para guardar conversación en Supabase
        async function saveConversationToSupabase() {
            if (!supabase) {
                console.log('Supabase no está disponible para guardar');
                return;
            }
            
            try {
                const conversationData = {
                    device_id: deviceId,
                    session_id: currentSessionId,
                    ip: userIP,
                    topic: currentTopic,
                    conversation_title: currentConversationTitle,
                    conversations: currentConversation,
                    browser_info: getBrowserInfo(),
                    updated_at: new Date().toISOString()
                };

                const { data, error } = await supabase
                    .from('chat_sessions')
                    .upsert(conversationData, { 
                        onConflict: 'session_id' 
                    });

                if (error) {
                    console.error('Error al guardar conversación:', error);
            } 
            } catch (error) {
                console.error('Error al guardar conversación:', error);
            }
        }

        
        function selectOption(optionKey) {
            // Crear nueva sesión
            currentSessionId = generateSessionId();
            currentConversation = [];
            currentTopic = getTopicInSpanish(optionKey);
            shownProperties = [];

            // Fade out de la pantalla de bienvenida
            const welcomeScreen = document.getElementById('welcomeScreen');
            welcomeScreen.classList.add('fade-out');
            
            setTimeout(() => {
                showChatScreen();
                
                // Añadir mensaje del asistente primero
                const texts = translations[currentLanguage];
                addMessage(texts.welcomeTitle, 'assistant');
                
                // Añadir mensaje del usuario
                const optionText = getOptionText(optionKey);
                addMessage(optionText, 'user');
                
                // Enviar webhook
                sendWebhook(optionKey);
            }, 300);

            shownTimeoutPopups.clear();
        }

        function addMessage(text, sender, save = true) {
            const messagesContainer = document.getElementById('chatMessages');
            
            // Marcar todos los mensajes existentes como antiguos
            const existingMessages = messagesContainer.querySelectorAll('.message:not(.loading-message)');
            existingMessages.forEach(msg => {
                if (!msg.classList.contains('old')) {
                    msg.classList.add('old');
                }
            });
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.textContent = text;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
            if (save) {
                currentConversation.push({
                    text: text,
                    sender: sender,
                    timestamp: new Date().toISOString()
                });
        
                saveConversationToSupabase();
        
                if (sender === 'user') {
                    setTimeout(() => loadPreviousConversations(), 1000);
                }
            }
        }

        function showLoading() {
            const messagesContainer = document.getElementById('chatMessages');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading-message';
            loadingDiv.id = 'loadingMessage';
            loadingDiv.innerHTML = '<div class="loader"></div>';
            messagesContainer.appendChild(loadingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideLoading() {
            const loadingMessage = document.getElementById('loadingMessage');
            if (loadingMessage) {
                loadingMessage.remove();
            }
        }

        function showSearchLoading() {
            // Limpiar intervalos previos
            if (searchMessageInterval) {
                clearInterval(searchMessageInterval);
                searchMessageInterval = null;
            }
            
            const messagesContainer = document.getElementById('chatMessages');
            
            // Eliminar mensaje de búsqueda previo si existe
            const existingSearchMessage = document.getElementById('searchLoadingMessage');
            if (existingSearchMessage) {
                existingSearchMessage.remove();
            }

            // Obtener mensajes en el idioma actual
            const searchMessages = translations[currentLanguage].searchMessages;
            
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading-message'; // QUITAR 'search-loading-messages'
            loadingDiv.id = 'searchLoadingMessage';
            loadingDiv.innerHTML = '<div class="loader"></div><span id="searchMessageText" style="color: #666;">Buscando Propiedades</span>';
            messagesContainer.appendChild(loadingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Iniciar rotación de mensajes cada 4 segundos
            currentSearchMessageIndex = 0;
            searchMessageInterval = setInterval(() => {
                const messageText = document.getElementById('searchMessageText');
                if (messageText) {
                    // Hacer fade out
                    messageText.classList.add('fade-out-text');
                    
                    // Después de 500ms (duración del fade out), cambiar texto y hacer fade in
                    setTimeout(() => {
                        currentSearchMessageIndex = (currentSearchMessageIndex + 1) % searchMessages.length;
                        messageText.textContent = searchMessages[currentSearchMessageIndex];
                        messageText.classList.remove('fade-out-text');
                    }, 500);
                }
            }, 4000);
            
            // Iniciar timeout de 4 minutos
            if (callbackTimeout) {
                clearTimeout(callbackTimeout);
            }
            callbackTimeout = setTimeout(() => {
                showTimeoutPopup();
            }, 240000);
        }
        
        function hideSearchLoading() {
            const searchLoadingMessage = document.getElementById('searchLoadingMessage');
            if (searchLoadingMessage) {
                searchLoadingMessage.remove();
            }
            
            if (searchMessageInterval) {
                clearInterval(searchMessageInterval);
                searchMessageInterval = null;
            }
            
            if (callbackTimeout) {
                clearTimeout(callbackTimeout);
                callbackTimeout = null;
            }
            
            // Limpiar suscripción si no hay callback pendiente
            if (!pendingCallback && realtimeChannel) {
                try {
                    supabase.removeChannel(realtimeChannel);
                    realtimeChannel.unsubscribe();
                } catch (error) {
                    console.log('Error limpiando canal en hideSearchLoading:', error);
                }
                realtimeChannel = null;
                console.log('Suscripción limpiada en hideSearchLoading');
            }
        }

        function formatConversationAsText() {
            let conversationText = "Historial de conversación:\n\n";
            
            currentConversation.forEach((msg, index) => {
                const role = msg.sender === 'user' ? 'Usuario' : 'Luci';
                conversationText += `${role}: ${msg.text}\n\n`;
            });
            
            return conversationText;
        }
        
        function sendWebhook(message) {
            isWaitingForResponse = true;
            updateSendButton();
            showLoading();
            
            const conversationText = formatConversationAsText();
            const webhookData = {
                method: 'POST',
                url: 'https://luci-aura.app.n8n.cloud/webhook/c3b65321-b14c-47b5-80e2-0d6646bf00cd/chat', 
                data: {
                    conversation_text: conversationText,
                    current_message: message,
                    session_id: currentSessionId,
                    device_id: deviceId,
                    topic: currentTopic,
                    language: currentLanguage,
                    timestamp: new Date().toISOString(),
                    user_ip: userIP,
                    conversation_stats: {
                        total_messages: currentConversation.length,
                        user_messages: currentConversation.filter(m => m.sender === 'user').length,
                        assistant_messages: currentConversation.filter(m => m.sender === 'assistant').length
                    }
                }
            };


            fetch(webhookData.url, {
                method: webhookData.method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(webhookData.data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                return response.json();
            })
            .then(data => {
                hideLoading();
                
                // Actualizar topic si viene en la respuesta
                if (data.topic && data.topic !== currentTopic) {
                    currentTopic = data.topic;
                }

                // Actualizar título de conversación si viene en la respuesta
                if (data.conversation_title) {
                    currentConversationTitle = data.conversation_title;
                }

                 // Verificar si se espera un callback
                if (data.started_search === "yes") {
                    pendingCallback = true;
                    startRealtimeSubscription(currentSessionId);
                    showSearchLoading();
                } else {
                    pendingCallback = false;
                }
                
                // Añadir respuesta del asistente
                addMessage(data.message || data.response || 'Respuesta recibida del servidor', 'assistant');
                isWaitingForResponse = false;
                updateSendButton();
            })
            .catch(error => {
                hideLoading();
                addErrorMessage('Error de conexión, inténtalo de nuevo más tarde');
                isWaitingForResponse = false;
                updateSendButton();
                console.error('Error:', error);
            });
        }

        function addErrorMessage(text) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message error';
            messageDiv.textContent = text;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Exponer función globalmente para el endpoint
        window.handleCallback = handleCallback;

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message && !isWaitingForResponse) {
                // Si no hay sesión actual, crear una nueva
                if (!currentSessionId) {
                    currentSessionId = generateSessionId();
                    currentConversation = [];
                    
                    // Si estamos en pantalla de bienvenida, cambiar a chat
                    if (document.getElementById('welcomeScreen').style.display !== 'none') {
                        showChatScreen();
                        const texts = translations[currentLanguage];
                        addMessage(texts.welcomeTitle, 'assistant');
                    }
                }

                addMessage(message, 'user');
                input.value = '';
                input.style.height = 'auto';
                sendWebhook(message);
            }
        }

        function updateSendButton() {
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = isWaitingForResponse;
        }

        function newChat() {
             // Limpiar suscripción activa
            if (realtimeChannel) {
                try {
                    supabase.removeChannel(realtimeChannel);
                    realtimeChannel.unsubscribe();
                } catch (error) {
                    console.log('Error limpiando canal en newChat:', error);
                }
                realtimeChannel = null;
            }
            currentSessionId = null;
            currentConversation = [];
            currentTopic = null;
            pendingCallback = false;
            shownProperties = [];
            
            // Mostrar pantalla de bienvenida
            const welcomeScreen = document.getElementById('welcomeScreen');
            const chatScreen = document.getElementById('chatScreen');
            
            chatScreen.style.display = 'none';
            chatScreen.classList.remove('fade-in');
            welcomeScreen.style.display = 'flex';
            welcomeScreen.classList.remove('fade-out');

            // Limpiar mensajes
            document.getElementById('chatMessages').innerHTML = '';

            // Remover clase activa de conversaciones
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            
            shownTimeoutPopups.clear();
            });
        }

        // Event listeners
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Auto-resize textarea
        document.getElementById('chatInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Endpoint para recibir callbacks de n8n
        if (typeof window !== 'undefined') {
            // Crear endpoint simulado usando postMessage para desarrollo local
            window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'n8n_callback') {
                    handleCallback(event.data.payload);
                }
            });
            
            // Endpoint real para producción (esto requerirá configuración adicional en Vercel)
            window.callbackEndpoint = function(data) {
                return handleCallback(data);
            };
        }
        
        // Para desarrollo: función de prueba del callback
        window.testCallback = function(message) {
            const testData = {
                message: message || 'Mensaje de prueba del callback',
                topic: currentTopic
            };
            return handleCallback(testData);
        };
        
        function addPropertiesMessage(properties) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            
            const propertiesContainer = document.createElement('div');
            propertiesContainer.className = 'properties-container';
            
            properties.forEach((property, index) => {
                const thumbnail = document.createElement('div');
                thumbnail.className = 'property-thumbnail';
                thumbnail.onclick = () => openPropertyModal(property, index);
                
                const img = document.createElement('img');
                img.src = property.thumbnail;
                img.alt = property.title;
                // CORREGIDO: Eliminar el onclick de aquí porque interfiere con el modal
                
                thumbnail.appendChild(img);
                propertiesContainer.appendChild(thumbnail);
            });
            
            messageDiv.appendChild(propertiesContainer);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Guardar en conversación
            currentConversation.push({
                text: '[Propiedades mostradas]',
                sender: 'assistant',
                timestamp: new Date().toISOString(),
                properties: properties
            });
            
            saveConversationToSupabase();

            // Guardar property_ids de las propiedades mostradas
            properties.forEach(property => {
                if (property.property_id && !shownProperties.includes(property.property_id)) {
                    shownProperties.push(property.property_id);
                }
            });

            console.log('Properties added to conversation:', properties.length, 'properties');
            console.log('Current conversation length:', currentConversation.length);
            console.log('All shown properties:', shownProperties);
        }
        
       // Mostrar propiedades del historial sin duplicar
        function addPropertiesMessageFromHistory(properties) {
            const messagesContainer = document.getElementById('chatMessages');
            
            // Marcar todos los mensajes existentes como antiguos
            const existingMessages = messagesContainer.querySelectorAll('.message:not(.loading-message)');
            existingMessages.forEach(msg => {
                if (!msg.classList.contains('old')) {
                    msg.classList.add('old');
                }
            });
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            
            const propertiesContainer = document.createElement('div');
            propertiesContainer.className = 'properties-container';
            
            properties.forEach((property, index) => {
                const uniqueIndex = Date.now() + index; // Índice único para evitar conflictos
                const thumbnail = document.createElement('div');
                thumbnail.className = 'property-thumbnail';
                thumbnail.onclick = () => openPropertyModal(property, uniqueIndex);
                
                const img = document.createElement('img');
                img.src = property.thumbnail;
                img.alt = property.title;
                
                thumbnail.appendChild(img);
                propertiesContainer.appendChild(thumbnail);
            });
            
            messageDiv.appendChild(propertiesContainer);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // NO guardar en conversación porque ya está guardado
        }
        
        function openPropertyModal(property, index) {
            const modal = document.createElement('div');
            modal.className = 'property-modal';
            modal.id = 'propertyModal';
            window.currentPropertyId = property.property_id;
            
            modal.innerHTML = `
                <div class="property-card">
                    <button class="property-close" onclick="closePropertyModal()">×</button>
                    <div class="property-title">${property.title}</div>
                    <div class="property-price">${formatPrice(property.price)}</div>
                    
                    <div class="property-images">
                        <div class="property-carousel" id="carousel-${index}">
                            ${property.images.map((img, imgIndex) => 
                                `<img src="${img}" alt="${property.title}" ${imgIndex === 0 ? 'class="active"' : ''} onclick="openImageZoom('${img}')" style="cursor: zoom-in;">`
                            ).join('')}
                            ${property.images.length > 1 ? `
                                <button class="carousel-nav carousel-prev" onclick="changeImage(${index}, -1)">‹</button>
                                <button class="carousel-nav carousel-next" onclick="changeImage(${index}, 1)">›</button>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="property-details">
                        <div class="property-specs">
                            <div class="property-spec">🛏️ ${property.rooms} habitaciones</div>
                            <div class="property-spec">🚿 ${property.bathrooms} baños</div>
                            <div class="property-spec">📏 ${property.size} m²</div>
                            <div class="property-spec">🏢 Planta ${property.floor}</div>
                        </div>
                    </div>
                    
                    <button class="property-info-button" onclick="requestMoreInfo(\`${property.title}\`)">
                        Más información
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'flex';
            
            // Store current image index
            window.currentImageIndex = window.currentImageIndex || {};
            window.currentImageIndex[index] = 0;
        
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closePropertyModal();
                }
            });
        }
        
        function closePropertyModal() {
            const modal = document.getElementById('propertyModal');
            if (modal) {
                modal.remove();
            }

            // Cerrar modal con tecla Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closePropertyModal();
                }
            });
        }
        
        function changeImage(propertyIndex, direction) {
            const carousel = document.getElementById(`carousel-${propertyIndex}`);
            const images = carousel.querySelectorAll('img');
            
            if (!window.currentImageIndex) window.currentImageIndex = {};
            
            images[window.currentImageIndex[propertyIndex]].classList.remove('active');
            
            window.currentImageIndex[propertyIndex] += direction;
            
            if (window.currentImageIndex[propertyIndex] >= images.length) {
                window.currentImageIndex[propertyIndex] = 0;
            } else if (window.currentImageIndex[propertyIndex] < 0) {
                window.currentImageIndex[propertyIndex] = images.length - 1;
            }
            
            images[window.currentImageIndex[propertyIndex]].classList.add('active');
        }
        
        function formatPrice(price) {
            return new Intl.NumberFormat('es-ES', {
                style: 'currency',
                currency: 'EUR',
                maximumFractionDigits: 0
            }).format(price);
        }
        
        function requestMoreInfo(propertyTitle) {
            closePropertyModal();
            showContactInfoPopup(propertyTitle);
        }

        // Función para activar el modo test y simular estado de callback pendiente
        window.activateTestMode = function(sessionId) {
            if (!sessionId) {
                console.error('Se necesita un session_id para activar el modo test');
                return false;
            }
            
            // Activar estado de test
            currentSessionId = sessionId;
            pendingCallback = true;
            
            // Si no hay conversación activa, crear una mínima
            if (!currentConversation || currentConversation.length === 0) {
                currentConversation = [
                    {
                        text: 'Hola, soy Luci. ¿Con qué te puedo ayudar?',
                        sender: 'assistant',
                        timestamp: new Date().toISOString()
                    },
                    {
                        text: 'Buscar propiedades para comprar',
                        sender: 'user',
                        timestamp: new Date().toISOString()
                    }
                ];
                
                // Mostrar chat screen si no está visible
                if (document.getElementById('welcomeScreen').style.display !== 'none') {
                    showChatScreen();
                    // Mostrar los mensajes
                    const messagesContainer = document.getElementById('chatMessages');
                    messagesContainer.innerHTML = '';
                    currentConversation.forEach(msg => {
                        addMessage(msg.text, msg.sender, false);
                    });
                }
            }

            console.log(`Modo test activado para sesión: ${sessionId}`);
            console.log(`Callback pendiente: ${pendingCallback}`);
            return true;
        };
        
        // Función para desactivar el modo test
        window.deactivateTestMode = function() {
            pendingCallback = false;
            console.log('Modo test desactivado');
        };
        
        // Función combinada para test completo
        window.fullTestCallback = function(sessionId, testData) {
            console.log('=== INICIANDO TEST COMPLETO ===');
            
            // Activar modo test
            if (!window.activateTestMode(sessionId)) {
                return { success: false, message: 'No se pudo activar el modo test' };
            }
            
            // Simular datos de test si no se proporcionan
            const defaultTestData = {
                session_id: sessionId,
                message: "¡Claro Pablo! Aquí tienes tus propiedades!",
                properties: [
                    {
                        title: "Piso en calle Goya",
                        thumbnail: "https://img4.idealista.com/blur/WEB_DETAIL_TOP-XL-P/0/id.pro.es.image.master/e9/3a/4c/1340892243.webp",
                        price: 310000,
                        floor: "6",
                        size: 79,
                        rooms: 2,
                        bathrooms: 1,
                        images: [
                            "https://img4.idealista.com/blur/WEB_DETAIL_TOP-XL-P/0/id.pro.es.image.master/e9/3a/4c/1340892243.webp",
                            "https://img4.idealista.com/blur/WEB_DETAIL-XL-P/0/id.pro.es.image.master/c1/2d/8c/1340892242.webp"
                        ]
                    },
                    {
                        title: "Ático en Salamanca",
                        thumbnail: "https://img4.idealista.com/blur/WEB_DETAIL_TOP-XL-P/0/id.pro.es.image.master/12/34/56/1340892244.webp",
                        price: 450000,
                        floor: "7",
                        size: 95,
                        rooms: 3,
                        bathrooms: 2,
                        images: [
                            "https://img4.idealista.com/blur/WEB_DETAIL_TOP-XL-P/0/id.pro.es.image.master/12/34/56/1340892244.webp"
                        ]
                    }
                ]
            };
            
            const dataToUse = testData || defaultTestData;
            
            // Ejecutar callback
            const result = handleCallback(dataToUse);
            
            console.log('=== RESULTADO DEL TEST ===');
            console.log('Resultado:', result);
            console.log('Estado pendingCallback después del test:', pendingCallback);
            
            return result;
        };


       function toggleAllConversations(button) {
            const allConversationsLists = document.querySelectorAll('.conversations-list');
            const isAnyVisible = Array.from(allConversationsLists).some(list => list.style.display !== 'none');
            
            allConversationsLists.forEach(list => {
                if (isAnyVisible) {
                    list.style.display = 'none';
                } else {
                    list.style.display = 'block';
                }
            });
            
            // Cambiar el tooltip
            if (isAnyVisible) {
                button.setAttribute('data-tooltip', 'Mostrar conversaciones');
            } else {
                button.setAttribute('data-tooltip', 'Ocultar conversaciones');
            }
        }
        
        // Funciones para sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('toggleSidebar');
            
            sidebar.classList.toggle('collapsed');
            
            if (sidebar.classList.contains('collapsed')) {
                toggleBtn.setAttribute('data-tooltip', 'Expandir barra principal');
                // Limpiar inmediatamente cuando se colapsa
                document.getElementById('conversationsContainer').innerHTML = '';
            } else {
                toggleBtn.setAttribute('data-tooltip', 'Recoger barra principal');
                // Recargar con animación cuando se expande
                setTimeout(async () => {
                    await reloadConversationsWithAnimation();
                }, 350); // Esperar a que termine la transición del sidebar
            }
        }
        
        function expandSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('toggleSidebar');
            
            sidebar.classList.remove('collapsed');
            toggleBtn.setAttribute('data-tooltip', 'Recoger barra principal');
            setTimeout(async () => {
                await reloadConversationsWithAnimation();
            }, 350); // Esperar a que termine la transición del sidebar
        }
        
        // Función para ocultar conversaciones
        async function hideConversation(sessionId) {
            if (!supabase) return;
            
            try {
                const { error } = await supabase
                    .from('chat_sessions')
                    .update({ hide: true })
                    .eq('session_id', sessionId);
        
                if (error) {
                    console.error('Error al ocultar conversación:', error);
                    return;
                }
                
                // Recargar conversaciones
                await loadPreviousConversations();
            } catch (error) {
                console.error('Error al ocultar conversación:', error);
            }
        }
        
        // Función para mostrar popup de timeout
        function showTimeoutPopup() {
            // Verificar si ya se mostró popup para esta sesión
            if (shownTimeoutPopups.has(currentSessionId)) {
                return;
            }
            
            // Verificar si ya existe un popup visible
            if (document.getElementById('timeoutPopup')) {
                return;
            }
            
            // Marcar esta sesión como que ya mostró popup
            shownTimeoutPopups.add(currentSessionId);

            // Obtener textos en el idioma actual
            const texts = translations[currentLanguage];
            
            // Obtener el título de la conversación para personalizar el mensaje
            const searchContext = currentConversationTitle || currentTopic || 'tu búsqueda';
            
            const popup = document.createElement('div');
            popup.className = 'popup-overlay';
            popup.id = 'timeoutPopup';

            const timeoutTitle = texts.timeoutTitle.replace('{searchContext}', searchContext);
            
            popup.innerHTML = `
                <div class="popup-content">
                    <div class="popup-title">${timeoutTitle}</div>
                    <p>${texts.timeoutText}</p>
                    
                    <div class="input-with-send">
                        <input type="email" class="popup-input" id="timeoutEmail" placeholder="${texts.timeoutEmailPlaceholder}">
                        <button class="send-icon-btn" onclick="sendEmailNotification()">➤</button>
                    </div>
                    
                    <div class="popup-buttons">
                        <button class="popup-btn secondary" onclick="continueWaiting()">${texts.timeoutContinueButton}</button>
                    </div>
                </div>
            `;
                    
            document.body.appendChild(popup);
            popup.style.display = 'flex';
        }
        
        function continueWaiting() {
            const popup = document.getElementById('timeoutPopup');
            if (popup) popup.remove();
            
            // Renovar timeout por otros 4 minutos
            callbackTimeout = setTimeout(() => {
                showTimeoutPopup();
            }, 240000);
            
            // Renovar suscripción realtime
            if (currentSessionId) {
                startRealtimeSubscription(currentSessionId);
            }
        }
        
        function sendEmailNotification() {
            const email = document.getElementById('timeoutEmail').value;
            const texts = translations[currentLanguage];
            if (!email) {
                const alertText = currentLanguage === 'spanish' ? 'Por favor, introduce un email válido' : 
                                 currentLanguage === 'english' ? 'Please enter a valid email' : 
                                 'Veuillez entrer un email valide';
                alert(alertText);
                return;
            }
            
            // Aquí puedes enviar el email al webhook
            console.log('Enviando notificación a:', email);
            
            const popup = document.getElementById('timeoutPopup');
            if (popup) popup.remove();
            
            addMessage(texts.timeoutEmailSent, 'assistant');
        }
        
        // Función para mostrar popup de información de contacto
        function showContactInfoPopup(propertyTitle) {
            const popup = document.createElement('div');
            popup.className = 'popup-overlay';
            popup.id = 'contactInfoPopup';
            
            popup.innerHTML = `
                <div class="popup-content">
                    <div class="popup-title">¡Gracias por tu interés en esta propiedad!</div>
                    <p>Te enviaremos los datos completos al método de envío que selecciones a continuación</p>
                    
                    <input type="text" class="popup-input" id="userName" placeholder="Tu nombre">
                    
                    <p style="margin: 20px 0 10px 0;">Elige entre estos dos métodos de envío:</p>
                    
                    <div class="contact-method-buttons">
                        <button class="contact-method-btn" id="whatsappBtn" onclick="selectContactMethod('whatsapp')">WhatsApp</button>
                        <button class="contact-method-btn" id="emailBtn" onclick="selectContactMethod('email')">Email</button>
                    </div>
                    
                    <div id="contactInput" style="display: none;">
                        <div class="input-with-send">
                            <input type="text" class="popup-input" id="contactValue" placeholder="">
                            <button class="send-icon-btn" onclick="sendContactInfo('${propertyTitle}')">➤</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(popup);
            popup.style.display = 'flex';
            
            // Cerrar con click fuera
            popup.addEventListener('click', function(e) {
                if (e.target === popup) {
                    popup.remove();
                }
            });
        }
        
        function selectContactMethod(method) {
            const whatsappBtn = document.getElementById('whatsappBtn');
            const emailBtn = document.getElementById('emailBtn');
            const contactInput = document.getElementById('contactInput');
            const contactValue = document.getElementById('contactValue');
            
            // Resetear selección
            whatsappBtn.classList.remove('selected');
            emailBtn.classList.remove('selected');
            
            // Seleccionar método
            if (method === 'whatsapp') {
                whatsappBtn.classList.add('selected');
                contactValue.placeholder = 'Tu número de WhatsApp';
                contactValue.type = 'tel';
            } else {
                emailBtn.classList.add('selected');
                contactValue.placeholder = 'Tu email';
                contactValue.type = 'email';
            }
            
            contactInput.style.display = 'block';
        }
        
        function sendContactInfo(propertyTitle) {
            const name = document.getElementById('userName').value;
            const contactValue = document.getElementById('contactValue').value;
            const method = document.getElementById('whatsappBtn').classList.contains('selected') ? 'whatsapp' : 'email';
            
            if (!name || !contactValue) {
                alert('Por favor, completa todos los campos');
                return;
            }
            
            // Preparar datos para el webhook en formato FormData
            const formData = new FormData();
            formData.append('session_id', currentSessionId);
            formData.append('nombre', name);
            formData.append('contact_method', method);
            formData.append('phone_or_email', contactValue);
            formData.append('liked_property', window.currentPropertyId || 'unknown');
            formData.append('all_shown_properties', JSON.stringify(shownProperties));
            
            // Enviar webhook usando FormData
            fetch('https://luci-aura.app.n8n.cloud/webhook/5da544a2-525c-44d4-8647-3efac12a9e99', {
                method: 'POST',
                mode: 'no-cors',
                body: formData
            })
            .then(() => {
                console.log('Webhook de contacto enviado');
            })
            .catch(error => {
                console.error('Error enviando webhook de contacto:', error);
            });
            
            // Cerrar popup
            const popup = document.getElementById('contactInfoPopup');
            if (popup) popup.remove();
            
            // Mostrar popup de agradecimiento
            showThankYouPopup();
        }

        function showThankYouPopup() {
            // Crear popup de agradecimiento
            const popup = document.createElement('div');
            popup.className = 'popup-overlay';
            popup.id = 'thankYouPopup';
            popup.style.opacity = '0';
            popup.style.transition = 'opacity 0.3s ease-in-out';
            
            popup.innerHTML = `
                <div class="popup-content" style="text-align: center; max-width: 600px;">
                    <div class="popup-title">¡Gracias por tu interés!</div>
                    <p style="margin: 20px 0; line-height: 1.5;">
                        En breve te mandaremos la información completa por la vía que has elegido. 
                        Tardamos un máximo de 5 minutos.<br><br>
                        Si no hubieras recibido la información en este tiempo, ponte en contacto con nosotros a través de email, en 
                        <strong>info@aura-app.es</strong> o en el teléfono <strong>910 62 66 48</strong>
                    </p>
                </div>
            `;
            
            document.body.appendChild(popup);
            popup.style.display = 'flex';
            
            // Fade in
            setTimeout(() => {
                popup.style.opacity = '1';
            }, 100);
            
            // Fade out y eliminar después de 10 segundos
            setTimeout(() => {
                popup.style.opacity = '0';
                setTimeout(() => {
                    if (popup && popup.parentNode) {
                        popup.remove();
                    }
                }, 300);
            }, 10000);
            
            // Permitir cerrar con click
            popup.addEventListener('click', function(e) {
                if (e.target === popup) {
                    popup.style.opacity = '0';
                    setTimeout(() => {
                        if (popup && popup.parentNode) {
                            popup.remove();
                        }
                    }, 300);
                }
            });
        }

        function openImageZoom(imageSrc) {
            const modal = document.createElement('div');
            modal.className = 'image-zoom-modal';
            modal.innerHTML = `
                <span class="zoom-close">&times;</span>
                <img src="${imageSrc}" alt="Imagen ampliada">
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'flex';
            
            // Cerrar con click
            modal.addEventListener('click', function() {
                modal.remove();
            });
            
            // Cerrar con Escape
            const escapeHandler = function(e) {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
        }

        // Función para mostrar popup de funcionalidad no disponible
        function showNotAvailablePopup() {
            const popup = document.createElement('div');
            popup.className = 'not-available-popup';
            popup.id = 'notAvailablePopup';
            
            popup.innerHTML = `
                <div class="not-available-content">
                    <div class="not-available-title">Funcionalidad no disponible</div>
                    <p>Esta funcionalidad estará disponible próximamente.</p>
                    <button class="not-available-btn" onclick="closeNotAvailablePopup()">
                        Entendido
                    </button>
                </div>
            `;
            
            document.body.appendChild(popup);
            popup.style.display = 'flex';
            
            // Cerrar con click fuera
            popup.addEventListener('click', function(e) {
                if (e.target === popup) {
                    closeNotAvailablePopup();
                }
            });
        }
        
        function closeNotAvailablePopup() {
            const popup = document.getElementById('notAvailablePopup');
            if (popup) {
                popup.remove();
            }
        }

        
    </script>
</body>
</html>
