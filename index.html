<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luci - Asistente Inmobiliario</title>
    <link href="https://fonts.googleapis.com/css2?family=Graphik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
   <style>
        {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Graphik', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* =================== ÁREA PRINCIPAL =================== */
        .main-area {
            flex: 1;
            background-color: white;
            display: flex;
            flex-direction: column;
            position: relative;
        }

       /* =================== SIDEBAR =================== */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 80px;
            height: 100vh;
            background-color: white;
            border-right: 1px solid #e9ecef;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* Logo AURA */
        .sidebar-logo {
            padding: 20px 0;
            text-align: center;
            position: relative;
            width: 100%;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .aura-logo {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 28px;
            color: #000;
            cursor: pointer;
            position: relative;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Flecha de expandir - solo visible en hover */
        .expand-arrow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            visibility: hidden;
            background-color: #6c757d;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
            font-size: 18px;
            font-weight: bold;
            z-index: 10;
        }
        
        .sidebar-logo:hover .aura-logo {
            opacity: 0.3;
        }
        
        .sidebar-logo:hover .expand-arrow {
            opacity: 1;
            visibility: visible;
        }
        
        .expand-arrow:hover {
            background-color: #495057;
            transform: translate(-50%, -50%) scale(1.1);
        }
        
        /* Opciones de la sidebar */
        .sidebar-options {
            flex: 1;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 0 10px 0; 
            min-height: 0; 
            overflow: visible;
            max-height: calc(100vh - 100px); 
        }
       
       /* Contenedor de iconos principales */
        .sidebar-icons-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin-bottom: auto; /* Empujar hacia arriba */
        }

       /* Contenedor de botones inferiores */
        .sidebar-bottom-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin-top: auto; /* Empujar hacia abajo */
            gap: 8px; /* Espacio entre botones */
            padding-bottom: 15px; /* Espacio desde el borde inferior */
        }
        
        .sidebar-option {
            position: relative;
            width: 60px;
            height: 60px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 12px;
            transition: background-color 0.2s ease;
            flex-shrink: 0;
        }
        
        .sidebar-option:hover {
            background-color: #f8f9fa;
        }
        
        .sidebar-icon {
            width: 24px;
            height: 24px;
            transition: none;
        }
        
        /* Indicador de opción activa - raya negra */
        .sidebar-option.active::before {
            content: '';
            position: absolute;
            right: -40px;
            top: 50%;
            transform: translateY(-50%);
            height: 24px;
            width: 3px;
            background-color: #000;
            border-radius: 0;
        }
        
        /* Botón de login */
        .sidebar-login {
            position: relative;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            margin-bottom: 10px;
        }
        
        .login-circle {
            width: 40px;
            height: 40px;
            background-color: #FFC900;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }
        
        .login-circle:hover {
            background-color: #e6b400;
        }
        
        .login-icon {
            width: 18px;
            height: 18px;
            object-fit: contain;
        }
        
        /* Tooltip para login - usando la misma estructura que los otros */
        .sidebar-login::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 70px;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'Graphik', sans-serif;
            font-size: 14px;
            font-weight: 300;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            pointer-events: none;
        }
        
        .sidebar-login:hover::after {
            opacity: 1;
            visibility: visible;
            left: 75px;
        }
        
        .sidebar-login::before {
            content: '';
            position: absolute;
            left: 65px;
            top: 50%;
            transform: translateY(-50%);
            border: 5px solid transparent;
            border-right-color: rgba(0, 0, 0, 0.9);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            pointer-events: none;
        }
        
        .sidebar-login:hover::before {
            opacity: 1;
            visibility: visible;
            left: 70px;
        }
        
        /* Tooltips */
        .sidebar-option::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 70px;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'Graphik', sans-serif;
            font-size: 14px;
            font-weight: 300;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            pointer-events: none;
        }
        
        .sidebar-option:hover::after {
            opacity: 1;
            visibility: visible;
            left: 75px;
        }
        
        /* Flecha del tooltip */
        .sidebar-option::before {
            content: '';
            position: absolute;
            left: 65px;
            top: 50%;
            transform: translateY(-50%);
            border: 5px solid transparent;
            border-right-color: rgba(0, 0, 0, 0.9);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            pointer-events: none;
        }
        
        .sidebar-option:hover::before {
            opacity: 1;
            visibility: visible;
            left: 70px;
        }
        
        /* Sobrescribir el ::before para opción activa */
        .sidebar-option.active::before {
            content: '';
            position: absolute;
            right: -40px;
            top: 50%;
            transform: translateY(-50%);
            height: 24px;
            width: 3px;
            background-color: #000;
            border-radius: 0;
            opacity: 1;
            visibility: visible;
            border: none;
            z-index: 1001;
        }
        
        /* Tooltip para expand arrow */
        .expand-arrow::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 45px;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'Graphik', sans-serif;
            font-size: 14px;
            font-weight: 300;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            pointer-events: none;
        }
        
        .expand-arrow:hover::after {
            opacity: 1;
            visibility: visible;
            left: 50px;
        }
        
        .expand-arrow::before {
            content: '';
            position: absolute;
            left: 40px;
            top: 50%;
            transform: translateY(-50%);
            border: 5px solid transparent;
            border-right-color: rgba(0, 0, 0, 0.9);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            pointer-events: none;
        }
        
        .expand-arrow:hover::before {
            opacity: 1;
            visibility: visible;
            left: 45px;
        }
        
        /* Ajustar container para la sidebar */
        .container.sidebar-active {
            margin-left: 80px;
            width: calc(100% - 80px);
        }

       /* Botón nuevo chat */
        .sidebar-new-chat {
            position: relative;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            margin-bottom: 5px;
        }
        
        .new-chat-circle {
            width: 40px;
            height: 40px;
            background-color: #e9ecef;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }
        
        .new-chat-circle:hover {
            background-color: #6c757d;
        }
        
        .plus-icon {
            font-size: 20px;
            font-weight: 400;
            color: #495057;
            transition: color 0.2s ease;
        }
        
        .new-chat-circle:hover .plus-icon {
            color: white;
        }

        /* Reemplaza estas reglas CSS existentes */
        .sidebar.expanded .sidebar-option,
        .sidebar.expanded .sidebar-login,
        .sidebar.expanded .sidebar-new-chat {
          justify-content: flex-start;
          padding-left: 20px;
          width: 100%;
        }
        
        .sidebar.expanded .sidebar-option .sidebar-icon,
        .sidebar.expanded .sidebar-login .login-circle,
        .sidebar.expanded .sidebar-new-chat .new-chat-circle {
          margin-left: 0;
          margin-right: 12px;
          flex-shrink: 0;
        }
        
        .sidebar.expanded .sidebar-text {
          position: static;
          transform: none;
          opacity: 1;
          visibility: visible;
          pointer-events: auto;
          display: inline-block;
          white-space: nowrap;
          font-size: 14px;
          font-weight: 500;
          color: #333;
        }
        
        /* Asegurar que los elementos estén en línea cuando expandido */
        .sidebar.expanded .sidebar-option,
        .sidebar.expanded .sidebar-login,
        .sidebar.expanded .sidebar-new-chat {
          display: flex;
          flex-direction: row;
          align-items: center;
          justify-content: flex-start;
          padding-left: 75px;
          padding-right: 20px;
          width: 100%;
        }

       .sidebar.expanded .sidebar-icons-container {
          padding-left: 0; /* Asegurar que no haya padding extra aquí */
        }

       .sidebar.expanded .sidebar-bottom-buttons {
          padding-left: 0; /* Asegurar que no haya padding extra aquí */
        }
        
        /* Ajustar el comportamiento específico de los iconos */
        .sidebar.expanded .sidebar-option .sidebar-icon {
          width: 24px;
          height: 24px;
          margin-right: 12px;
          flex-shrink: 0;
        }
        
        .sidebar.expanded .sidebar-login .login-circle {
          width: 40px;
          height: 40px;
          margin-right: 12px;
          flex-shrink: 0;
        }
        
        .sidebar.expanded .sidebar-new-chat .new-chat-circle {
          width: 40px;
          height: 40px;
          margin-right: 12px;
          flex-shrink: 0;
        }

       .sidebar.expanded .sidebar-option.active .sidebar-text {
            font-weight: 600;
        }

       /* Ocultar la "A" cuando está expandida */
        .sidebar.expanded .aura-logo {
            display: none;
        }
        
        /* Mostrar "AURA" cuando está expandida */
        .sidebar.expanded .sidebar-logo::after {
            content: "AURA";
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 28px;
            color: #000;
            padding-left: 30px; 
            padding-right: 20px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            width: 100%;
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
        }
        
        /* Ajustar el contenedor del logo cuando está expandido */
        .sidebar.expanded .sidebar-logo {
            justify-content: flex-start;
            padding-left: 0;
        }
       
       /* Tooltip para nuevo chat */
        .sidebar-new-chat::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 70px;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'Graphik', sans-serif;
            font-size: 14px;
            font-weight: 300;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            pointer-events: none;
        }
        
        .sidebar-new-chat:hover::after {
            opacity: 1;
            visibility: visible;
            left: 75px;
        }
        
        /* Flecha del tooltip para nuevo chat */
        .sidebar-new-chat::before {
            content: '';
            position: absolute;
            left: 65px;
            top: 50%;
            transform: translateY(-50%);
            border: 5px solid transparent;
            border-right-color: rgba(0, 0, 0, 0.9);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            pointer-events: none;
        }
        
        .sidebar-new-chat:hover::before {
            opacity: 1;
            visibility: visible;
            left: 70px;
        }

       /* Sidebar expandido */
        .sidebar.expanded {
            width: 250px;
            transition: width 0.3s ease;
        }
        
        .sidebar {
            transition: width 0.3s ease;
        }
        
        /* Contenedor principal cuando sidebar está expandido */
        .container.sidebar-expanded {
            margin-left: 250px;
            width: calc(100% - 250px);
            transition: margin-left 0.3s ease, width 0.3s ease;
        }
        
        .container {
            transition: margin-left 0.3s ease, width 0.3s ease;
        }
        
        /* Texto de las opciones del sidebar (oculto por defecto) */
        .sidebar-text {
            position: absolute;
            left: 90px;
            top: 50%;
            transform: translateY(-50%);
            font-family: 'Graphik', sans-serif;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            white-space: nowrap;
            pointer-events: none;
        }
        
        /* Mostrar texto cuando sidebar está expandido */
        .sidebar.expanded .sidebar-text {
            opacity: 1;
            visibility: visible;
            left: 95px;
        }
        
        /* Ocultar tooltips cuando sidebar está expandido */
        .sidebar.expanded .sidebar-option::after,
        .sidebar.expanded .sidebar-option::before,
        .sidebar.expanded .sidebar-login::after,
        .sidebar.expanded .sidebar-login::before,
        .sidebar.expanded .sidebar-new-chat::after,
        .sidebar.expanded .sidebar-new-chat::before {
            opacity: 0 !important;
            visibility: hidden !important;
        }
        
        /* Botón de colapsar cuando está expandida */
        .sidebar.expanded .expand-arrow {
            position: fixed; /* Cambiado de absolute a fixed */
            right: calc(100vw - 250px - 150px); /* Calculado desde el borde derecho del sidebar */
            top: 40px; /* Posición fija desde arriba para alinearlo con AURA */
            transform: rotate(180deg); /* Removido translateY ya que usamos top fijo */
            opacity: 0;
            visibility: hidden;
            background-color: #f8f9fa;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #495057;
            font-size: 18px;
            font-weight: bold;
            z-index: 10;
        }

       /* Mostrar botón solo en hover sobre la línea del logo */
        .sidebar.expanded .sidebar-logo:hover .expand-arrow {
            opacity: 1;
            visibility: visible;
        }
        
        /* Hover del botón */
        .sidebar.expanded .expand-arrow:hover {
            background-color: #e9ecef;
            transform: rotate(180deg) scale(1.1);
        }
        
        /* Click del botón */
        .sidebar.expanded .expand-arrow:active {
            background-color: #6c757d;
            color: white;
            transform: rotate(180deg) scale(0.95);
        }
        
        /* Ajustar el contenedor del logo para permitir hover */
        .sidebar.expanded .sidebar-logo {
            position: relative;
            justify-content: flex-start;
            padding-left: 0;
        }
     
       
       /* =================== PANTALLA DE BIENVENIDA =================== */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 40px;
            opacity: 1;
            transition: opacity 0.3s ease-out;
        }

        .welcome-screen.fade-out {
            opacity: 0;
        }

        .welcome-title {
            font-family: 'Graphik', sans-serif;
            font-weight: bold;
            font-size: 32px;
            color: black;
            margin-bottom: 40px;
            text-align: center;
        }

        .buttons-container {
            background-color: #fbfcfd;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .option-button {
            flex: 1;
            min-width: 300px;
            padding: 15px 20px;
            background-color: white;
            color: #b8c1c8;
            border: 1px solid #ddd;
            border-radius: 12px;
            font-family: 'Graphik', sans-serif;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        /* Botón principal (comprar propiedades) - siempre destacado */
        .option-button.primary {
            background-color: #f8f9fa;
            border-color: #007bff;
            color: black;
            font-weight: normal;
        }
        
        /* Hover del botón principal */
        .option-button.primary:hover {
            transform: scale(1.05);
            font-weight: bold;
            border-color: #FFC900; 
            box-shadow: 0 2px 8px rgba(218, 165, 32, 0.3);
        }
        
        /* Botones secundarios - sin hover */
        .option-button:not(.primary):hover {
            /* Sin cambios en hover */
        }
        
        .option-button:last-child {
            margin-bottom: 0;
        }

       /* =================== SELECTOR DE IDIOMA =================== */
        .language-selector {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        
        .flag-btn {
            width: 32px;
            height: 24px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            opacity: 0.6;
            border: 2px solid transparent;
        }
        
        .flag-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        
        .flag-btn.active {
            opacity: 1;
            border: 2px solid #007bff;
        }

        /* =================== PANTALLA DE CHAT =================== */
        .chat-screen {
            display: none;
            flex-direction: column;
            height: 100%;
            opacity: 0;
            transition: opacity 0.3s ease-in;
        }

        .chat-screen.fade-in {
            opacity: 1;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: none;
        }

        .chat-title {
            font-family: 'Graphik', sans-serif;
            font-weight: bold;
            font-size: 24px;
            color: black;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .message {
            max-width: 70%;
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 18px;
            word-wrap: break-word;
            font-family: 'Graphik', sans-serif;
        }

        .message.assistant {
            background-color: white;
            border: 1px solid #ddd;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .message.user {
            background-color: #edf2f4;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.error {
            background-color: #fee;
            color: #c53030;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .message.old {
            color: #888;
            filter: grayscale(0.7) opacity(0.8);
        }
        
        .message.old.with-properties {
            filter: none !important;
            color: inherit !important;
        }
        
        .message.old.with-properties .properties-container {
            filter: none !important;
            opacity: 1 !important;
        }
        
        .message.old.with-properties .property-thumbnail {
            filter: none !important;
            opacity: 1 !important;
        }
        
        .message.old.with-properties .property-thumbnail img {
            filter: none !important;
            opacity: 1 !important;
        }

       .message.recent-callback {
            filter: none !important;
            opacity: 1 !important;
            color: inherit !important;
        }
        
        .message.recent-callback .properties-container,
        .message.recent-callback .property-thumbnail,
        .message.recent-callback .property-thumbnail img {
            filter: none !important;
            opacity: 1 !important;
        }

        .chat-input-container {
            padding: 30px;
            border-top: 1px solid #eee;
            width: 100%;
        }

        .chat-input-wrapper {
            display: flex;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 25px;
            padding: 5px;
            align-items: flex-end;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 100%;
        }

        .chat-input {
            flex: 1;
            border: none;
            outline: none;
            padding: 15px 20px;
            font-size: 16px;
            font-family: 'Graphik', sans-serif;
            border-radius: 20px;
            resize: none;
            max-height: 120px;
            min-height: 80px;
            width: 100%;
        }

        .send-button {
            background-color: #edf2f4;
            color: #333;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-right: 5px;
            margin-bottom: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }

        .send-button:hover {
            background-color: #d1d9db;
        }

        .send-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

       /* =================== DISCLAIMER =================== */
        .disclaimer {
            text-align: center;
            font-size: 12px;
            color: #888;
            margin-top: 10px;
            font-family: 'Graphik', sans-serif;
        }
        
        .beta-badge {
            background-color: rgba(147, 51, 234, 0.1);
            color: #9333ea;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        } 
               
       /* =================== PROPIEDADES =================== */
        .properties-container {
            display: flex;
            gap: 15px;
            margin: 10px 0;
            justify-content: flex-start;
        }
        
        .property-thumbnail {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            overflow: hidden;
            z-index: 2;
        }
        
        .property-thumbnail::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.7);
            transition: opacity 0.3s ease;
            z-index: 1;
        }
        
        .property-thumbnail:hover::before {
            opacity: 0;
        }
        
        .property-thumbnail:hover {
            transform: scale(1.1);
        }
        
        .property-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: zoom-in;
        }
        
        /* =================== MODAL DE PROPIEDAD =================== */
        .property-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .property-card {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        .property-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 1001;
        }
        
        .property-close:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
        }
        
        .property-title {
            font-family: 'Graphik', sans-serif;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
            color: black;
        }
        
        .property-price {
            font-size: 16px;
            color: #007bff;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .property-images {
            position: relative;
            margin-bottom: 15px;
        }
        
        .property-carousel {
            width: 100%;
            height: 200px;
            overflow: hidden;
            border-radius: 8px;
            position: relative;
        }
        
        .property-carousel img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        
        .property-carousel img.active {
            display: block;
        }
        
        .carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
        }
        
        .carousel-prev {
            left: 10px;
        }
        
        .carousel-next {
            right: 10px;
        }
        
        .property-details {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .property-specs {
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-family: 'Graphik', sans-serif;
            font-size: 14px;
        }
        
        .property-spec {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .property-info-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Graphik', sans-serif;
            margin-top: 20px;
            width: 100%;
        }
        
        .property-info-button:hover {
            background-color: #0056b3;
        }

        /* =================== MODAL DE ZOOM PARA IMÁGENES =================== */
        .image-zoom-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            cursor: zoom-out;
        }
        
        .image-zoom-modal img {
            max-width: 95vw;
            max-height: 95vh;
            object-fit: contain;
            cursor: zoom-out;
        }
        
        .zoom-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            cursor: pointer;
            z-index: 2001;
        }

        /* =================== LOADER =================== */
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-message {
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 70%;
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 18px;
            background-color: white;
            border: 1px solid #ddd;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            font-family: 'Graphik', sans-serif;
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
        
        /* =================== POP-UPS =================== */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .popup-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        
        .popup-title {
            font-family: 'Graphik', sans-serif;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 20px;
            color: black;
        }
        
        .popup-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Graphik', sans-serif;
            margin: 10px 0;
            font-size: 16px;
        }
        
        .popup-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .popup-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-family: 'Graphik', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .popup-btn.primary {
            background-color: #007bff;
            color: white;
        }
        
        .popup-btn.secondary {
            background-color: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
        }
        
        .popup-btn:hover {
            transform: translateY(-1px);
        }
        
        .contact-method-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }
        
        .contact-method-btn {
            padding: 10px 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .contact-method-btn.selected {
            border-color: #007bff;
            background-color: #e3f2fd;
        }
        
        .input-with-send {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 15px;
        }
        
        .input-with-send input {
            flex: 1;
        }
        
        .send-icon-btn {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

       /* Transición suave para el texto de búsqueda */
        #searchMessageText {
            transition: opacity 0.5s ease-in-out;
        }
        
        .fade-out-text {
            opacity: 0;
        }

        /* Atenuar emojis en mensajes antiguos */
        .message.old {
            color: #888;
            filter: grayscale(0.7) opacity(0.8);
        }
        
        /* Contorno mostaza para bocadillos con propiedades */
        .message.assistant.with-properties {
            border: 2px solid #FFC900 !important;
            background-color: rgba(218, 165, 32, 0.05) !important;
            position: relative;
            z-index: 0;
        }
        
        /* Remover padding extra del container de propiedades */
        .message.assistant .properties-container {
            padding: 0;
            margin: 0;
        }
        
        /* Popup de funcionalidad no disponible */
        .not-available-popup {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .not-available-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        
        .not-available-title {
            font-family: 'Graphik', sans-serif;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 15px;
            color: black;
        }
        
        .not-available-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-family: 'Graphik', sans-serif;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            margin-top: 15px;
        }
        

       /* =================== POPUP CREAR CUENTA =================== */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .popup-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 450px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .popup-title {
            font-family: 'Graphik', sans-serif;
            font-weight: 600;
            font-size: 24px;
            color: #333;
            margin-bottom: 10px;
        }
        
        .popup-subtitle {
            font-family: 'Graphik', sans-serif;
            font-size: 16px;
            color: #666;
            margin-bottom: 30px;
        }
        
        .login-method {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .login-btn {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #ddd;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Graphik', sans-serif;
            font-size: 14px;
        }
        
        .login-btn:hover {
            border-color: #007bff;
            background: #f8f9ff;
        }
        
        .login-btn.active {
            border-color: #000;
            background: #000;
            color: white;
        }
        
        .phone-input, .email-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 15px;
            font-family: 'Graphik', sans-serif;
        }
        
       .send-code-btn {
            width: 100%;
            padding: 15px;
            background: #000;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
            font-family: 'Graphik', sans-serif;
            font-weight: 500;
        }
        
        .popup-close {
            position: absolute;
            top: 15px;
            left: 15px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .popup-close:hover {
            background: #f0f0f0;
            color: #333;
        }
        
               
       @media (max-width: 768px) {
    
            /* =================== BIENVENIDA MÓVIL =================== */
            .welcome-screen {
                padding: 20px;
                justify-content: flex-start;
                padding-top: 100px; 
            }
            
            .welcome-title {
                font-size: 24px;
                margin-top: 50px; 
                margin-bottom: 40px;
            }
            
            /* =================== BANDERAS MÓVIL =================== */
            .language-selector {
                position: fixed;
                top: 15px;
                right: 15px;
                z-index: 1000;
                background: rgba(255, 255, 255, 0.9);
                padding: 8px;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }
            
            /* =================== CHAT MÓVIL =================== */
            .chat-screen {
                height: 100vh;
                display: flex;
                flex-direction: column;
            }
            
            .chat-messages {
                flex: 1;
                padding: 20px 15px;
                overflow-y: auto;
                margin-bottom: 0;
                /* Asegurar que el scroll funcione */
                max-height: calc(100vh - 120px); /* Restar altura del input */
            }
            
            /* =================== INPUT CONTAINER MÓVIL =================== */
            .input-container {
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 15px !important;
                background: white !important;
                border-top: 1px solid #ddd !important;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1) !important;
                z-index: 1000 !important;
                /* Reducir altura del input */
                min-height: auto !important;
            }
            
            .input-container .message-input {
                min-height: 40px !important;
                max-height: 80px !important;
                font-size: 16px !important;
            }
            
            .input-container .send-button {
                min-width: 40px !important;
                height: 40px !important;
            }
            
            /* =================== MENSAJES MÓVIL =================== */
            .message {
                max-width: 85%;
                font-size: 14px;
            }
            
            /* =================== BOTONES BIENVENIDA MÓVIL =================== */
            .buttons-container {
                padding: 20px;
                flex-direction: column;
                margin-bottom: 100px; /* Espacio para el input fijo */
            }
            
            .option-button {
                min-width: auto;
                padding: 12px 16px;
                font-size: 14px;
            }
            
            /* =================== PROPIEDADES MÓVIL =================== */
            .properties-container {
                margin-bottom: 100px; /* Espacio para el input fijo */
            }
            
      
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script>
    (function(h,o,t,j,a,r){
        h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
        h._hjSettings={hjid:6438880,hjsv:6};
        a=o.getElementsByTagName('head')[0];
        r=o.createElement('script');r.async=1;
        r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
        a.appendChild(r);
    })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
</script>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <!-- Logo AURA -->
        <div class="sidebar-logo">
            <div class="aura-logo">A</div>
            <div class="expand-arrow" data-tooltip="Expandir" onclick="toggleSidebar()">›</div>
        </div>
        
        <!-- Opciones del menú -->
        <div class="sidebar-options">
            <div class="sidebar-icons-container">
                <div class="sidebar-option active" data-option="propiedades" data-tooltip="Propiedades">
                    <img src="https://cdn-icons-png.flaticon.com/512/9664/9664027.png" alt="Propiedades" class="sidebar-icon">
                    <span class="sidebar-text">Propiedades</span>
                </div>
                <div class="sidebar-option" data-option="financiacion" data-tooltip="Financiación">
                    <img src="https://cdn-icons-png.flaticon.com/512/2769/2769362.png" alt="Financiación" class="sidebar-icon">
                    <span class="sidebar-text">Financiación</span>
                </div>
                <div class="sidebar-option" data-option="tasaciones" data-tooltip="Tasaciones">
                    <img src="https://cdn-icons-png.flaticon.com/512/2169/2169846.png" alt="Tasaciones" class="sidebar-icon">
                    <span class="sidebar-text">Tasaciones</span>
                </div>
                <div class="sidebar-option" data-option="auditorias" data-tooltip="Auditorías">
                    <img src="https://cdn-icons-png.flaticon.com/512/4561/4561511.png" alt="Auditorías" class="sidebar-icon">
                    <span class="sidebar-text">Auditorías</span>
                </div>
                <div class="sidebar-option" data-option="mudanzas" data-tooltip="Mudanzas">
                    <img src="https://cdn-icons-png.flaticon.com/512/2787/2787413.png" alt="Mudanzas" class="sidebar-icon">
                    <span class="sidebar-text">Mudanzas</span>
                </div>
                <div class="sidebar-option" data-option="reformas" data-tooltip="Reformas">
                    <img src="https://cdn-icons-png.flaticon.com/512/2963/2963833.png" alt="Reformas" class="sidebar-icon">
                    <span class="sidebar-text">Reformas</span>
                </div>
                <div class="sidebar-option" data-option="suministros" data-tooltip="Gestión Suministros">
                    <img src="https://cdn-icons-png.flaticon.com/512/566/566359.png" alt="Gestión Suministros" class="sidebar-icon">
                    <span class="sidebar-text">Gestión Suministros</span>
                </div>
            </div>
            
            <!-- Espaciador flexible -->
            <div style="flex: 1; min-height: 20px;"></div>
            
            <!-- Botones inferiores -->
            <div class="sidebar-bottom-buttons">
                <div class="sidebar-new-chat" data-tooltip="Nuevo Chat" onclick="startNewChat()">
                    <div class="new-chat-circle">
                        <span class="plus-icon">+</span>
                    </div>
                    <span class="sidebar-text">Nuevo Chat</span>
                </div>  
                <div class="sidebar-login" data-tooltip="Inicia Sesión" onclick="showLoginPopup()">
                    <div class="login-circle">
                        <img src="https://cdn-icons-png.flaticon.com/512/17468/17468741.png" alt="Login" class="login-icon">
                    </div>
                    <span class="sidebar-text">Inicia Sesión</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container sidebar-active">
        <!-- Área principal -->
        <div class="main-area">
            <!-- Pantalla de bienvenida -->
            <div class="welcome-screen" id="welcomeScreen">
                <div class="language-selector">
                    <img src="https://flagcdn.com/w40/es.png" alt="Español" class="flag-btn active" onclick="changeLanguage('spanish')" data-lang="spanish">
                    <img src="https://flagcdn.com/w40/gb.png" alt="English" class="flag-btn" onclick="changeLanguage('english')" data-lang="english">
                    <img src="https://flagcdn.com/w40/fr.png" alt="Français" class="flag-btn" onclick="changeLanguage('french')" data-lang="french">
                </div>
                <h1 class="welcome-title">Hola, soy Luci. ¿Con qué te puedo ayudar?</h1>
                <div class="buttons-container">
                    <button class="option-button primary" onclick="selectOption('buy_properties')">
                        Buscar propiedades para comprar
                    </button>
                    <button class="option-button" onclick="showNotAvailablePopup()">
                        Buscar propiedades para alquilar
                    </button>
                    <button class="option-button" onclick="showNotAvailablePopup()">
                        Gestión de alquiler
                    </button>
                     <button class="option-button" onclick="showNotAvailablePopup()">
                        Gestión de financiación
                    </button>
                </div>
            </div>
    
            <!-- Pantalla de chat -->
            <div class="chat-screen" id="chatScreen">
                <div class="chat-header">
                    <h2 class="chat-title">Hola, soy Luci. ¿Con qué te puedo ayudar?</h2>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <!-- Los mensajes aparecerán aquí -->
                </div>
    
                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <textarea 
                            class="chat-input" 
                            id="chatInput" 
                            placeholder="Escribe tu mensaje..."
                            rows="1"
                        ></textarea>
                        <button class="send-button" id="sendButton" onclick="sendMessage()">
                            ➤
                        </button>
                    </div>
                    <div class="disclaimer">
                    Luci se encuentra actualmente en <span class="beta-badge">BETA</span>, por lo que puede cometer errores. Considera verificar la información importante.
                </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Popup Crear Cuenta -->
    <div class="popup-overlay" id="loginPopup">
        <div class="popup-content">
            <button class="popup-close" onclick="closeLoginPopup()">&times;</button>
            <h2 class="popup-title">Crea tu cuenta</h2>
            <p class="popup-subtitle">Crear tu cuenta es gratis y muy sencillo</p>
            
            <div class="login-method">
                <button class="login-btn active" onclick="selectLoginMethod('whatsapp')">WhatsApp</button>
                <button class="login-btn" onclick="selectLoginMethod('email')">Email</button>
            </div>
            
            <div id="whatsappLogin">
                <input type="tel" class="phone-input" placeholder="+34 123 456 789" id="phoneInput">
            </div>
            
            <div id="emailLogin" style="display: none;">
                <input type="email" class="email-input" placeholder="tu@email.com" id="emailInput">
            </div>
            
            <button class="send-code-btn" onclick="sendLoginCode()">Enviar código</button>
        </div>
    </div>

    <script>
        // Variables globales
        let isWaitingForResponse = false;
        let currentSessionId = null;
        let deviceId = null;
        let userIP = null;
        let currentConversation = [];
        let supabase = null;
        let currentTopic = null;
        let pendingCallback = false;
        let realtimeChannel = null;
        // Variables para timeout y popup
        let callbackTimeout = null;
        let searchMessageInterval = null;
        let currentSearchMessageIndex = 0;
        let shownTimeoutPopups = new Set();
        let shownProperties = [];
        let currentPollingInterval = null;
        let pollingTimeout = null;
        let currentConversationTitle = null;
        let currentLoginMethod = 'whatsapp';
        // Variables para sidebar
        let activeSidebarOption = 'propiedades';
        
        // URLs de iconos activos e inactivos
        const iconStates = {
            'propiedades': {
                active: 'https://cdn-icons-png.flaticon.com/512/9664/9664027.png',
                inactive: 'https://cdn-icons-png.flaticon.com/512/9643/9643115.png'
            },
            'financiacion': {
                active: 'https://cdn-icons-png.flaticon.com/512/2769/2769402.png',
                inactive: 'https://cdn-icons-png.flaticon.com/512/2769/2769362.png'
            },
            'tasaciones': {
                active: 'https://cdn-icons-png.flaticon.com/512/2169/2169830.png',
                inactive: 'https://cdn-icons-png.flaticon.com/512/2169/2169846.png'
            },
            'auditorias': {
                active: 'https://cdn-icons-png.flaticon.com/512/4561/4561848.png',
                inactive: 'https://cdn-icons-png.flaticon.com/512/4561/4561511.png'
            },
            'mudanzas': {
                active: 'https://cdn-icons-png.flaticon.com/512/2787/2787368.png',
                inactive: 'https://cdn-icons-png.flaticon.com/512/2787/2787413.png'
            },
            'reformas': {
                active: 'https://cdn-icons-png.flaticon.com/512/2963/2963823.png',
                inactive: 'https://cdn-icons-png.flaticon.com/512/2963/2963833.png'
            },
            'suministros': {
                active: 'https://cdn-icons-png.flaticon.com/512/566/566410.png',
                inactive: 'https://cdn-icons-png.flaticon.com/512/566/566359.png'
            }
        };
                
        // Variables para idiomas
        let currentLanguage = 'spanish';
        const translations = {
            spanish: {
                welcomeTitle: 'Hola, soy Luci. ¿Con qué te puedo ayudar?',
                newChat: 'Nuevo Chat',
                expandSidebar: 'Expandir barra principal',
                collapseSidebar: 'Recoger barra principal',
                showConversations: 'Mostrar conversaciones',
                hideConversations: 'Ocultar conversaciones',
                inputPlaceholder: 'Escribe tu mensaje...',
                disclaimer: 'Luci se encuentra actualmente en <span class="beta-badge">BETA</span>, por lo que puede cometer errores. Considera verificar la información importante.',
                searchMessages: [
                    "Buscando Propiedades",
                    "Tardamos 2 minutos de media",
                    "Ajustando búsqueda a tus Criterios"
                ],
                timeoutTitle: '¡Continuamos con tu búsqueda exhaustiva de {searchContext}, pero nos va a llevar algún minuto más!',
                timeoutText: 'Si lo prefieres, te podemos mandar los resultados por correo electrónico.',
                timeoutEmailPlaceholder: 'tu@email.com',
                timeoutContinueButton: 'Continuar esperando',
                timeoutEmailSent: 'Te enviaremos los resultados por email cuando estén listos.'
            },
            english: {
                welcomeTitle: 'Hello, I\'m Luci. How can I help you?',
                newChat: 'New Chat',
                expandSidebar: 'Expand sidebar',
                collapseSidebar: 'Collapse sidebar',
                showConversations: 'Show conversations',
                hideConversations: 'Hide conversations',
                inputPlaceholder: 'Type your message...',
                disclaimer: 'Luci is currently in <span class="beta-badge">BETA</span>, so it may make mistakes. Consider verifying important information.',
                searchMessages: [
                    "Searching Properties",
                    "We take 2 minutes on average",
                    "Adjusting search to your Criteria"
                ],
                timeoutTitle: 'We continue with your exhaustive search for {searchContext}, but it will take a few more minutes!',
                timeoutText: 'If you prefer, we can send you the results by email.',
                timeoutEmailPlaceholder: 'your@email.com',
                timeoutContinueButton: 'Continue waiting',
                timeoutEmailSent: 'We will send you the results by email when they are ready.'
            },
            french: {
                welcomeTitle: 'Bonjour, je suis Luci. Comment puis-je vous aider?',
                newChat: 'Nouveau Chat',
                expandSidebar: 'Développer la barre latérale',
                collapseSidebar: 'Réduire la barre latérale',
                showConversations: 'Afficher les conversations',
                hideConversations: 'Masquer les conversations',
                inputPlaceholder: 'Tapez votre message...',
                disclaimer: 'Luci est actuellement en <span class="beta-badge">BETA</span>, elle peut donc faire des erreurs. Considérez vérifier les informations importantes.',
                searchMessages: [
                    "Recherche de Propriétés",
                    "Nous prenons 2 minutes en moyenne",
                    "Ajustement de la recherche à vos Critères"
                ],
                timeoutTitle: 'Nous continuons votre recherche exhaustive de {searchContext}, mais cela prendra quelques minutes de plus!',
                timeoutText: 'Si vous préférez, nous pouvons vous envoyer les résultats par email.',
                timeoutEmailPlaceholder: 'votre@email.com',
                timeoutContinueButton: 'Continuer à attendre',
                timeoutEmailSent: 'Nous vous enverrons les résultats par email quand ils seront prêts.'
            }
        };
        
        
        // Configuración de Supabase
        const SUPABASE_URL = 'https://uxyxxhsgkprnuxohjhbc.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV4eXh4aHNna3BybnV4b2hqaGJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1NTM3ODEsImV4cCI6MjA1ODEyOTc4MX0.P_ggSy3oU2AvS55fQdwpnk3aFgznfVr6uCdqWH36IwY';
        
        // Inicializar Supabase cuando la librería esté cargada
       function initializeSupabase() {
            return new Promise((resolve) => {
                const checkSupabase = () => {
                    if (window.supabase) {
                        try {
                            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
                                auth: {
                                    autoRefreshToken: true,
                                    persistSession: true,
                                    detectSessionInUrl: true
                                },
                                realtime: {
                                    params: {
                                        eventsPerSecond: 10
                                    },
                                    headers: {},
                                    heartbeatIntervalMs: 30000,
                                    reconnectAfterMs: function (tries) {
                                        return Math.min(tries * 1000, 10000);
                                    }
                                }
                            });
                            console.log('Supabase inicializado correctamente con Auth');
                            resolve(true);
                        } catch (error) {
                            console.error('Error al inicializar Supabase:', error);
                            resolve(false);
                        }
                    } else {
                        console.log('window.supabase no está disponible aún, reintentando...');
                        setTimeout(checkSupabase, 200);
                    }
                };
                
                setTimeout(checkSupabase, 500);
            });
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeSupabase();
            await initializeApp();
            updateTexts();
            supabaseClient = supabase;
            initSidebar();
             if (supabase) {
                await checkExistingSession();
            }
            
            // Exponemos estas dos funciones para poder invocarlas desde consola o botones
            window.activateTestMode = function(sessionId) {
                if (!sessionId) {
                    console.error('Se necesita un session_id para activar el modo test');
                    return false;
                }   
                currentSessionId = sessionId;
                pendingCallback = true; 
                console.log(`Modo test activado para sesión: ${sessionId}`);
                console.log(`Callback pendiente: ${pendingCallback}`);
                return true;
            };
            
            window.sendCallbackManually = async function(textoUsuario) {
                if (!currentSessionId) return;
                addMessage(textoUsuario, 'user');
                try {
                  const response = await fetch(`/api/callback?sessionId=${currentSessionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      message: textoUsuario,
                      session_id: currentSessionId
                    })
                  });
                  const json = await response.json();
                  console.log('Respuesta /api/callback:', json);
                } catch (err) {
                  console.error('Error enviando callback:', err);
                }
              };
            
              document.getElementById('sendButton').addEventListener('click', () => {
                const texto = document.getElementById('chatInput').value.trim();
                if (texto) {
                  sendCallbackManually(texto);
                  document.getElementById('chatInput').value = '';
                }
              });
            
              window.addEventListener('beforeunload', () => {
                if (realtimeChannel) {
                  supabase.removeChannel(realtimeChannel);
                  realtimeChannel = null;
                  console.log('Suscripción Realtime cancelada por navegación');
                }
              });
            
            const expandArrow = document.querySelector('.expand-arrow');
            const sidebar = document.querySelector('.sidebar');
            const container = document.querySelector('.container');
            
            if (expandArrow && sidebar && container) {
            expandArrow.addEventListener('click', () => {
              sidebar.classList.toggle('expanded');
              container.classList.toggle('sidebar-expanded');
            });
          }
        });

        window.debugRealtimeConnection = function() {
            console.log('=== DEBUG REALTIME CONNECTION ===');
            console.log('Supabase URL:', SUPABASE_URL);
            console.log('Current session:', currentSessionId);
            console.log('Channel status:', realtimeChannel?.state);
            console.log('Pending callback:', pendingCallback);
            
            // Test de conectividad
            const testChannel = supabase.channel('test-connection')
                .subscribe((status) => {
                    console.log('Test channel status:', status);
                    if (status === 'SUBSCRIBED') {
                        console.log('✅ Conexión WebSocket OK');
                        supabase.removeChannel(testChannel);
                    } else if (status === 'CHANNEL_ERROR') {
                        console.log('❌ Error en conexión WebSocket');
                    }
                });
        };
        
        function startRealtimeSubscription(sessionId) {
            // Limpiar suscripción anterior
            if (realtimeChannel) {
                try {
                    supabase.removeChannel(realtimeChannel);
                } catch (error) {
                    console.log('Error limpiando canal anterior:', error);
                }
                realtimeChannel = null;
            }
            
            currentSessionId = sessionId;
            console.log('Iniciando nueva suscripción para session:', sessionId);
            
            // Configuración corregida del canal
            realtimeChannel = supabase
                .channel('callbacks-channel', {
                    config: {
                        broadcast: { self: false },
                        presence: { key: sessionId },
                        // Eliminar headers problemáticos
                        headers: {}
                    }
                })
                .on(
                    'postgres_changes',
                    {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'callbacks',
                        filter: `session_id=eq.${sessionId}`
                    },
                    (payload) => {
                        console.log('Callback recibido:', payload);
                        const row = payload.new;
                        
                        if (row.session_id !== sessionId) {
                            console.log('Callback ignorado - session_id no coincide');
                            return;
                        }
                        
                        const messageObj = row.payload;
                        const id = row.id;
                        
                        const result = handleCallback({ type: 'callback', ...messageObj });
                        console.log('HandleCallback result:', result);
                        markProcessed(id);
                        
                        // Limpiar suscripción después de procesar
                        if (realtimeChannel) {
                            supabase.removeChannel(realtimeChannel);
                            realtimeChannel = null;
                            console.log('Suscripción cerrada después de procesar callback');
                        }
                    }
                )
                .subscribe((status, err) => {
                    console.log('Estado de suscripción:', status);
                    if (status === 'SUBSCRIBED') {
                        console.log('Suscripción activa para session:', sessionId);
                    } else if (status === 'CHANNEL_ERROR') {
                        console.error('Error en canal Realtime:', err);
                        realtimeChannel = null;
                        
                        // Intentar reconectar después de 3 segundos
                        setTimeout(() => {
                            if (currentSessionId === sessionId && pendingCallback) {
                                console.log('Intentando reconectar...');
                                startRealtimeSubscription(sessionId);
                            }
                        }, 3000);
                    } else if (status === 'TIMED_OUT') {
                        console.error('Timeout en suscripción Realtime');
                        realtimeChannel = null;
                        
                        // Intentar reconectar
                        setTimeout(() => {
                            if (currentSessionId === sessionId && pendingCallback) {
                                console.log('Reconectando después de timeout...');
                                startRealtimeSubscription(sessionId);
                            }
                        }, 2000);
                    } else if (status === 'CLOSED') {
                        console.log('Canal cerrado');
                        realtimeChannel = null;
                    }
                });
        }
        
        function startHybridSubscription(sessionId, isSafariMobile = false) {
            // Sistema híbrido para TODOS los dispositivos
            let pollingInterval = null;
            let realtimeWorking = false;
            
            // Configuraciones específicas según el dispositivo
            const config = isSafariMobile ? {
                heartbeat_interval_ms: 10000, // Más frecuente para Safari
                timeout_ms: 8000,
                pollingDelay: 5000 // Esperar 5s antes de activar polling
            } : {
                heartbeat_interval_ms: 15000, // Configuración estándar
                timeout_ms: 10000,
                pollingDelay: 10000 // Esperar 10s antes de activar polling
            };
            
            console.log('Iniciando suscripción híbrida:', isSafariMobile ? 'Safari móvil' : 'Dispositivo estándar');
            
            // Iniciar Realtime
            realtimeChannel = supabase
                .channel(`public:callbacks:session_id=eq.${sessionId}`, {
                    config: {
                        broadcast: { self: false },
                        presence: { key: sessionId },
                        heartbeat_interval_ms: config.heartbeat_interval_ms,
                        timeout_ms: config.timeout_ms
                    }
                })
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'callbacks',
                    filter: `session_id=eq.${sessionId}`
                }, (payload) => {
                    console.log('Callback recibido via Realtime (híbrido):', payload);
                    realtimeWorking = true;
                    // Detener polling si Realtime funciona
                    if (pollingInterval) {
                        clearInterval(pollingInterval);
                        pollingInterval = null;
                        console.log('Polling detenido - Realtime funcionando');
                    }
                    handleRealtimeCallback(payload, sessionId);
                })
                .subscribe((status, err) => {
                    console.log('Estado suscripción híbrida:', status);
                    if (status === 'SUBSCRIBED') {
                        console.log(`Realtime conectado - esperando ${config.pollingDelay/1000}s antes de activar polling de respaldo`);
                        // Dar tiempo a Realtime, luego activar polling como respaldo
                        setTimeout(() => {
                            if (!realtimeWorking && currentSessionId === sessionId && pendingCallback) {
                                console.log('Activando polling como respaldo');
                                startCallbackPolling(sessionId);
                            }
                        }, config.pollingDelay);
                    } else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') {
                        console.log('Error en Realtime - activando polling inmediatamente');
                        if (!pollingInterval) {
                            startCallbackPolling(sessionId);
                        }
                    }
                });
        }
        
        function startCallbackPolling(sessionId) {
            // Limpiar polling anterior si existe
            if (currentPollingInterval) {
                clearInterval(currentPollingInterval);
                currentPollingInterval = null;
            }
            
            if (pollingTimeout) {
                clearTimeout(pollingTimeout);
                pollingTimeout = null;
            }
            
            console.log('Iniciando polling para session:', sessionId);
            
            // Timeout de 3 minutos
            pollingTimeout = setTimeout(() => {
                console.log('Timeout de polling alcanzado (3 minutos)');
                if (currentPollingInterval) {
                    clearInterval(currentPollingInterval);
                    currentPollingInterval = null;
                }
                pollingTimeout = null;
            }, 180000);
            
            currentPollingInterval = setInterval(async () => {
                if (currentSessionId !== sessionId || !pendingCallback) {
                    clearInterval(currentPollingInterval);
                    currentPollingInterval = null;
                    if (pollingTimeout) {
                        clearTimeout(pollingTimeout);
                        pollingTimeout = null;
                    }
                    console.log('Polling detenido');
                    return;
                }
                
                try {
                    console.log('Haciendo polling para callbacks...');
                    const { data, error } = await supabase
                        .from('callbacks')
                        .select('*')
                        .eq('session_id', sessionId)
                        .eq('pending', true)
                        .order('created_at', { ascending: false })
                        .limit(1);
                        
                    if (error) {
                        console.error('Error en polling:', error);
                        return;
                    }
                    
                    if (data && data.length > 0) {
                        const callback = data[0];
                        console.log('Callback encontrado via polling:', callback);
                        
                        const payload = { new: callback, eventType: 'INSERT' };
                        handleRealtimeCallback(payload, sessionId);
                        
                        clearInterval(currentPollingInterval);
                        currentPollingInterval = null;
                        if (pollingTimeout) {
                            clearTimeout(pollingTimeout);
                            pollingTimeout = null;
                        }
                        console.log('Polling detenido - callback procesado');
                    }
                } catch (error) {
                    console.error('Error en polling:', error);
                }
            }, 6000);
        }
        
        function handleRealtimeCallback(payload, sessionId) {
            const row = payload.new;
            console.log('Procesando callback:', row);
            
            if (row.session_id !== sessionId) {
                console.log('Callback ignorado - session_id no coincide');
                return;
            }
            
            const messageObj = row.payload;
            const id = row.id;
            
            const result = handleCallback({ type: 'callback', ...messageObj });
            console.log('HandleCallback result:', result);
            markProcessed(id);
            
            // Limpiar suscripción después de procesar
            if (realtimeChannel) {
                supabase.removeChannel(realtimeChannel);
                realtimeChannel = null;
                console.log('Suscripción cerrada después de procesar callback');
            }
            
            // Limpiar polling Y su timeout si existen
            if (window.currentPollingInterval) {
                clearInterval(window.currentPollingInterval);
                window.currentPollingInterval = null;
                console.log('Polling interval limpiado después de procesar callback');
            }
            
            if (window.pollingTimeout) {
                clearTimeout(window.pollingTimeout);
                window.pollingTimeout = null;
                console.log('Polling timeout limpiado después de procesar callback');
            }
        }
        
        function handleSubscriptionStatus(status, err, sessionId) {
            if (status === 'SUBSCRIBED') {
                console.log('Suscripción activa para session:', sessionId);
            } else if (status === 'CHANNEL_ERROR') {
                console.error('Error en canal Realtime:', err);
                realtimeChannel = null;
                // Para Safari, activar polling inmediatamente
                const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
                if (isSafari) {
                    console.log('Error en Safari - activando polling');
                    startCallbackPolling(sessionId);
                } else {
                    setTimeout(() => {
                        if (currentSessionId === sessionId && pendingCallback) {
                            console.log('Intentando reconectar...');
                            startRealtimeSubscription(sessionId);
                        }
                    }, 2000);
                }
            } else if (status === 'TIMED_OUT') {
                console.error('Timeout en suscripción Realtime');
                realtimeChannel = null;
                startCallbackPolling(sessionId); // Activar polling en timeout
            } else if (status === 'CLOSED') {
                console.log('Canal cerrado');
                realtimeChannel = null;
            }
        }
            
        async function markProcessed(id) {
            try {
                const response = await fetch(`/api/mark_processed?id=${id}`, {
                    method: 'POST'
                });
                const json = await response.json();
            } catch (err) {
                console.error('Error marcando como procesado:', err);
            }
            }
            
        // Función para manejar callbacks desde n8n
        function handleCallback(data) {
            console.log('handleCallback ejecutado con:', data);
            console.log('currentSessionId:', currentSessionId);
            console.log('pendingCallback:', pendingCallback);
            // Verificar que el callback es para la sesión actual
            if (!data.session_id || data.session_id !== currentSessionId) {
                console.log('Session ID mismatch:', data.session_id, 'vs', currentSessionId);
                return { success: false, message: 'Session ID mismatch or missing' };
            }
            
            if (!currentSessionId) {
                console.log('No active session');
                return { success: false, message: 'No active session' };
            }

            console.log('Processing callback - pendingCallback:', pendingCallback);
            
            // Actualizar topic si viene en la respuesta
            if (data.topic && data.topic !== currentTopic) {
                currentTopic = data.topic;
            }
            
            // Si hay propiedades Y no está vacío el array, mostrar las tarjetas
            if (data.properties && Array.isArray(data.properties) && data.properties.length > 0) {
                addPropertiesMessage(data.properties);
            }
        
            // Siempre añadir el mensaje si existe
            if (data.message) {
                addMessage(data.message, 'assistant');
            }
            
            // Resetear estado de callback pendiente
            pendingCallback = false;
            hideSearchLoading(); 
            console.log('Callback procesado exitosamente');
            return { success: true, message: 'Callback procesado correctamente' };
        }

        // Función para generar device_id único
        function generateDeviceId() {
            // Primero intentar obtener desde localStorage
            let deviceId = localStorage.getItem('lucy_device_id');
            if (deviceId) {
                return deviceId;
            }
            
            // Si no existe, intentar generar uno basado en características del navegador
            const fingerprint = [
                navigator.userAgent,
                navigator.language,
                screen.width + 'x' + screen.height,
                navigator.platform,
                Intl.DateTimeFormat().resolvedOptions().timeZone
            ].join('|');
            
            // Generar hash simple del fingerprint
            let hash = 0;
            for (let i = 0; i < fingerprint.length; i++) {
                const char = fingerprint.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convertir a 32-bit integer
            }
            
            // Convertir a string hexadecimal positivo
            deviceId = Math.abs(hash).toString(16) + Date.now().toString(16);
            
            localStorage.setItem('lucy_device_id', deviceId);
            return deviceId;
        }

        // Función para intentar recuperar conversaciones por IP cuando no hay device_id match
        async function tryRecoverConversationsByIP() {
            if (!supabase || !userIP) return [];
            
            try {
                console.log('Intentando recuperar conversaciones por IP:', userIP);
                
                const { data, error } = await supabase
                    .from('chat_sessions')
                    .select('*')
                    .eq('ip', userIP)
                    .order('updated_at', { ascending: false })
                    .limit(5); // Solo las 5 más recientes para no sobrecargar
                    
                if (error) {
                    console.error('Error al recuperar por IP:', error);
                    return [];
                }
                
                console.log('Conversaciones encontradas por IP:', data);
                return data || [];
            } catch (error) {
                console.error('Error en recuperación por IP:', error);
                return [];
            }
        }

        // Función para generar session_id único
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Función para obtener la IP del usuario
        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.error('Error al obtener IP:', error);
                return 'unknown';
            }
        }

        // Función para obtener información del navegador
        function getBrowserInfo() {
            return {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                screenResolution: `${screen.width}x${screen.height}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                timestamp: new Date().toISOString()
            };
        }

        // Función para inicializar la aplicación
        async function initializeApp() {
            deviceId = generateDeviceId();
            userIP = await getUserIP();
            
            // Esperar un poco para asegurar que Supabase esté listo
            setTimeout(async () => {
                await loadPreviousConversations();
            }, 500);
        }

        // Función para cambiar idioma
        function changeLanguage(language) {
            currentLanguage = language;
            
            // Actualizar banderas activas
            document.querySelectorAll('.flag-btn').forEach(flag => {
                flag.classList.remove('active');
                if (flag.dataset.lang === language) {
                    flag.classList.add('active');
                }
            });
            
            // Actualizar textos
            updateTexts();
        }
        
        function updateTexts() {
            const texts = translations[currentLanguage];
            
            // Actualizar elementos específicos
            const welcomeTitle = document.querySelector('.welcome-title');
            if (welcomeTitle) welcomeTitle.textContent = texts.welcomeTitle;
            
            // Actualizar botones de opciones
            const optionButtons = document.querySelectorAll('.option-button');
            const optionKeys = ['buy_properties', 'rent_properties', 'rental_management', 'financing_management'];
    
            optionButtons.forEach((button, index) => {
                if (optionKeys[index]) {
                    // Solo actualizar el texto del botón principal
                    if (button.classList.contains('primary')) {
                        button.textContent = getOptionText(optionKeys[index]);
                    } else if (index === 1) {
                        button.textContent = getOptionText('rent_properties');
                    } else if (index === 2) {
                        button.textContent = getOptionText('rental_management');
                    } else if (index === 3) {
                        button.textContent = getOptionText('financing_management');
                    }
                }
            });
            
            // Actualizar nuevo chat
            const newChatBtn = document.querySelector('.sidebar-new-chat');
            if (newChatBtn) {
                newChatBtn.setAttribute('data-tooltip', texts.newChat);
            }
            
            // Actualizar placeholder del input
            const chatInput = document.getElementById('chatInput');
            if (chatInput) chatInput.placeholder = texts.inputPlaceholder;
            
            // Actualizar disclaimer
            const disclaimer = document.querySelector('.disclaimer');
            if (disclaimer) disclaimer.innerHTML = texts.disclaimer;

            // Actualizar textos de la sidebar
            const sidebarTexts = {
                spanish: {
                    propiedades: 'Propiedades',
                    financiacion: 'Financiación', 
                    tasaciones: 'Tasaciones',
                    auditorias: 'Auditorías',
                    mudanzas: 'Mudanzas',
                    reformas: 'Reformas',
                    suministros: 'Gestión Suministros'
                },
                english: {
                    propiedades: 'Properties',
                    financiacion: 'Financing',
                    tasaciones: 'Valuations', 
                    auditorias: 'Audits',
                    mudanzas: 'Moving',
                    reformas: 'Renovations',
                    suministros: 'Utilities Management'
                },
                french: {
                    propiedades: 'Propriétés',
                    financiacion: 'Financement',
                    tasaciones: 'Évaluations',
                    auditorias: 'Audits', 
                    mudanzas: 'Déménagement',
                    reformas: 'Rénovations',
                    suministros: 'Gestion Services'
                }
            };
            
            // Actualizar textos de sidebar
            Object.keys(sidebarTexts[currentLanguage]).forEach(key => {
                const element = document.querySelector(`[data-option="${key}"] .sidebar-text`);
                if (element) {
                    element.textContent = sidebarTexts[currentLanguage][key];
                }
            });        
        }
        

        function getOptionText(optionKey) {
            const optionMap = {
                'buy_properties': {
                    spanish: 'Buscar propiedades para comprar',
                    english: 'Search properties to buy',
                    french: 'Rechercher des propriétés à acheter'
                },
                'rent_properties': {
                    spanish: 'Buscar propiedades para alquilar',
                    english: 'Search properties to rent',
                    french: 'Rechercher des propriétés à louer'
                },
                'rental_management': {
                    spanish: 'Gestión de alquiler',
                    english: 'Rental management',
                    french: 'Gestion locative'
                },
                'financing_management': {
                    spanish: 'Gestión de financiación',
                    english: 'Financing management',
                    french: 'Gestion du financement'
                }
            };
            
            return optionMap[optionKey] ? optionMap[optionKey][currentLanguage] : optionKey;
        }

        function getTopicInSpanish(optionKey) {
            const topicMap = {
                'buy_properties': 'Buscar propiedades para comprar',
                'rent_properties': 'Buscar propiedades para alquilar', 
                'rental_management': 'Gestión de alquiler',
                'financing_management': 'Gestión de financiación'
            };
            
            return topicMap[optionKey] || optionKey;
        }
        
        // Función para cargar conversaciones previas
        async function loadPreviousConversations() {
            if (!supabase) {
                console.log('Supabase no está inicializado aún');
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('chat_sessions')
                    .select('*')
                    .eq('device_id', deviceId)
                    .neq('hide', true)
                    .order('updated_at', { ascending: false });
        
                if (error) {
                    console.error('Error al cargar conversaciones:', error);
                    return;
                }
                
                let conversationsToShow = data;
                if (!data || data.length === 0) {
                    conversationsToShow = await tryRecoverConversationsByIP();
                }
                
                // Solo log por ahora - no mostrar en UI
                console.log('Conversaciones cargadas:', conversationsToShow?.length || 0);
            } catch (error) {
                console.error('Error al cargar conversaciones:', error);
            }
        }


        // Función para cargar una conversación específica
        function loadConversation(conversation) {
            // Limpiar suscripción anterior al cargar conversación histórica
            if (realtimeChannel) {
                try {
                    supabase.removeChannel(realtimeChannel);
                    realtimeChannel.unsubscribe();
                } catch (error) {
                    console.log('Error limpiando canal en loadConversation:', error);
                }
                realtimeChannel = null;
            }
            currentSessionId = conversation.session_id;
            currentConversation = conversation.conversations || [];
            currentTopic = conversation.topic || null;
            pendingCallback = false;
            shownProperties = [];
        
            // Cambiar a vista de chat
            showChatScreen();
        
            // Cargar mensajes
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';
        
            currentConversation.forEach(msg => {
                if (msg.properties && Array.isArray(msg.properties)) {
                    // Si el mensaje tiene propiedades, mostrarlas SIN GUARDAR (del historial)
                    addPropertiesMessageFromHistory(msg.properties);
                } else {
                    addMessage(msg.text, msg.sender, false);
                }
            });
            
            // Marcar conversación como activa
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Encontrar el elemento clickeado y marcarlo como activo
            const clickedItem = event.target.closest('.conversation-item');
            if (clickedItem) {
                clickedItem.classList.add('active');
            }
        }

        // Función para mostrar la pantalla de chat
        function showChatScreen() {
            const welcomeScreen = document.getElementById('welcomeScreen');
            const chatScreen = document.getElementById('chatScreen');

            welcomeScreen.style.display = 'none';
            chatScreen.style.display = 'flex';
            setTimeout(() => {
                chatScreen.classList.add('fade-in');
            }, 50);
        }

        // Función para guardar conversación en Supabase
        async function saveConversationToSupabase() {
            if (!supabase) {
                console.log('Supabase no está disponible para guardar');
                return;
            }
            
            try {
                const conversationData = {
                    device_id: deviceId,
                    session_id: currentSessionId,
                    ip: userIP,
                    topic: currentTopic,
                    conversation_title: currentConversationTitle,
                    conversations: currentConversation,
                    browser_info: getBrowserInfo(),
                    updated_at: new Date().toISOString()
                };

                const { data, error } = await supabase
                    .from('chat_sessions')
                    .upsert(conversationData, { 
                        onConflict: 'session_id' 
                    });

                if (error) {
                    console.error('Error al guardar conversación:', error);
            } 
            } catch (error) {
                console.error('Error al guardar conversación:', error);
            }
        }

        
        function selectOption(optionKey) {
            // Crear nueva sesión
            currentSessionId = generateSessionId();
            currentConversation = [];
            currentTopic = getTopicInSpanish(optionKey);
            shownProperties = [];

            // Fade out de la pantalla de bienvenida
            const welcomeScreen = document.getElementById('welcomeScreen');
            welcomeScreen.classList.add('fade-out');
            
            setTimeout(() => {
                showChatScreen();
                
                // Añadir mensaje del asistente primero
                const texts = translations[currentLanguage];
                addMessage(texts.welcomeTitle, 'assistant');
                
                // Añadir mensaje del usuario
                const optionText = getOptionText(optionKey);
                addMessage(optionText, 'user');
                
                // Enviar webhook
                sendWebhook(optionKey);
            }, 300);

        }

        function addMessage(text, sender, save = true) {
            const messagesContainer = document.getElementById('chatMessages');
            
            // Marcar todos los mensajes existentes como antiguos
            const existingMessages = messagesContainer.querySelectorAll('.message:not(.loading-message)');
            existingMessages.forEach(msg => {
                if (!msg.classList.contains('old')) {
                    msg.classList.add('old');
                }
            });
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.textContent = text;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
            if (save) {
                currentConversation.push({
                    text: text,
                    sender: sender,
                    timestamp: new Date().toISOString()
                });
        
                saveConversationToSupabase();
        
                if (sender === 'user') {
                    setTimeout(() => loadPreviousConversations(), 1000);
                }
            }
        }

        function showLoading() {
            const messagesContainer = document.getElementById('chatMessages');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading-message';
            loadingDiv.id = 'loadingMessage';
            loadingDiv.innerHTML = '<div class="loader"></div>';
            messagesContainer.appendChild(loadingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideLoading() {
            const loadingMessage = document.getElementById('loadingMessage');
            if (loadingMessage) {
                loadingMessage.remove();
            }
        }

        function showSearchLoading() {
            // Limpiar intervalos previos
            if (searchMessageInterval) {
                clearInterval(searchMessageInterval);
                searchMessageInterval = null;
            }
            
            const messagesContainer = document.getElementById('chatMessages');
            
            // Eliminar mensaje de búsqueda previo si existe
            const existingSearchMessage = document.getElementById('searchLoadingMessage');
            if (existingSearchMessage) {
                existingSearchMessage.remove();
            }

            // Obtener mensajes en el idioma actual
            const searchMessages = translations[currentLanguage].searchMessages;
            
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading-message'; // QUITAR 'search-loading-messages'
            loadingDiv.id = 'searchLoadingMessage';
            loadingDiv.innerHTML = '<div class="loader"></div><span id="searchMessageText" style="color: #666;">Buscando Propiedades</span>';
            messagesContainer.appendChild(loadingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Iniciar rotación de mensajes cada 4 segundos
            currentSearchMessageIndex = 0;
            searchMessageInterval = setInterval(() => {
                const messageText = document.getElementById('searchMessageText');
                if (messageText) {
                    // Hacer fade out
                    messageText.classList.add('fade-out-text');
                    
                    // Después de 500ms (duración del fade out), cambiar texto y hacer fade in
                    setTimeout(() => {
                        currentSearchMessageIndex = (currentSearchMessageIndex + 1) % searchMessages.length;
                        messageText.textContent = searchMessages[currentSearchMessageIndex];
                        messageText.classList.remove('fade-out-text');
                    }, 500);
                }
            }, 4000);
            
            // Iniciar timeout de 4 minutos
            if (callbackTimeout) {
                clearTimeout(callbackTimeout);
            }
            callbackTimeout = setTimeout(() => {
                showTimeoutPopup();
            }, 240000);
        }
        
        function hideSearchLoading() {
            const searchLoadingMessage = document.getElementById('searchLoadingMessage');
            if (searchLoadingMessage) {
                searchLoadingMessage.remove();
            }
            
            if (searchMessageInterval) {
                clearInterval(searchMessageInterval);
                searchMessageInterval = null;
            }
            
            if (callbackTimeout) {
                clearTimeout(callbackTimeout);
                callbackTimeout = null;
            }
            
            // Limpiar polling Y su timeout
            if (window.currentPollingInterval) {
                clearInterval(window.currentPollingInterval);
                window.currentPollingInterval = null;
                console.log('Polling interval limpiado en hideSearchLoading');
            }
            
            if (window.pollingTimeout) {
                clearTimeout(window.pollingTimeout);
                window.pollingTimeout = null;
                console.log('Polling timeout limpiado en hideSearchLoading');
            }
            
            // Limpiar suscripción si no hay callback pendiente
            if (!pendingCallback && realtimeChannel) {
                try {
                    supabase.removeChannel(realtimeChannel);
                    realtimeChannel.unsubscribe();
                } catch (error) {
                    console.log('Error limpiando canal en hideSearchLoading:', error);
                }
                realtimeChannel = null;
                console.log('Suscripción limpiada en hideSearchLoading');
            }
        }

        function formatConversationAsText() {
            let conversationText = "Historial de conversación:\n\n";
            
            currentConversation.forEach((msg, index) => {
                const role = msg.sender === 'user' ? 'Usuario' : 'Luci';
                conversationText += `${role}: ${msg.text}\n\n`;
            });
            
            return conversationText;
        }
        
        function sendWebhook(message) {
            isWaitingForResponse = true;
            updateSendButton();
            showLoading();
            
            const conversationText = formatConversationAsText();
            const webhookData = {
                method: 'POST',
                url: 'https://luci-aura.app.n8n.cloud/webhook/c3b65321-b14c-47b5-80e2-0d6646bf00cd/chat', 
                data: {
                    conversation_text: conversationText,
                    current_message: message,
                    session_id: currentSessionId,
                    device_id: deviceId,
                    topic: currentTopic,
                    language: currentLanguage,
                    timestamp: new Date().toISOString(),
                    user_ip: userIP,
                    conversation_stats: {
                        total_messages: currentConversation.length,
                        user_messages: currentConversation.filter(m => m.sender === 'user').length,
                        assistant_messages: currentConversation.filter(m => m.sender === 'assistant').length
                    }
                }
            };


            fetch(webhookData.url, {
                method: webhookData.method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(webhookData.data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                return response.json();
            })
            .then(data => {
                hideLoading();
                
                // Actualizar topic si viene en la respuesta
                if (data.topic && data.topic !== currentTopic) {
                    currentTopic = data.topic;
                }

                // Actualizar título de conversación si viene en la respuesta
                if (data.conversation_title) {
                    currentConversationTitle = data.conversation_title;
                }

                 // Verificar si se espera un callback
                if (data.started_search === "yes") {
                    pendingCallback = true;
                    startRealtimeSubscription(currentSessionId);
                    showSearchLoading();
                } else {
                    pendingCallback = false;
                }
                
                // Añadir respuesta del asistente
                addMessage(data.message || data.response || 'Respuesta recibida del servidor', 'assistant');
                isWaitingForResponse = false;
                updateSendButton();
            })
            .catch(error => {
                hideLoading();
                addErrorMessage('Error de conexión, inténtalo de nuevo más tarde');
                isWaitingForResponse = false;
                updateSendButton();
                console.error('Error:', error);
            });
        }

        function addErrorMessage(text) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message error';
            messageDiv.textContent = text;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Exponer función globalmente para el endpoint
        window.handleCallback = handleCallback;

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message && !isWaitingForResponse) {
                // Si no hay sesión actual, crear una nueva
                if (!currentSessionId) {
                    currentSessionId = generateSessionId();
                    currentConversation = [];
                    
                    // Si estamos en pantalla de bienvenida, cambiar a chat
                    if (document.getElementById('welcomeScreen').style.display !== 'none') {
                        showChatScreen();
                        const texts = translations[currentLanguage];
                        addMessage(texts.welcomeTitle, 'assistant');
                    }
                }

                addMessage(message, 'user');
                input.value = '';
                input.style.height = 'auto';
                sendWebhook(message);
            }
        }

        function updateSendButton() {
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = isWaitingForResponse;
        }

        function newChat() {
            // Limpiar suscripción activa
            if (realtimeChannel) {
                try {
                    supabase.removeChannel(realtimeChannel);
                    realtimeChannel.unsubscribe();
                } catch (error) {
                    console.log('Error limpiando canal en newChat:', error);
                }
                realtimeChannel = null;
            }
            currentSessionId = null;
            currentConversation = [];
            currentTopic = null;
            pendingCallback = false;
            shownProperties = [];
            
            // Mostrar pantalla de bienvenida
            const welcomeScreen = document.getElementById('welcomeScreen');
            const chatScreen = document.getElementById('chatScreen');
            
            chatScreen.style.display = 'none';
            chatScreen.classList.remove('fade-in');
            welcomeScreen.style.display = 'flex';
            welcomeScreen.classList.remove('fade-out');
        
            // Limpiar mensajes
            document.getElementById('chatMessages').innerHTML = '';
        
            shownTimeoutPopups.clear();
        }

        // Event listeners
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Auto-resize textarea
        document.getElementById('chatInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Endpoint para recibir callbacks de n8n
        if (typeof window !== 'undefined') {
            // Crear endpoint simulado usando postMessage para desarrollo local
            window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'n8n_callback') {
                    handleCallback(event.data.payload);
                }
            });
            
            // Endpoint real para producción (esto requerirá configuración adicional en Vercel)
            window.callbackEndpoint = function(data) {
                return handleCallback(data);
            };
        }
        
        // Para desarrollo: función de prueba del callback
        window.testCallback = function(message) {
            const testData = {
                message: message || 'Mensaje de prueba del callback',
                topic: currentTopic
            };
            return handleCallback(testData);
        };
        
        function addPropertiesMessage(properties) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant with-properties';
            messageDiv.classList.add('recent-callback');
            
            const propertiesContainer = document.createElement('div');
            propertiesContainer.className = 'properties-container';
            
            properties.forEach((property, index) => {
                const thumbnail = document.createElement('div');
                thumbnail.className = 'property-thumbnail';
                thumbnail.onclick = () => openPropertyModal(property, index);
                
                const img = document.createElement('img');
                img.src = property.thumbnail;
                img.alt = property.title;
                
                thumbnail.appendChild(img);
                propertiesContainer.appendChild(thumbnail);
            });
            
            messageDiv.appendChild(propertiesContainer);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Guardar en conversación
            currentConversation.push({
                text: '[Propiedades mostradas]',
                sender: 'assistant',
                timestamp: new Date().toISOString(),
                properties: properties
            });
            
            saveConversationToSupabase();

            // Guardar property_ids de las propiedades mostradas
            properties.forEach(property => {
                if (property.property_id && !shownProperties.includes(property.property_id)) {
                    shownProperties.push(property.property_id);
                }
            });

            console.log('Properties added to conversation:', properties.length, 'properties');
            console.log('Current conversation length:', currentConversation.length);
            console.log('All shown properties:', shownProperties);
        }
        
       // Mostrar propiedades del historial sin duplicar
        function addPropertiesMessageFromHistory(properties) {
            const messagesContainer = document.getElementById('chatMessages');
            
            // Marcar todos los mensajes existentes como antiguos
            const existingMessages = messagesContainer.querySelectorAll('.message:not(.loading-message)');
            existingMessages.forEach(msg => {
                if (!msg.classList.contains('old')) {
                    msg.classList.add('old');
                }
            });
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant with-properties';
            
            const propertiesContainer = document.createElement('div');
            propertiesContainer.className = 'properties-container';
            
            properties.forEach((property, index) => {
                const uniqueIndex = Date.now() + index; // Índice único para evitar conflictos
                const thumbnail = document.createElement('div');
                thumbnail.className = 'property-thumbnail';
                thumbnail.onclick = () => openPropertyModal(property, uniqueIndex);
                
                const img = document.createElement('img');
                img.src = property.thumbnail;
                img.alt = property.title;
                
                thumbnail.appendChild(img);
                propertiesContainer.appendChild(thumbnail);
            });
            
            messageDiv.appendChild(propertiesContainer);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function openPropertyModal(property, index) {
            const modal = document.createElement('div');
            modal.className = 'property-modal';
            modal.id = 'propertyModal';
            window.currentPropertyId = property.property_id;
            
            modal.innerHTML = `
                <div class="property-card">
                    <button class="property-close" onclick="closePropertyModal()">×</button>
                    <div class="property-title">${property.title}</div>
                    <div class="property-price">${formatPrice(property.price)}</div>
                    
                    <div class="property-images">
                        <div class="property-carousel" id="carousel-${index}">
                            ${property.images.map((img, imgIndex) => 
                                `<img src="${img}" alt="${property.title}" ${imgIndex === 0 ? 'class="active"' : ''} onclick="openImageZoom('${img}')" style="cursor: zoom-in;">`
                            ).join('')}
                            ${property.images.length > 1 ? `
                                <button class="carousel-nav carousel-prev" onclick="changeImage(${index}, -1)">‹</button>
                                <button class="carousel-nav carousel-next" onclick="changeImage(${index}, 1)">›</button>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="property-details">
                        <div class="property-specs">
                            <div class="property-spec">🛏️ ${property.rooms} habitaciones</div>
                            <div class="property-spec">🚿 ${property.bathrooms} baños</div>
                            <div class="property-spec">📏 ${property.size} m²</div>
                            <div class="property-spec">🏢 Planta ${property.floor}</div>
                        </div>
                    </div>
                    
                    <button class="property-info-button" onclick="requestMoreInfo(\`${property.title}\`)">
                        Más información
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'flex';
            
            // Store current image index
            window.currentImageIndex = window.currentImageIndex || {};
            window.currentImageIndex[index] = 0;
        
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closePropertyModal();
                }
            });
        }
        
        function closePropertyModal() {
            const modal = document.getElementById('propertyModal');
            if (modal) {
                modal.remove();
            }

            // Cerrar modal con tecla Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closePropertyModal();
                }
            });
        }
        
        function changeImage(propertyIndex, direction) {
            const carousel = document.getElementById(`carousel-${propertyIndex}`);
            const images = carousel.querySelectorAll('img');
            
            if (!window.currentImageIndex) window.currentImageIndex = {};
            
            images[window.currentImageIndex[propertyIndex]].classList.remove('active');
            
            window.currentImageIndex[propertyIndex] += direction;
            
            if (window.currentImageIndex[propertyIndex] >= images.length) {
                window.currentImageIndex[propertyIndex] = 0;
            } else if (window.currentImageIndex[propertyIndex] < 0) {
                window.currentImageIndex[propertyIndex] = images.length - 1;
            }
            
            images[window.currentImageIndex[propertyIndex]].classList.add('active');
        }
        
        function formatPrice(price) {
            return new Intl.NumberFormat('es-ES', {
                style: 'currency',
                currency: 'EUR',
                maximumFractionDigits: 0
            }).format(price);
        }
        
        function requestMoreInfo(propertyTitle) {
            closePropertyModal();
            showContactInfoPopup(propertyTitle);
        }

        // Función para activar el modo test y simular estado de callback pendiente
        window.activateTestMode = function(sessionId) {
            if (!sessionId) {
                console.error('Se necesita un session_id para activar el modo test');
                return false;
            }
            
            // Activar estado de test
            currentSessionId = sessionId;
            pendingCallback = true;
            
            // Si no hay conversación activa, crear una mínima
            if (!currentConversation || currentConversation.length === 0) {
                currentConversation = [
                    {
                        text: 'Hola, soy Luci. ¿Con qué te puedo ayudar?',
                        sender: 'assistant',
                        timestamp: new Date().toISOString()
                    },
                    {
                        text: 'Buscar propiedades para comprar',
                        sender: 'user',
                        timestamp: new Date().toISOString()
                    }
                ];
                
                // Mostrar chat screen si no está visible
                if (document.getElementById('welcomeScreen').style.display !== 'none') {
                    showChatScreen();
                    // Mostrar los mensajes
                    const messagesContainer = document.getElementById('chatMessages');
                    messagesContainer.innerHTML = '';
                    currentConversation.forEach(msg => {
                        addMessage(msg.text, msg.sender, false);
                    });
                }
            }

            console.log(`Modo test activado para sesión: ${sessionId}`);
            console.log(`Callback pendiente: ${pendingCallback}`);
            return true;
        };
        
        // Función para desactivar el modo test
        window.deactivateTestMode = function() {
            pendingCallback = false;
            console.log('Modo test desactivado');
        };
        
        // Función combinada para test completo
        window.fullTestCallback = function(sessionId, testData) {
            console.log('=== INICIANDO TEST COMPLETO ===');
            
            // Activar modo test
            if (!window.activateTestMode(sessionId)) {
                return { success: false, message: 'No se pudo activar el modo test' };
            }
            
            // Simular datos de test si no se proporcionan
            const defaultTestData = {
                session_id: sessionId,
                message: "¡Claro Pablo! Aquí tienes tus propiedades!",
                properties: [
                    {
                        title: "Piso en calle Goya",
                        thumbnail: "https://img4.idealista.com/blur/WEB_DETAIL_TOP-XL-P/0/id.pro.es.image.master/e9/3a/4c/1340892243.webp",
                        price: 310000,
                        floor: "6",
                        size: 79,
                        rooms: 2,
                        bathrooms: 1,
                        images: [
                            "https://img4.idealista.com/blur/WEB_DETAIL_TOP-XL-P/0/id.pro.es.image.master/e9/3a/4c/1340892243.webp",
                            "https://img4.idealista.com/blur/WEB_DETAIL-XL-P/0/id.pro.es.image.master/c1/2d/8c/1340892242.webp"
                        ]
                    },
                    {
                        title: "Ático en Salamanca",
                        thumbnail: "https://img4.idealista.com/blur/WEB_DETAIL_TOP-XL-P/0/id.pro.es.image.master/12/34/56/1340892244.webp",
                        price: 450000,
                        floor: "7",
                        size: 95,
                        rooms: 3,
                        bathrooms: 2,
                        images: [
                            "https://img4.idealista.com/blur/WEB_DETAIL_TOP-XL-P/0/id.pro.es.image.master/12/34/56/1340892244.webp"
                        ]
                    }
                ]
            };
            
            const dataToUse = testData || defaultTestData;
            
            // Ejecutar callback
            const result = handleCallback(dataToUse);
            
            console.log('=== RESULTADO DEL TEST ===');
            console.log('Resultado:', result);
            console.log('Estado pendingCallback después del test:', pendingCallback);
            
            return result;
        };

                
        
        // Función para mostrar popup de timeout
        function showTimeoutPopup() {
            // Verificar si ya se mostró popup para esta sesión
            if (shownTimeoutPopups.has(currentSessionId)) {
                return;
            }
            
            // Verificar si ya existe un popup visible
            if (document.getElementById('timeoutPopup')) {
                return;
            }
            
            // Marcar esta sesión como que ya mostró popup
            shownTimeoutPopups.add(currentSessionId);

            // Obtener textos en el idioma actual
            const texts = translations[currentLanguage];
            
            // Obtener el título de la conversación para personalizar el mensaje
            const searchContext = currentConversationTitle || currentTopic || 'tu búsqueda';
            
            const popup = document.createElement('div');
            popup.className = 'popup-overlay';
            popup.id = 'timeoutPopup';

            const timeoutTitle = texts.timeoutTitle.replace('{searchContext}', searchContext);
            
            popup.innerHTML = `
                <div class="popup-content">
                    <div class="popup-title">${timeoutTitle}</div>
                    <p>${texts.timeoutText}</p>
                    
                    <div class="input-with-send">
                        <input type="email" class="popup-input" id="timeoutEmail" placeholder="${texts.timeoutEmailPlaceholder}">
                        <button class="send-icon-btn" onclick="sendEmailNotification()">➤</button>
                    </div>
                    
                    <div class="popup-buttons">
                        <button class="popup-btn secondary" onclick="continueWaiting()">${texts.timeoutContinueButton}</button>
                    </div>
                </div>
            `;
                    
            document.body.appendChild(popup);
            popup.style.display = 'flex';
        }
        
        function continueWaiting() {
            const popup = document.getElementById('timeoutPopup');
            if (popup) popup.remove();
            
            // Renovar timeout por otros 4 minutos
            callbackTimeout = setTimeout(() => {
                showTimeoutPopup();
            }, 240000);
            
            // Renovar suscripción realtime
            if (currentSessionId) {
                startRealtimeSubscription(currentSessionId);
            }
        }
        
        function sendEmailNotification() {
            const email = document.getElementById('timeoutEmail').value;
            const texts = translations[currentLanguage];
            
            if (!email) {
                const alertText = currentLanguage === 'spanish' ? 'Por favor, introduce un email válido' : 
                                 currentLanguage === 'english' ? 'Please enter a valid email' : 
                                 'Veuillez entrer un email valide';
                alert(alertText);
                return;
            }
            
            // Validar formato de email básico
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                const alertText = currentLanguage === 'spanish' ? 'Por favor, introduce un email válido' : 
                                 currentLanguage === 'english' ? 'Please enter a valid email' : 
                                 'Veuillez entrer un email valide';
                alert(alertText);
                return;
            }
            
            console.log('Enviando notificación de timeout a:', email);
            
            // Preparar datos para el webhook según el formato especificado
            const webhookData = {
                session_id: currentSessionId || 'unknown',
                nombre: 'Timeout',
                contact_method: 'email',
                phone_or_email: email,
                liked_property: 'no_properties',
                all_shown_properties: []
            };
            
            // Enviar webhook
            fetch('https://luci-aura.app.n8n.cloud/webhook/5da544a2-525c-44d4-8647-3efac12a9e99', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(webhookData)
            })
            .then(response => {
                console.log('Webhook de timeout enviado exitosamente');
                if (!response.ok) {
                    console.warn('Respuesta del webhook no OK:', response.status);
                }
            })
            .catch(error => {
                console.error('Error enviando webhook de timeout:', error);
                // Intentar con FormData como fallback
                const formData = new FormData();
                formData.append('session_id', webhookData.session_id);
                formData.append('nombre', webhookData.nombre);
                formData.append('contact_method', webhookData.contact_method);
                formData.append('phone_or_email', webhookData.phone_or_email);
                formData.append('liked_property', webhookData.liked_property);
                formData.append('all_shown_properties', JSON.stringify(webhookData.all_shown_properties));
                
                fetch('https://luci-aura.app.n8n.cloud/webhook/5da544a2-525c-44d4-8647-3efac12a9e99', {
                    method: 'POST',
                    mode: 'no-cors',
                    body: formData
                })
                .then(() => {
                    console.log('Webhook de timeout enviado con FormData (fallback)');
                })
                .catch(fallbackError => {
                    console.error('Error en fallback del webhook de timeout:', fallbackError);
                });
            });
            
            // Cerrar popup
            const popup = document.getElementById('timeoutPopup');
            if (popup) popup.remove();
            
            // Mostrar mensaje al usuario
            addMessage(texts.timeoutEmailSent, 'assistant');
        }
        
        // Función para mostrar popup de información de contacto
        function showContactInfoPopup(propertyTitle) {
            const popup = document.createElement('div');
            popup.className = 'popup-overlay';
            popup.id = 'contactInfoPopup';
            
            popup.innerHTML = `
                <div class="popup-content">
                    <div class="popup-title">¡Gracias por tu interés en esta propiedad!</div>
                    <p>Te enviaremos los datos completos al método de envío que selecciones a continuación</p>
                    
                    <input type="text" class="popup-input" id="userName" placeholder="Tu nombre">
                    
                    <p style="margin: 20px 0 10px 0;">Elige entre estos dos métodos de envío:</p>
                    
                    <div class="contact-method-buttons">
                        <button class="contact-method-btn" id="whatsappBtn" onclick="selectContactMethod('whatsapp')">WhatsApp</button>
                        <button class="contact-method-btn" id="emailBtn" onclick="selectContactMethod('email')">Email</button>
                    </div>
                    
                    <div id="contactInput" style="display: none;">
                        <div class="input-with-send">
                            <input type="text" class="popup-input" id="contactValue" placeholder="">
                            <button class="send-icon-btn" onclick="sendContactInfo('${propertyTitle}')">➤</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(popup);
            popup.style.display = 'flex';
            
            // Cerrar con click fuera
            popup.addEventListener('click', function(e) {
                if (e.target === popup) {
                    popup.remove();
                }
            });
        }
        
        function selectContactMethod(method) {
            const whatsappBtn = document.getElementById('whatsappBtn');
            const emailBtn = document.getElementById('emailBtn');
            const contactInput = document.getElementById('contactInput');
            const contactValue = document.getElementById('contactValue');
            
            // Resetear selección
            whatsappBtn.classList.remove('selected');
            emailBtn.classList.remove('selected');
            
            // Seleccionar método
            if (method === 'whatsapp') {
                whatsappBtn.classList.add('selected');
                contactValue.placeholder = 'Tu número de WhatsApp';
                contactValue.type = 'tel';
            } else {
                emailBtn.classList.add('selected');
                contactValue.placeholder = 'Tu email';
                contactValue.type = 'email';
            }
            
            contactInput.style.display = 'block';
        }
        
        function sendContactInfo(propertyTitle) {
            const name = document.getElementById('userName').value;
            const contactValue = document.getElementById('contactValue').value;
            const method = document.getElementById('whatsappBtn').classList.contains('selected') ? 'whatsapp' : 'email';
            
            if (!name || !contactValue) {
                alert('Por favor, completa todos los campos');
                return;
            }
            
            // Preparar datos para el webhook en formato FormData
            const formData = new FormData();
            formData.append('session_id', currentSessionId);
            formData.append('nombre', name);
            formData.append('contact_method', method);
            formData.append('phone_or_email', contactValue);
            formData.append('liked_property', window.currentPropertyId || 'unknown');
            formData.append('all_shown_properties', JSON.stringify(shownProperties));
            
            // Enviar webhook usando FormData
            fetch('https://luci-aura.app.n8n.cloud/webhook/5da544a2-525c-44d4-8647-3efac12a9e99', {
                method: 'POST',
                mode: 'no-cors',
                body: formData
            })
            .then(() => {
                console.log('Webhook de contacto enviado');
            })
            .catch(error => {
                console.error('Error enviando webhook de contacto:', error);
            });
            
            // Cerrar popup
            const popup = document.getElementById('contactInfoPopup');
            if (popup) popup.remove();
            
            // Mostrar popup de agradecimiento
            showThankYouPopup();
        }

        function showThankYouPopup() {
            // Crear popup de agradecimiento
            const popup = document.createElement('div');
            popup.className = 'popup-overlay';
            popup.id = 'thankYouPopup';
            popup.style.opacity = '0';
            popup.style.transition = 'opacity 0.3s ease-in-out';
            
            popup.innerHTML = `
                <div class="popup-content" style="text-align: center; max-width: 600px;">
                    <div class="popup-title">¡Gracias por tu interés!</div>
                    <p style="margin: 20px 0; line-height: 1.5;">
                        En breve te mandaremos la información completa por la vía que has elegido. 
                        Tardamos un máximo de 5 minutos.<br><br>
                        Si no hubieras recibido la información en este tiempo, ponte en contacto con nosotros a través de email, en 
                        <strong>info@aura-app.es</strong> o en el teléfono <strong>910 62 66 48</strong>
                    </p>
                </div>
            `;
            
            document.body.appendChild(popup);
            popup.style.display = 'flex';
            
            // Fade in
            setTimeout(() => {
                popup.style.opacity = '1';
            }, 100);
            
            // Fade out y eliminar después de 10 segundos
            setTimeout(() => {
                popup.style.opacity = '0';
                setTimeout(() => {
                    if (popup && popup.parentNode) {
                        popup.remove();
                    }
                }, 300);
            }, 10000);
            
            // Permitir cerrar con click
            popup.addEventListener('click', function(e) {
                if (e.target === popup) {
                    popup.style.opacity = '0';
                    setTimeout(() => {
                        if (popup && popup.parentNode) {
                            popup.remove();
                        }
                    }, 300);
                }
            });
        }

        function openImageZoom(imageSrc) {
            const modal = document.createElement('div');
            modal.className = 'image-zoom-modal';
            modal.innerHTML = `
                <span class="zoom-close">&times;</span>
                <img src="${imageSrc}" alt="Imagen ampliada">
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'flex';
            
            // Cerrar con click
            modal.addEventListener('click', function() {
                modal.remove();
            });
            
            // Cerrar con Escape
            const escapeHandler = function(e) {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
        }

        // Función para mostrar popup de funcionalidad no disponible
        function showNotAvailablePopup() {
            const popup = document.createElement('div');
            popup.className = 'not-available-popup';
            popup.id = 'notAvailablePopup';
            
            popup.innerHTML = `
                <div class="not-available-content">
                    <div class="not-available-title">Funcionalidad no disponible</div>
                    <p>Esta funcionalidad estará disponible próximamente.</p>
                    <button class="not-available-btn" onclick="closeNotAvailablePopup()">
                        Entendido
                    </button>
                </div>
            `;
            
            document.body.appendChild(popup);
            popup.style.display = 'flex';
            
            // Cerrar con click fuera
            popup.addEventListener('click', function(e) {
                if (e.target === popup) {
                    closeNotAvailablePopup();
                }
            });
        }
        
        function closeNotAvailablePopup() {
            const popup = document.getElementById('notAvailablePopup');
            if (popup) {
                popup.remove();
            }
        }

       

        function showWelcomeScreen() {
            const welcomeScreen = document.getElementById('welcomeScreen');
            const chatScreen = document.getElementById('chatScreen');
            
            chatScreen.style.display = 'none';
            chatScreen.classList.remove('fade-in');
            welcomeScreen.style.display = 'flex';
            welcomeScreen.classList.remove('fade-out');
        }
        
        function startNewChat() {
            // Limpiar suscripción activa
            if (realtimeChannel) {
                try {
                    supabase.removeChannel(realtimeChannel);
                    realtimeChannel.unsubscribe();
                } catch (error) {
                    console.log('Error limpiando canal en newChat:', error);
                }
                realtimeChannel = null;
            }
            
            // Resetear variables de sesión
            currentSessionId = null;
            currentConversation = [];
            currentTopic = null;
            pendingCallback = false;
            shownProperties = [];
            
            // Resetear título de conversación
            document.getElementById('conversationTitle').textContent = 'Nuevo chat';
            
            // Mostrar pantalla de bienvenida
            const welcomeScreen = document.getElementById('welcomeScreen');
            const chatScreen = document.getElementById('chatScreen');
            
            chatScreen.style.display = 'none';
            chatScreen.classList.remove('fade-in');
            welcomeScreen.style.display = 'flex';
            welcomeScreen.classList.remove('fade-out');
        
            // Limpiar mensajes
            document.getElementById('chatMessages').innerHTML = '';
        
            shownTimeoutPopups.clear();
            
            console.log('Nuevo chat iniciado');
        }
        
        function showChatInterface() {
            const welcomeScreen = document.getElementById('welcomeScreen');
            const chatScreen = document.getElementById('chatScreen');
            
            // Si ya estamos en chat, no hacer nada
            if (chatScreen.style.display === 'flex') {
                return;
            }
            
            // Si no hay conversación activa, mostrar la pantalla de bienvenida
            if (!currentConversation || currentConversation.length === 0) {
                welcomeScreen.style.display = 'flex';
                chatScreen.style.display = 'none';
            } else {
                // Si hay conversación, mostrar el chat
                welcomeScreen.style.display = 'none';
                chatScreen.style.display = 'flex';
                chatScreen.classList.add('fade-in');
            }
        }
       
        // Función para limpiar el chat
        function clearChat() {
            const messagesContainer = document.querySelector('.chat-messages');
            if (messagesContainer) {
                messagesContainer.innerHTML = '';
            }
            
            // Limpiar historial de la sesión
            window.conversationHistory = [];
        }
     
        
        // =================== POPUP CREAR CUENTA ===================
        function showLoginPopup() {
            document.getElementById('loginPopup').style.display = 'flex';
        }
        
        function closeLoginPopup() {
            document.getElementById('loginPopup').style.display = 'none';
        }

        function selectLoginMethod(method) {
            currentLoginMethod = method;
            const buttons = document.querySelectorAll('.login-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            if (method === 'whatsapp') {
                buttons[0].classList.add('active');
                document.getElementById('whatsappLogin').style.display = 'block';
                document.getElementById('emailLogin').style.display = 'none';
            } else {
                buttons[1].classList.add('active');
                document.getElementById('whatsappLogin').style.display = 'none';
                document.getElementById('emailLogin').style.display = 'block';
            }
        }
        
        // Verificar sesión existente al cargar la página
        async function checkExistingSession() {
            if (!supabase) {
                console.log('Supabase no inicializado, saltando verificación de sesión');
                return;
            }
            
            try {
                const { data: { session } } = await supabase.auth.getSession();
                
                if (session && session.user) {
                    console.log('Sesión existente encontrada:', session.user);
                    updateUserProfile(session.user);
                }
            } catch (error) {
                console.error('Error verificando sesión:', error);
            }
        }
                
        // =================== FUNCIONES SIDEBAR ===================
        function initSidebar() {
            // Obtener todas las opciones de la sidebar
            const options = document.querySelectorAll('.sidebar-option');
            
            // Manejar clicks en opciones de la sidebar
            options.forEach(option => {
                option.addEventListener('click', function() {
                    const optionName = this.dataset.option;
                    
                    if (optionName === 'propiedades') {
                        // Activar opción propiedades
                        setActiveSidebarOption('propiedades');
                        
                        // Si no hay chat activo, no hacer nada especial
                        // La funcionalidad de propiedades ya funciona con selectOption
                    } else {
                        // Para cualquier otra opción, mostrar popup de login
                        showLoginPopup();
                    }
                });
            });
            
            // Inicializar iconos correctos
            updateSidebarIcons();

            const expandArrow = document.querySelector('.expand-arrow');
            if (expandArrow) {
                expandArrow.addEventListener('click', toggleSidebar);
            }
        }
        
        // Función para expandir/contraer sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const container = document.querySelector('.container');
            
            sidebar.classList.toggle('expanded');
            container.classList.toggle('sidebar-expanded');
            
            // Actualizar tooltip del botón - LÓGICA CORREGIDA
            const expandArrow = document.querySelector('.expand-arrow');
            if (sidebar.classList.contains('expanded')) {
                expandArrow.setAttribute('data-tooltip', 'Contraer');
            } else {
                expandArrow.setAttribute('data-tooltip', 'Expandir');
            }
        }
        
        function setActiveSidebarOption(optionName) {
            // Actualizar variable global
            activeSidebarOption = optionName;
            
            // Remover clase active de todas las opciones
            document.querySelectorAll('.sidebar-option').forEach(opt => {
                opt.classList.remove('active');
            });
            
            // Añadir clase active a la opción seleccionada
            const selectedOption = document.querySelector(`[data-option="${optionName}"]`);
            if (selectedOption) {
                selectedOption.classList.add('active');
            }
            
            // Actualizar iconos
            updateSidebarIcons();
        }
        
        function updateSidebarIcons() {
            // Actualizar iconos según el estado activo/inactivo
            Object.keys(iconStates).forEach(optionName => {
                const option = document.querySelector(`[data-option="${optionName}"]`);
                const icon = option?.querySelector('.sidebar-icon');
                
                if (icon) {
                    if (optionName === activeSidebarOption) {
                        // Usar icono activo
                        icon.src = iconStates[optionName].active;
                    } else {
                        // Usar icono inactivo
                        icon.src = iconStates[optionName].inactive;
                    }
                }
            });
        }
       
        
    </script>
</body>
</html>
