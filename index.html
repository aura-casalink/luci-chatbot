<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luci - Asistente Inmobiliario</title>
    <link href="https://fonts.googleapis.com/css2?family=Graphik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
   <style>
        {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Graphik', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* =================== ÁREA PRINCIPAL =================== */
        .main-area {
            flex: 1;
            background-color: white;
            display: flex;
            flex-direction: row; /* CAMBIO CLAVE: row en lugar de column */
            position: relative;
            height: 100vh;
            overflow: hidden;
        }

       /* =================== SIDEBAR =================== */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 80px;
            height: 100vh;
            background-color: white;
            border-right: 1px solid #e9ecef;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: width 0.3s ease;
        }

       .sidebar.expanded {
            border-right: 1px solid #e9ecef;
            width: 250px;
        }

       .sidebar:not(.expanded) {
            border-right: 1px solid #e9ecef;
        }
        
        .properties-sub-sidebar.active ~ .sidebar:not(.expanded) {
            border-right: none;
        }
       
        /* Logo AURA */
        .sidebar-logo {
            padding: 1px 0;
            text-align: center;
            position: relative;
            width: 100%;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .aura-logo {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 28px;
            color: #000;
            cursor: pointer;
            position: relative;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Flecha de expandir - solo visible en hover */
        .expand-arrow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            visibility: hidden;
            background-color: #6c757d;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
            font-size: 18px;
            font-weight: bold;
            z-index: 10;
        }
        
        .sidebar-logo:hover .aura-logo {
            opacity: 0.3;
        }
        
        .sidebar-logo:hover .expand-arrow {
            opacity: 1;
            visibility: visible;
        }
        
        .expand-arrow:hover {
            background-color: #495057;
            transform: translate(-50%, -50%) scale(1.1);
        }
        
        /* Opciones de la sidebar */
        .sidebar-options {
            flex: 1;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 0 10px 0; 
            min-height: 0; 
            overflow: visible;
            max-height: calc(100vh - 85px); 
        }
       
       /* Contenedor de iconos principales */
        .sidebar-icons-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin-bottom: auto; /* Empujar hacia arriba */
        }

       /* Contenedor de botones inferiores */
        .sidebar-bottom-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin-top: auto; /* Empujar hacia abajo */
            gap: 8px; /* Espacio entre botones */
            padding-bottom: 15px; /* Espacio desde el borde inferior */
        }
        
        .sidebar-option {
            position: relative;
            width: 60px;
            height: 60px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 12px;
            transition: background-color 0.2s ease;
            flex-shrink: 0;
        }
        
        .sidebar-option:hover {
            background-color: #f8f9fa;
        }

       /* Hover para botón de login cuando sidebar expandida */
        .sidebar.expanded .sidebar-login:hover {
            background-color: #f8f9fa;
        }
        
        /* Hover para botón de nuevo chat cuando sidebar expandida */
        .sidebar.expanded .sidebar-new-chat:hover {
            background-color: #f8f9fa;
        }
        
        .sidebar-icon {
            width: 24px;
            height: 24px;
            transition: none;
        }
        
        /* Indicador de opción activa - raya negra */
        .sidebar-option.active::before {
            content: '';
            position: absolute;
            right: -40px;
            top: 50%;
            transform: translateY(-50%);
            height: 24px;
            width: 3px;
            background-color: #000;
            border-radius: 0;
        }
        
        /* Botón de login */
        .sidebar-login {
            position: relative;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            margin-bottom: 10px;
        }
        
        .login-circle {
            width: 40px;
            height: 40px;
            background-color: #FFC900;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }
        
        .login-circle:hover {
            background-color: #e6b400;
        }
        
        .login-icon {
            width: 18px;
            height: 18px;
            object-fit: contain;
        }
        
        /* Tooltip para login - usando la misma estructura que los otros */
        .sidebar-login::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 70px;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'Graphik', sans-serif;
            font-size: 14px;
            font-weight: 300;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            pointer-events: none;
        }
        
        .sidebar-login:hover::after {
            opacity: 1;
            visibility: visible;
            left: 75px;
        }
        
        .sidebar-login::before {
            content: '';
            position: absolute;
            left: 65px;
            top: 50%;
            transform: translateY(-50%);
            border: 5px solid transparent;
            border-right-color: rgba(0, 0, 0, 0.9);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            pointer-events: none;
        }
        
        .sidebar-login:hover::before {
            opacity: 1;
            visibility: visible;
            left: 70px;
        }
        
        /* Tooltips */
        .sidebar-option::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 70px;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'Graphik', sans-serif;
            font-size: 14px;
            font-weight: 300;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            pointer-events: none;
        }
        
        .sidebar-option:hover::after {
            opacity: 1;
            visibility: visible;
            left: 75px;
        }
        
        /* Flecha del tooltip */
        .sidebar-option::before {
            content: '';
            position: absolute;
            left: 65px;
            top: 50%;
            transform: translateY(-50%);
            border: 5px solid transparent;
            border-right-color: rgba(0, 0, 0, 0.9);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            pointer-events: none;
        }
        
        .sidebar-option:hover::before {
            opacity: 1;
            visibility: visible;
            left: 70px;
        }
        
        /* Sobrescribir el ::before para opción activa */
        .sidebar-option.active::before {
            content: '';
            position: absolute;
            right: -40px;
            top: 50%;
            transform: translateY(-50%);
            height: 24px;
            width: 3px;
            background-color: #000;
            border-radius: 0;
            opacity: 1;
            visibility: visible;
            border: none;
            z-index: 1001;
        }
        
        /* Tooltip para expand arrow */
        .expand-arrow::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 45px;
            top: 50%;
            transform: translateY(-50%);
            transform-origin: center center;
            will-change: opacity, visibility;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'Graphik', sans-serif;
            font-size: 14px;
            font-weight: 300;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            pointer-events: none;
        }

       /* Tooltip cuando sidebar está expandida */
        .sidebar.expanded .expand-arrow::after {
            content: "Esconder";
            transform: translateY(-50%) rotate(-180deg);
            right: 45px;
            left: auto;
        }

       .sidebar.expanded .expand-arrow::before {
            content: '';
            position: absolute;
            right: 40px;
            top: 50%;
            transform: translateY(-50%);
            border: 5px solid transparent;
            border-left-color: rgba(0, 0, 0, 0.9); /* en lugar de border-right-color */
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            pointer-events: none;
        }
                
        .sidebar.expanded .expand-arrow:hover::after {
            opacity: 1;
            visibility: visible;
            right: 50px;
            left: auto;
        }

       .sidebar.expanded .expand-arrow:hover::before {
            opacity: 1;
            visibility: visible;
            right: 45px;
            left: auto;
        }
                
        .expand-arrow:hover::after {
            opacity: 1;
            visibility: visible;
            left: 50px;
        }
        
        .expand-arrow::before {
            content: '';
            position: absolute;
            left: 40px;
            top: 50%;
            transform: translateY(-50%);
            border: 5px solid transparent;
            border-right-color: rgba(0, 0, 0, 0.9);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            pointer-events: none;
        }
        
        .expand-arrow:hover::before {
            opacity: 1;
            visibility: visible;
            left: 45px;
        }
        
        /* Ajustar container para la sidebar */
        .container.sidebar-active {
            margin-left: 80px;
            width: calc(100% - 80px);
        }

       /* Botón nuevo chat */
        .sidebar-new-chat {
            position: relative;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            margin-bottom: 5px;
        }
        
        .new-chat-circle {
            width: 40px;
            height: 40px;
            background-color: #e9ecef;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }
        
        .new-chat-circle:hover {
            background-color: #6c757d;
        }
        
        .plus-icon {
            font-size: 20px;
            font-weight: 400;
            color: #495057;
            transition: color 0.2s ease;
        }
        
        .new-chat-circle:hover .plus-icon {
            color: white;
        }

        /* Reemplaza estas reglas CSS existentes */
        .sidebar.expanded .sidebar-option,
        .sidebar.expanded .sidebar-login,
        .sidebar.expanded .sidebar-new-chat {
          justify-content: flex-start;
          padding-left: 20px;
          width: 100%;
        }
        
        .sidebar.expanded .sidebar-option .sidebar-icon,
        .sidebar.expanded .sidebar-login .login-circle,
        .sidebar.expanded .sidebar-new-chat .new-chat-circle {
          margin-left: 0;
          margin-right: 12px;
          flex-shrink: 0;
        }
        
        .sidebar.expanded .sidebar-text {
          position: static;
          transform: none;
          opacity: 1;
          visibility: visible;
          pointer-events: auto;
          display: inline-block;
          white-space: nowrap;
          font-size: 14px;
          font-weight: 500;
          color: #333;
        }
        
        /* Asegurar que los elementos estén en línea cuando expandido */
        .sidebar.expanded .sidebar-option,
        .sidebar.expanded .sidebar-login,
        .sidebar.expanded .sidebar-new-chat {
          display: flex;
          flex-direction: row;
          align-items: center;
          justify-content: flex-start;
          padding-left: 65px;
          padding-right: 30px;
          width: calc(100% - 65px);
          margin-right: 45px;
          height: 60px;
          margin-bottom: 10px; 
        }

       /* Hover específico para sidebar expandida - área más pequeña */
        .sidebar.expanded .sidebar-option:hover,
        .sidebar.expanded .sidebar-login:hover,
        .sidebar.expanded .sidebar-new-chat:hover {
            background-color: #f8f9fa;
            border-radius: 8px; /* Añadir bordes redondeados para mejor visual */
            margin-right: 15px; /* Más margen derecho */
        }

       .sidebar.expanded .sidebar-icons-container {
          padding-left: 0; /* Asegurar que no haya padding extra aquí */
        }

       .sidebar.expanded .sidebar-bottom-buttons {
          padding-left: 0; /* Asegurar que no haya padding extra aquí */
        }
        
        /* Ajustar el comportamiento específico de los iconos */
        .sidebar.expanded .sidebar-option .sidebar-icon {
          width: 24px;
          height: 24px;
          margin-right: 12px;
          flex-shrink: 0;
        }
        
        .sidebar.expanded .sidebar-login .login-circle {
          width: 40px;
          height: 40px;
          margin-right: 12px;
          flex-shrink: 0;
        }
        
        .sidebar.expanded .sidebar-new-chat .new-chat-circle {
          width: 40px;
          height: 40px;
          margin-right: 12px;
          flex-shrink: 0;
        }

       .sidebar.expanded .sidebar-option.active .sidebar-text {
            font-weight: 600;
        }

       /* Ocultar la "A" cuando está expandida */
        .sidebar.expanded .aura-logo {
            display: none;
        }
        
        /* Mostrar "AURA" cuando está expandida */
        .sidebar.expanded .sidebar-logo::after {
            content: "AURA";
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 28px;
            color: #000;
            padding-left: 30px; 
            padding-right: 20px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            width: 100%;
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
        }
        
        /* Ajustar el contenedor del logo cuando está expandido */
        .sidebar.expanded .sidebar-logo {
            justify-content: flex-start;
            padding-left: 0;
        }
       
       /* Tooltip para nuevo chat */
        .sidebar-new-chat::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 70px;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'Graphik', sans-serif;
            font-size: 14px;
            font-weight: 300;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            pointer-events: none;
        }
        
        .sidebar-new-chat:hover::after {
            opacity: 1;
            visibility: visible;
            left: 75px;
        }
        
        /* Flecha del tooltip para nuevo chat */
        .sidebar-new-chat::before {
            content: '';
            position: absolute;
            left: 65px;
            top: 50%;
            transform: translateY(-50%);
            border: 5px solid transparent;
            border-right-color: rgba(0, 0, 0, 0.9);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            pointer-events: none;
        }
        
        .sidebar-new-chat:hover::before {
            opacity: 1;
            visibility: visible;
            left: 70px;
        }

       /* Sidebar expandido */
        .sidebar.expanded {
            width: 250px;
            transition: width 0.3s ease;
        }
        
        .sidebar {
            transition: width 0.3s ease;
        }
        
        /* Contenedor principal cuando sidebar está expandido */
        .container.sidebar-expanded {
            margin-left: 250px;
            width: calc(100% - 250px);
            transition: margin-left 0.3s ease, width 0.3s ease;
        }
        
        .container {
            transition: margin-left 0.3s ease, width 0.3s ease;
        }
        
        /* Texto de las opciones del sidebar (oculto por defecto) */
        .sidebar-text {
            position: absolute;
            left: 90px;
            top: 50%;
            transform: translateY(-50%);
            font-family: 'Graphik', sans-serif;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            white-space: nowrap;
            pointer-events: none;
        }
        
        /* Mostrar texto cuando sidebar está expandido */
        .sidebar.expanded .sidebar-text {
            opacity: 1;
            visibility: visible;
            left: 95px;
        }
        
        /* Ocultar tooltips cuando sidebar está expandido */
        .sidebar.expanded .sidebar-option::after,
        .sidebar.expanded .sidebar-option::before,
        .sidebar.expanded .sidebar-login::after,
        .sidebar.expanded .sidebar-login::before,
        .sidebar.expanded .sidebar-new-chat::after,
        .sidebar.expanded .sidebar-new-chat::before {
            opacity: 0 !important;
            visibility: hidden !important;
        }
        
        /* Botón de colapsar cuando está expandida */
        .sidebar.expanded .expand-arrow {
            position: absolute;
            left: 200px; /* Posición específica desde la izquierda */
            top: 50%;
            transform: translateY(-50%) rotate(180deg);
            opacity: 0;
            visibility: hidden;
            background-color: #f8f9fa;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #495057;
            font-size: 18px;
            font-weight: bold;
            z-index: 10;
        }

       /* Mostrar botón solo en hover sobre la línea del logo */
        .sidebar.expanded .sidebar-logo:hover .expand-arrow {
            opacity: 1;
            visibility: visible;
        }
        
        /* Hover del botón */
        .sidebar.expanded .expand-arrow:hover {
            background-color: #495057; /* Mismo color que la flecha original en hover */
            color: white;
            transform: translateY(-50%) rotate(180deg) scale(1.1);
        }
        
        /* Click del botón */
        .sidebar.expanded .expand-arrow:active {
            background-color: #6c757d;
            color: white;
            transform: translateY(-50%) rotate(180deg) scale(0.95);
        }
        
        /* Ajustar el contenedor del logo para permitir hover */
        .sidebar.expanded .sidebar-logo {
            position: relative;
            justify-content: flex-start;
            padding-left: 0;
            width: 250px; /* Ancho específico del sidebar expandido */
            height: 65px;
        }
     
       
       /* =================== PANTALLA DE BIENVENIDA =================== */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 40px;
            opacity: 1;
            transition: opacity 0.3s ease-out;
        }

        .welcome-screen.fade-out {
            opacity: 0;
        }

        .welcome-title {
            font-family: 'Graphik', sans-serif;
            font-weight: bold;
            font-size: 32px;
            color: black;
            margin-bottom: 40px;
            text-align: center;
        }

        .buttons-container {
            background-color: #fbfcfd;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .option-button {
            flex: 1;
            min-width: 300px;
            padding: 15px 20px;
            background-color: white;
            color: #b8c1c8;
            border: 1px solid #ddd;
            border-radius: 12px;
            font-family: 'Graphik', sans-serif;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        /* Botón principal (comprar propiedades) - siempre destacado */
        .option-button.primary {
            background-color: #f8f9fa;
            border-color: #007bff;
            color: black;
            font-weight: normal;
        }
        
        /* Hover del botón principal */
        .option-button.primary:hover {
            transform: scale(1.05);
            font-weight: bold;
            border-color: #FFC900; 
            box-shadow: 0 2px 8px rgba(218, 165, 32, 0.3);
        }
        
        /* Botones secundarios - sin hover */
        .option-button:not(.primary):hover {
            /* Sin cambios en hover */
        }
        
        .option-button:last-child {
            margin-bottom: 0;
        }

       /* Añadir después de las reglas existentes de welcome-screen */
        .welcome-subtitle {
            font-family: 'Graphik', sans-serif;
            font-weight: normal;
            font-size: 18px;
            color: #666;
            margin-bottom: 40px;
            text-align: center;
            line-height: 1.4;
            max-width: 600px;
        }
        
        .welcome-chat-input-container {
            width: 100%;
            max-width: 600px;
            padding: 0 20px;
        }
        
        .welcome-chat-input-container .chat-input-wrapper {
            display: flex;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 25px;
            padding: 5px;
            align-items: flex-end;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 100%;
        }
        
        .welcome-chat-input-container .chat-input {
            flex: 1;
            border: none;
            outline: none;
            padding: 15px 20px;
            font-size: 16px;
            font-family: 'Graphik', sans-serif;
            border-radius: 20px;
            resize: none;
            max-height: 120px;
            min-height: 80px;
            width: 100%;
        }
        
        .welcome-chat-input-container .send-button {
            background-color: #edf2f4;
            color: #333;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-right: 5px;
            margin-bottom: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        
        .welcome-chat-input-container .send-button:hover {
            background-color: #d1d9db;
        }
        
        .welcome-chat-input-container .send-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
       
        /* Contenedor para el typing placeholder */
        .typing-placeholder {
            position: absolute;
            left: 20px;
            top: 20%;
            transform: translateY(-50%);
            color: #999;
            font-family: 'Graphik', sans-serif;
            font-size: 16px;
            pointer-events: none;
            z-index: 1;
            white-space: nowrap;
            overflow: hidden;
        }
        
        .typing-placeholder.typing::after {
            content: '|';
            animation: blink 1s infinite;
            color: #333;
            position: relative;
            top: -2px; /* Hacer el cursor un poco más alto */
            font-weight: normal;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Mostrar placeholder cuando el input está vacío y no tiene foco */
        .welcome-chat-input-container .chat-input:focus ~ .typing-placeholder {
            display: none;
        }
        
        /* Ocultar placeholder cuando hay texto */
        .welcome-chat-input-container .chat-input:not(:placeholder-shown) ~ .typing-placeholder {
            display: none;
        }
        
        /* Estilos para la transición del bubble */
        .message-bubble-transition {
            position: fixed;
            background-color: #edf2f4;
            border-radius: 18px;
            border-bottom-right-radius: 4px;
            padding: 12px 18px;
            font-family: 'Graphik', sans-serif;
            font-size: 16px;
            color: #333;
            z-index: 10000;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 70%;
            word-wrap: break-word;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* Overlay durante la transición */
        .transition-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .transition-overlay.active {
            opacity: 1;
        }
        
        /* Ajustar el input wrapper para posición relativa */
        .welcome-chat-input-container .chat-input-wrapper {
            position: relative;
        }

       /* Transición del input completo */
        .input-transition {
            position: fixed;
            z-index: 10000;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 25px;
            padding: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .input-transition textarea {
            flex: 1;
            border: none;
            outline: none;
            padding: 15px 20px;
            font-size: 16px;
            font-family: 'Graphik', sans-serif;
            border-radius: 20px;
            resize: none;
            background: transparent;
            width: 100%;
        }
        
        .input-transition .send-button {
            background-color: #edf2f4;
            color: #333;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-right: 5px;
            margin-bottom: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }

       /* =================== SELECTOR DE IDIOMA =================== */
        .language-selector {
            position: absolute;
            top: 20px;
            right: 20px;
            display: none;
            gap: 10px;
        }
        
        .flag-btn {
            width: 32px;
            height: 24px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            opacity: 0.6;
            border: 2px solid transparent;
        }
        
        .flag-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        
        .flag-btn.active {
            opacity: 1;
            border: 2px solid #007bff;
        }

        /* =================== PANTALLA DE CHAT =================== */
        .chat-screen {
            display: none;
            flex-direction: column;
            height: 100%;
            opacity: 0;
            transition: opacity 0.3s ease-in;
        }

        .chat-screen.fade-in {
            opacity: 1;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: none;
        }

        .chat-title {
            font-family: 'Graphik', sans-serif;
            font-weight: bold;
            font-size: 24px;
            color: black;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .message {
            max-width: 70%;
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 18px;
            word-wrap: break-word;
            font-family: 'Graphik', sans-serif;
        }

        .message.assistant {
            background-color: white;
            border: 1px solid #ddd;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .message.user {
            background-color: #edf2f4;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.error {
            background-color: #fee;
            color: #c53030;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .message.old {
            color: #888;
            filter: grayscale(0.7) opacity(0.8);
        }

        .chat-input-container {
            padding: 30px;
            border-top: 1px solid #eee;
            width: calc(100% - 20px); /* Cambio: restar el margin-right de chat-column */
            max-width: none; /* Asegurar que no se extienda más allá */
            position: relative; /* Cambio: de static a relative */
            box-sizing: border-box; /* Añadido: incluir padding en el width */
        }

        .chat-input-wrapper {
            display: flex;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 25px;
            padding: 5px;
            align-items: flex-end;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 100%;
        }

        .chat-input {
            flex: 1;
            border: none;
            outline: none;
            padding: 15px 20px;
            font-size: 16px;
            font-family: 'Graphik', sans-serif;
            border-radius: 20px;
            resize: none;
            max-height: 120px;
            min-height: 80px;
            width: 100%;
        }

        .send-button {
            background-color: #edf2f4;
            color: #333;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-right: 5px;
            margin-bottom: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }

        .send-button:hover {
            background-color: #d1d9db;
        }

        .send-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

       /* =================== DISCLAIMER =================== */
        .disclaimer {
            text-align: center;
            font-size: 12px;
            color: #888;
            margin-top: 10px;
            font-family: 'Graphik', sans-serif;
        }
        
        .beta-badge {
            background-color: rgba(147, 51, 234, 0.1);
            color: #9333ea;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        } 
               

        /* =================== MODAL DE ZOOM PARA IMÁGENES =================== */
        .image-zoom-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            cursor: zoom-out;
        }
        
        .image-zoom-modal img {
            max-width: 95vw;
            max-height: 95vh;
            object-fit: contain;
            cursor: zoom-out;
        }
        
        .zoom-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            cursor: pointer;
            z-index: 2001;
        }

        
        /* =================== POP-UPS =================== */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .popup-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        
        .popup-title {
            font-family: 'Graphik', sans-serif;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 20px;
            color: black;
        }
        
        .popup-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Graphik', sans-serif;
            margin: 10px 0;
            font-size: 16px;
        }
        
        .popup-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .popup-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-family: 'Graphik', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .popup-btn.primary {
            background-color: #007bff;
            color: white;
        }
        
        .popup-btn.secondary {
            background-color: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
        }
        
        .popup-btn:hover {
            transform: translateY(-1px);
        }
        
        .contact-method-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }
        
        .contact-method-btn {
            padding: 10px 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .contact-method-btn.selected {
            border-color: #007bff;
            background-color: #e3f2fd;
        }
        
        .input-with-send {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 15px;
        }
        
        .input-with-send input {
            flex: 1;
        }
        
        .send-icon-btn {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }


        /* Atenuar emojis en mensajes antiguos */
        .message.old {
            color: #888;
            filter: grayscale(0.7) opacity(0.8);
        }

        
        /* Popup de funcionalidad no disponible */
        .not-available-popup {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .not-available-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        
        .not-available-title {
            font-family: 'Graphik', sans-serif;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 15px;
            color: black;
        }
        
        .not-available-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-family: 'Graphik', sans-serif;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            margin-top: 15px;
        }
        

       /* =================== POPUP CREAR CUENTA =================== */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .popup-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 450px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .popup-title {
            font-family: 'Graphik', sans-serif;
            font-weight: 600;
            font-size: 24px;
            color: #333;
            margin-bottom: 10px;
        }
        
        .popup-subtitle {
            font-family: 'Graphik', sans-serif;
            font-size: 16px;
            color: #666;
            margin-bottom: 30px;
        }
        
        .login-method {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .login-btn {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #ddd;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Graphik', sans-serif;
            font-size: 14px;
        }
        
        .login-btn:hover {
            border-color: #007bff;
            background: #f8f9ff;
        }
        
        .login-btn.active {
            border-color: #000;
            background: #000;
            color: white;
        }
        
        .phone-input, .email-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 15px;
            font-family: 'Graphik', sans-serif;
        }
        
       .send-code-btn {
            width: 100%;
            padding: 15px;
            background: #000;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
            font-family: 'Graphik', sans-serif;
            font-weight: 500;
        }
        
        .popup-close {
            position: absolute;
            top: 15px;
            left: 15px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .popup-close:hover {
            background: #f0f0f0;
            color: #333;
        }

       /* =================== LAYOUT DE DOS COLUMNAS =================== */
        .chat-column {
            flex: 0 0 50%; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: white;
            margin-right: 10px; 
            position: relative; 
        }
        
        .properties-column {
            flex: 0 0 calc(50% + 2px); 
            background-color: #f5f5f5;
            border-radius: 15px;
            margin: 0 15px 15px 0;
            overflow: visible;
            min-height: calc(100vh - 73px); 
            max-height: calc(100vh - 73px);
            position: relative; 
            top: -2px; 
        }
        
        /* =================== MOSAICO DE PROPIEDADES =================== */
        .properties-grid {
            padding: 15px;
            height: 100%;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            overflow: hidden;
        }
        
        .properties-header {
            margin-bottom: 15px;
            text-align: center;
            flex-shrink: 0;
            height: 30px; /* Altura fija para el header */
        }
        
        .properties-header h3 {
            margin: 0;
            color: #333;
            font-size: 16px;
            font-weight: 600;
            line-height: 30px;
        }
        
        .grid-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 16px; /* Cambio: más espacio entre propiedades (era 12px) */
            width: 100%;
            height: calc(100% - 45px);
            box-sizing: border-box;
            align-items: stretch;
            justify-items: stretch;
        }
        
        .property-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
            position: relative;
            padding: 4px;
        }
        
        .property-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10;
        }
        
        .property-card.placeholder {
            opacity: 0.7;
        }
        
        .property-image {
            height: 75%; /* Aumentar de 70% a 75% */
            background-color: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
            border-radius: 6px; /* Mantener esquinas redondeadas */
            position: relative; /* Para posicionar los iconos */
        }
        
        .placeholder-image {
            font-size: 24px;
            color: #6c757d;
        }
        
        .property-info {
            height: 25%; /* Reducir de 30% a 25% */
            padding: 6px 4px; /* Reducir padding */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            flex-shrink: 0;
            box-sizing: border-box;
        }
        
        .property-price {
            font-weight: 600;
            color: #333;
            font-size: 14px; /* Doble de grande: era 11px */
            text-align: left; /* Alineado a la izquierda */
            margin: 0;
        }
        
        .property-location {
            color: #666;
            font-size: 11px; /* Más grande: era 9px */
            text-align: left; /* Alineado a la izquierda */
            margin: 0;
            line-height: 1.2;
        }
        
        /* Iconos de amenities */
        .amenities-icons {
            position: absolute;
            top: 6px;
            right: 6px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            z-index: 5;
        }
        
        .amenity-icon {
            width: 22px;
            height: 22px;
            background-color: #FFC900;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            padding: 3px;
        }
        
        .amenity-icon img {
            width: 12px;
            height: 12px;
            filter: brightness(0); /* Hace los iconos negros */
        }

      /* =================== TARJETA DESLIZANTE DE PROPIEDAD =================== */
        .property-slide-card {
            position: fixed;
            top: 0; 
            left: 100%;
            width: calc(50% - 40px);
            height: 100vh;
            background: white;
            z-index: 1005;
            transition: left 0.3s ease-in-out;
            overflow-y: auto;
            border-radius: 15px;
            box-shadow: -8px 0 20px rgba(0,0,0,0.15);
        }
        
        .property-slide-card.active {
            left: calc(50vw + 40px);
        }

       .container.sidebar-expanded .property-slide-card.active {
            left: calc(50vw + 125px);
       }

       .container.sidebar-expanded .property-slide-card {
            width: calc(50vw - 125px);
       }
        
        .property-slide-content {
            padding: 20px;
            height: 100%;
            box-sizing: border-box;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto auto auto auto auto 1fr auto;
            gap: 15px;
            grid-template-areas: 
                "header map"
                "location map" 
                "price map"
                "specs map"
                "contact-btn map"
                "carousel carousel"
                "description description"
                "feedback feedback";
        }

       .container.sidebar-expanded .property-slide-content {
            grid-template-columns: 1fr 0.8fr; 
            gap: 10px; 
        }
        
        .property-slide-close {
            position: absolute;
            top: 10px;
            left: 10px;
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 21;
            transition: all 0.2s;
        }
        
        .property-slide-close:hover {
            background: rgba(211, 211, 211, 0.3);
            transform: scale(1.1);
        }
        
        .property-slide-header {
            grid-area: header;
            margin-top: 25px;
            margin-bottom: -5px; /* Cambio: de 5px a -5px para reducir más el espacio */
        }
        
        .property-slide-title {
            font-family: 'Graphik', sans-serif;
            font-weight: bold;
            font-size: 22px;
            margin: 0;
            color: #333;
            text-align: left;
        }
        
        .property-slide-location-area {
            grid-area: location;
            margin-top: -10px; /* Cambio: de -5px a -10px para acercarlo más */
        }
                
        .property-slide-location {
            font-size: 14px;
            color: #888;
            margin: 0;
            text-align: left;
        }
        
        .property-slide-price-area {
            grid-area: price;
        }
        
        .property-slide-price {
            font-size: 24px;
            color: #333;
            font-weight: bold;
            margin: 0 0 4px 0;
            text-align: left;
        }
        
        .property-slide-price-per-sqm {
            font-size: 14px;
            color: #aaa;
            margin: 0;
            text-align: left;
        }
        
        .price-comparison {
            font-size: 12px;
            margin-top: 2px;
            font-weight: 500;
        }

       .price-percentage {
            color: #dc2626; /* Rojo para el porcentaje */
            font-weight: 600;
        }

       .price-comparison-text {
            color: #aaa;
        }
        
        .price-comparison.above-average {
            color: #dc2626; /* Rojo para "por encima" */
        }
        
        .price-comparison.below-average {
            color: #22c55e; /* Verde para "por debajo" */
        }
        
        .price-comparison.neutral {
            color: #888; /* Gris para el resto */
        }
        
        .property-slide-specs-area {
            grid-area: specs;
        }
        
        .property-slide-specs {
            margin: 0;
        }
        
        .property-slide-spec {
            font-size: 13px;
            color: #aaa;
            margin-bottom: 3px;
            line-height: 1.3;
        }
        
        .contact-sales-btn {
            grid-area: contact-btn;
            background-color: #FFC900;
            color: #333;
            border: none;
            padding: 10px 16px; /* Doble de grande: era 8px 12px */
            border-radius: 6px;
            font-family: 'Graphik', sans-serif;
            font-size: 16px; /* Doble de grande: era 11px */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            align-self: start;
            width: fit-content;
            margin-top: 8px;
        }
        
        .contact-sales-btn:hover {
            background-color: #e6b400;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(255, 201, 0, 0.3);
        }
        
        .property-slide-map {
            grid-area: map;
            height: 100%; /* Ocupar toda la altura del área del grid */
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #ddd;
            align-self: stretch; /* Asegurar que se estire por toda el área */
        }
        
        .property-slide-carousel-area {
            grid-area: carousel;
            margin-top: 2px; /* Más pegado al botón */
        }
        
        .property-slide-carousel {
            width: 100%;
            height: 200px;
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background: #f5f5f5;
        }
        
        .property-slide-carousel img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
            cursor: zoom-in;
        }
        
        .property-slide-carousel img.active {
            display: block;
        }
        
        .slide-carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        
        .slide-carousel-nav:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }
        
        .slide-carousel-prev {
            left: 10px;
        }
        
        .slide-carousel-next {
            right: 10px;
        }
        
        .property-slide-description-area {
            grid-area: description;
        }
        
        .description-title {
            font-family: 'Graphik', sans-serif;
            font-weight: bold;
            font-size: 16px;
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .property-slide-description {
            font-size: 14px;
            line-height: 1.5;
            color: #666;
            text-align: justify;
            margin: 0;
        }
        
        .property-feedback-area {
            grid-area: feedback;
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
        }
        
        .feedback-question {
            font-family: 'Graphik', sans-serif;
            font-weight: bold;
            font-size: 14px;
            margin: 0;
            color: #333;
            display: inline-block;
            margin-right: 15px;
        }
        
        .feedback-buttons {
            display: inline-flex;
            gap: 15px;
            align-items: center;
        }
        
        .feedback-btn {
            background: none;
            border: 2px solid #ddd;
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s;
            opacity: 0.6;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .feedback-btn:hover {
            opacity: 1;
            transform: scale(1.05);
            border-color: #999;
        }
        
        .feedback-btn.selected {
            opacity: 1;
            border-color: #FFC900;
            background-color: rgba(255, 201, 0, 0.1);
        }
        
        /* Indicador de posición del carrousel */
        .carousel-indicators {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 10px;
        }
        
        .carousel-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #ddd;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .carousel-dot.active {
            background-color: #333;
        }
                
               
       /* =================== TOPBAR =================== */
        .topbar {
            position: fixed;
            top: 0;
            left: 0 !important;
            right: 0;
            height: 50px !important;
            background-color: white;
            border-bottom: 1px solid #e9ecef;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 15px !important;
        }
        
        .language-selector-topbar {
            display: flex;
            gap: 8px;
        }
        
        .flag-btn-small {
            width: 24px; /* Más pequeñas que las originales (32px) */
            height: 18px; /* Más pequeñas que las originales (24px) */
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s;
            opacity: 0.6;
            border: 1px solid transparent;
        }
        
        .flag-btn-small:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        
        .flag-btn-small.active {
            opacity: 1;
            border: 1px solid #007bff;
        }
        
        /* Ajustar el main-area para que no se superponga con el topbar */
        .main-area {
            flex: 1;
            background-color: white;
            display: flex;
            flex-direction: row;
            position: relative;
            height: 100vh;
            overflow: hidden;
            margin-top: 70px; /* Mismo alto que el topbar */
            height: calc(100vh - 70px); /* Restar la altura del topbar */
        }
        
        /* Cuando la sidebar está expandida, ajustar el topbar */
        .container.sidebar-expanded .topbar {
            left: 250px; /* Empieza donde termina la sidebar expandida */
        }
       
       /* =================== ESTADOS DE BÚSQUEDA DEL GRID =================== */
        .property-card.searching {
            pointer-events: none;
            position: relative;
        }
        
        .search-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            z-index: 5;
        }
        
        .search-loader {
            width: 24px;
            height: 24px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: searchSpin 1s linear infinite;
        }
        
        @keyframes searchSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .properties-header h3 {
            transition: opacity 0.3s ease;
        }
        
        .property-card.searching .property-price {
            color: #888;
            font-size: 12px;
        }

       /* =================== LOADER PARA MENSAJES =================== */
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-message {
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 70%;
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 18px;
            background-color: white;
            border: 1px solid #ddd;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            font-family: 'Graphik', sans-serif;
        }
       
       /* =================== BOTÓN VER MÁS PROPIEDADES =================== */
        .properties-header {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .view-more-btn {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background-color: #FFC900;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Graphik', sans-serif;
        }
        
        .view-more-btn:hover {
            background-color: #FFC900;
            color: black;
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 2px 8px rgba(255, 201, 0, 0.3);
        }
       
       /* =================== SUB-SIDEBAR PROPIEDADES =================== */
        .properties-sub-sidebar {
            position: fixed;
            top: 0;
            left: 80px;
            width: 0;
            height: 100vh;
            background-color: white;
            border-right: none;
            border-top-right-radius: 15px; 
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1001;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
            transition: width 0.3s ease;
            padding-top: 85px;
        }

       /* Ajustar sub-sidebar cuando la sidebar principal está expandida */
        .sidebar.expanded ~ .container .properties-sub-sidebar,
        .sidebar.expanded + * .properties-sub-sidebar {
            left: 251px; /* Mover la sub-sidebar para que esté después de la sidebar expandida */
            border-left: none; /* Quitar el borde izquierdo cuando esté reposicionada */
        }
        
        /* Alternativa más directa si la anterior no funciona */
        .container.sidebar-expanded .properties-sub-sidebar {
            left: 251px;
            border-left: none;
        }
        
        .properties-sub-sidebar.active {
            width: 200px;
            border-right: 1px solid #e9ecef;
            border-left: 1px solid #e9ecef;
        }

       .sidebar.expanded + .container .properties-sub-sidebar.active {
            left: 250px;
        }

       /* Forzar que no se vea el borde de la sidebar contraída cuando está expandida */
        .container.sidebar-expanded .sidebar:not(.expanded)::after {
            content: '';
            position: absolute;
            top: 0;
            right: -1px;
            width: 1px;
            height: 100%;
            background-color: white;
            z-index: 1002;
        }
        
        .sub-sidebar-option {
            width: 100%;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            cursor: pointer;
            border-radius: 0;
            transition: background-color 0.2s ease;
            flex-shrink: 0;
            padding: 0 30px 0 60px;
            opacity: 0;
            transform: translateX(-20px);
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }
        
        .properties-sub-sidebar.active .sub-sidebar-option {
            opacity: 1;
            transform: translateX(0);
            transition: opacity 0.3s ease, transform 0.3s ease, background-color 0.2s ease;
        }
        
        .properties-sub-sidebar.active .sub-sidebar-option:nth-child(1) {
            transition-delay: 0.1s;
        }
        
        .properties-sub-sidebar.active .sub-sidebar-option:nth-child(2) {
            transition-delay: 0.2s;
        }
        
        .properties-sub-sidebar.active .sub-sidebar-option:nth-child(3) {
            transition-delay: 0.3s;
        }
        
        .sub-sidebar-option:hover {
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-left: 10px;
            margin-right: 10px;
            width: calc(100% - 20px);
            transition: all 0.1s ease;
        }
        
        .sub-sidebar-option.active {
            /* Sin fondo especial, solo el cambio de icono */
        }
        
        .sub-sidebar-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .sub-sidebar-text {
            font-family: 'Graphik', sans-serif;
            font-size: 12px;
            font-weight: 500;
            color: #333;
            white-space: nowrap;
        }
        
        
        /* También asegurar que la sub-sidebar no interfiera cuando la sidebar esté expandida */
        .sidebar.expanded + .container .properties-sub-sidebar {
            border-left: none !important;
            left: 250px;
        }

       /* =================== OCULTAR SECCIONES MÓVILES EN DESKTOP =================== */
        .mobile-welcome-section {
            display: none;
        }
        
        .mobile-input-area {
            display: none;
        }
       
       .mobile-chat-area {
            display: none;
        }
       
       @media (max-width: 768px) {
            /* =================== SIDEBAR MÓVIL - HORIZONTAL ABAJO =================== */
            .sidebar {
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                top: auto !important;
                width: 100% !important;
                height: 80px !important;
                background-color: white;
                border-top: 1px solid #e9ecef !important;
                border-right: none !important;
                border-radius: 0 !important;
                z-index: 1000;
                display: flex !important;
                flex-direction: row !important;
                align-items: center !important;
                justify-content: space-between !important;
                padding: 0 10px !important;
                transition: none !important;
            }
            
            .sidebar-logo,
            .expand-arrow,
            .sidebar.expanded,
            .sidebar-option[data-option="tasaciones"],
            .sidebar-option[data-option="auditorias"],
            .sidebar-option[data-option="suministros"],
            .sidebar-new-chat {
                display: none !important;
            }
            
            
            /* Contenedor de opciones - horizontal */
            .sidebar-options {
                flex: 1 !important;
                display: flex !important;
                flex-direction: row !important;
                align-items: center !important;
                justify-content: space-between !important;
                padding: 0 !important;
                margin: 0 !important;
                height: 100% !important;
                overflow: visible !important;
                max-height: none !important;
            }
            
            .sidebar-icons-container {
                display: flex !important;
                flex-direction: row !important;
                align-items: center !important;
                justify-content: space-evenly !important;
                width: 75% !important;
                gap: 0 !important;
                margin: 0 !important;
                flex: none !important;
            }
            
            
            .sidebar-bottom-buttons {
                display: flex !important;
                flex-direction: row !important;
                align-items: center !important;
                width: 25% !important;
                gap: 0 !important;
                margin: 0 !important;
                padding: 0 !important;
                justify-content: center !important;
            }
            
            
            .sidebar-otros-servicios-mobile {
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: center !important;
                width: auto !important;
                height: 70px !important;
                margin: 0 !important;
                padding: 6px 4px !important;
                cursor: pointer;
                border-radius: 8px !important;
                transition: background-color 0.2s ease;
                flex-shrink: 0 !important;
                min-width: 55px !important;
                position: relative !important;
            }
            
            .sidebar-otros-servicios-mobile:hover {
                background-color: #f8f9fa !important;
            }
            
            /* Opciones individuales - columna (icono arriba, texto abajo) */
            .sidebar-option,
            .sidebar-login {
                position: relative !important;
                width: auto !important;
                height: 70px !important;
                margin: 0 !important;
                padding: 6px 4px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer;
                border-radius: 8px !important;
                transition: background-color 0.2s ease;
                flex-shrink: 0 !important;
                flex-direction: column !important;
                min-width: 55px !important;
            }
            
            .sidebar-option:hover,
            .sidebar-login:hover {
                background-color: #f8f9fa !important;
            }

           /* Ocultar espaciador flexible en móvil */
            .sidebar-options div[style*="flex: 1"] {
                display: none !important;
            }
            
            /* Iconos */
            .sidebar-icon {
                width: 26px !important;
                height: 26px !important;
                margin: 0 0 4px 0 !important;
                flex-shrink: 0 !important;
            }
            
            .login-circle {
                width: 26px !important;
                height: 26px !important;
                margin: 0 0 4px 0 !important;
                flex-shrink: 0 !important;
                border-radius: 50% !important;
                background-color: #FFC900 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            }
            
            .login-icon {
                width: 12px !important;
                height: 12px !important;
            }
            
            /* Textos debajo de los iconos */
            .sidebar-text {
                display: block !important;
                font-size: 8px !important;
                font-weight: 500 !important;
                color: #333 !important;
                text-align: center !important;
                line-height: 1.1 !important;
                margin: 0 !important;
                opacity: 1 !important;
                visibility: visible !important;
                position: static !important;
                transform: none !important;
                white-space: nowrap !important;
                pointer-events: auto !important;
                max-width: 55px !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
            }

           /* Cambiar texto de login solo en móvil */
            .sidebar-login .sidebar-text {
                font-size: 0 !important;
            }
            
            .sidebar-login .sidebar-text::after {
                content: 'Login';
                font-size: 8px !important;
                font-weight: 500 !important;
                color: #333 !important;
                text-align: center !important;
                line-height: 1.1 !important;
                white-space: nowrap !important;
            }
            
            /* Ajustar indicador activo para móvil */
            .sidebar-option.active::before {
                content: '';
                position: absolute;
                bottom: -8px !important;
                left: 50% !important;
                right: auto !important;
                top: auto !important;
                transform: translateX(-50%) !important;
                width: 24px !important;
                height: 3px !important;
                background-color: #000;
                border-radius: 2px !important;
                z-index: 10;
            }
            
            /* Ocultar tooltips en móvil */
            .sidebar-option::after,
            .sidebar-login::after {
                display: none !important;
            }
        
            /* Ocultar sub-sidebar en móvil */
            .properties-sub-sidebar {
                display: none !important;
            }
        
            /* =================== TOPBAR MÓVIL =================== */
            .topbar {
                position: fixed;
                top: 0;
                left: 0 !important;
                right: 0;
                height: 50px !important;
                background-color: white;
                border-bottom: 1px solid #e9ecef;
                z-index: 999;
                display: flex;
                align-items: center;
                justify-content: flex-end;
                padding-right: 15px !important;
            }
            
            .language-selector-topbar {
                display: flex;
                gap: 6px;
            }
            
            .flag-btn-small {
                width: 20px !important;
                height: 15px !important;
                cursor: pointer;
                border-radius: 2px;
                transition: all 0.2s;
                opacity: 0.6;
                border: 1px solid transparent;
            }
            
            .flag-btn-small:hover {
                opacity: 1;
                transform: scale(1.1);
            }
            
            .flag-btn-small.active {
                opacity: 1;
                border: 1px solid #007bff;
            }
        
            /* =================== LAYOUT PRINCIPAL MÓVIL =================== */
            .container,
            .container.sidebar-active,
            .container.sidebar-expanded {
                margin-left: 0 !important;
                width: 100% !important;
                transition: none !important;
            }
            
            .main-area {
                flex-direction: column !important;
                margin-top: 50px !important;
                margin-bottom: 80px !important; /* Espacio para la sidebar inferior */
                height: calc(100vh - 130px) !important; /* 50px topbar + 70px sidebar */
                padding: 0 !important;
                overflow-y: auto !important;
            }
        
            /* =================== CARRUSEL DE PROPIEDADES =================== */
           .chat-column {
                order: 2 !important;
            } 
           
           .properties-column {
                flex: none !important;
                order: 1 !important;
                background-color: transparent !important;
                border-radius: 0 !important;
                margin: 0 !important;
                padding: 0 !important;
                border: none !important;
                box-shadow: none !important;
                position: relative !important;
                top: 0 !important;
                width: 100% !important;
                height: auto !important;
                max-height: none !important;
                min-height: auto !important;
                overflow: visible !important;
            }
            
            .properties-grid {
                padding: 15px 0 !important;
                height: auto !important;
                margin: 0 !important;
                border: none !important;
                background: transparent !important;
                overflow: visible !important;
            }
            
            .properties-header {
                margin-bottom: 15px !important;
                text-align: center;
                padding: 0 15px !important;
                border: none !important;
                background: transparent !important;
                height: auto !important;
            }
            
            .properties-header h3 {
                margin: 0;
                color: #333;
                font-size: 16px;
                font-weight: 600;
                line-height: 1.2;
            }
            
            .grid-container {
                display: flex !important;
                grid-template-columns: none !important;
                grid-template-rows: none !important;
                gap: 15px !important;
                width: 100% !important;
                height: 200px !important;
                overflow-x: auto !important;
                overflow-y: visible !important;
                padding: 0 15px !important;
                margin: 0 !important;
                box-sizing: border-box !important;
                border: none !important;
                box-shadow: none !important;
                background: transparent !important;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            
            .grid-container::-webkit-scrollbar {
                display: none;
            }
            
            .property-card {
                flex: 0 0 calc(70vw - 22.5px) !important;
                min-width: calc(70vw - 22.5px) !important;
                max-width: calc(70vw - 22.5px) !important;
                height: 180px !important;
                background: white;
                border-radius: 12px !important;
                overflow: hidden;
                cursor: pointer;
                transition: transform 0.2s ease, box-shadow 0.2s ease;
                display: flex;
                flex-direction: column;
                position: relative;
                padding: 0 !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
                border: 1px solid #e9ecef !important;
            }
            
            .property-card:hover {
                transform: translateY(-3px) !important;
                box-shadow: 0 6px 20px rgba(0,0,0,0.15) !important;
            }
            
            .property-card .property-image {
                height: 65% !important;
                background-color: #e9ecef;
                display: flex;
                align-items: center;
                justify-content: center;
                overflow: hidden;
                flex-shrink: 0;
                border-radius: 0 !important;
                position: relative;
            }
            
            .property-card .property-info {
                height: 35% !important;
                padding: 12px !important;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                flex-shrink: 0;
                box-sizing: border-box;
            }
            
            .property-card .property-price {
                font-weight: 600;
                color: #333;
                font-size: 16px !important;
                text-align: left;
                margin: 0;
            }
            
            .property-card .property-location {
                color: #666;
                font-size: 13px !important;
                text-align: left;
                margin: 0;
                line-height: 1.2;
            }
            
            .property-card .amenities-icons {
                position: absolute;
                top: 8px;
                right: 8px;
                display: flex;
                flex-direction: column;
                gap: 4px;
                z-index: 5;
            }
            
            .property-card .amenity-icon {
                width: 24px !important;
                height: 24px !important;
                background-color: #FFC900;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 1px 3px rgba(0,0,0,0.2);
                padding: 4px;
            }
            
            .property-card .amenity-icon img {
                width: 14px !important;
                height: 14px !important;
                filter: brightness(0);
            }
        
            /* =================== ÁREA DE CHAT MÓVIL =================== */
            .mobile-chat-area {
                display: none !important;
                flex: 1 !important;
                background-color: white !important;
                width: 100% !important;
                padding: 0 15px !important;
                box-sizing: border-box !important;
                overflow-y: auto !important;
                max-height: calc(100vh - 210px) !important; 
                padding-bottom: 20px !important;
                opacity: 0;
                transform: translateY(20px);
                transition: opacity 0.4s ease-in, transform 0.4s ease-in;
            }

           .mobile-chat-area.fade-in {
                opacity: 1;
                transform: translateY(0);
            }
            
            .mobile-chat-messages {
                display: flex;
                flex-direction: column;
                gap: 15px;
                padding: 20px 0;
            }
            
            .mobile-chat-messages .message {
                max-width: 85%;
                margin-bottom: 15px;
                padding: 12px 18px;
                border-radius: 18px;
                word-wrap: break-word;
                font-family: 'Graphik', sans-serif;
                font-size: 14px;
            }
            
            .mobile-chat-messages .message.assistant {
                background-color: white;
                border: 1px solid #ddd;
                align-self: flex-start;
                border-bottom-left-radius: 4px;
            }
            
            .mobile-chat-messages .message.user {
                background-color: #edf2f4;
                align-self: flex-end;
                border-bottom-right-radius: 4px;
            }
            
            .mobile-chat-messages .message.old {
                color: #888;
                filter: grayscale(0.7) opacity(0.8);
            }

           .chat-screen {
                display: none !important;
            }
            
            .welcome-screen {
                display: none !important;
            }
            
            .chat-messages {
                display: none !important;
            }
            
            .chat-input-container {
                display: none !important;
            }
            
           
           /* =================== SECCIÓN DE BIENVENIDA MÓVIL =================== */
            .mobile-welcome-section {
                display: block !important;
                padding: 20px !important;
                text-align: center;
                background-color: white !important;
                width: 100% !important;
                flex-shrink: 0 !important;
                box-sizing: border-box !important;
                opacity: 1;
                transform: translateY(0);
                transition: opacity 0.4s ease-out, transform 0.4s ease-out;
            }

           .mobile-welcome-section.fade-out {
                opacity: 0;
                transform: translateY(-20px);
            }
            
            .mobile-welcome-title {
                font-family: 'Graphik', sans-serif;
                font-weight: bold;
                font-size: 22px !important;
                color: black;
                margin: 0 0 15px 0 !important;
                text-align: center;
                line-height: 1.3;
            }
            
            .mobile-welcome-subtitle {
                font-family: 'Graphik', sans-serif;
                font-weight: normal;
                font-size: 16px !important;
                color: #666;
                margin: 0 0 20px 0 !important;
                text-align: center;
                line-height: 1.4;
                padding: 0 10px;
            }
        
            /* =================== ÁREA DE INPUT MÓVIL =================== */
            .mobile-input-area {
                position: fixed !important;
                bottom: 80px !important; /* Justo encima de la sidebar */
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                padding: 0 !important; /* Sin padding para que sea borde a borde */
                background-color: white !important;
                border-top: 1px solid #e9ecef !important;
                box-shadow: 0 -1px 3px rgba(0, 0, 0, 0.1) !important;
                z-index: 999 !important;
                box-sizing: border-box !important;
                height: 60px !important; /* Altura fija */
            }
            
            .mobile-input-wrapper {
                display: flex;
                background-color: white;
                border: none !important; /* Sin borde */
                border-radius: 0 !important; /* Completamente recto */
                padding: 12px 15px !important;
                align-items: center;
                width: 100%;
                height: 100%;
                position: relative;
                box-shadow: none !important;
                margin: 0;
            }
            
            .mobile-chat-input {
                flex: 1;
                border: none;
                outline: none;
                padding: 0 15px 0 0 !important;
                font-size: 16px !important;
                font-family: 'Graphik', sans-serif;
                border-radius: 0;
                resize: none;
                max-height: 36px !important;
                min-height: 36px !important;
                width: 100%;
                background: transparent;
                line-height: 1.4;
                overflow: hidden; /* Solo 1 línea */
            }
            
            .mobile-send-button {
                background-color: #edf2f4;
                color:#333;
                border: none;
                border-radius: 50%;
                width: 40px !important;
                height: 36px !important;
                margin: -25px 30px 0 0;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: background-color 0.2s;
                flex-shrink: 0;
                font-size: 20px !important;
                box-shadow: none;
            }
            
            .mobile-send-button:hover {
                background-color: #f8f9fa;
                color: #0056b3;
            }
            
            .mobile-typing-placeholder {
                position: absolute;
                left: 20px;
                top: 15px;
                transform: translateY(-50%);
                color: #999;
                font-family: 'Graphik', sans-serif;
                font-size: 12px;
                pointer-events: none;
                z-index: 1;
                white-space: normal;
                overflow: hidden;
                transition: opacity 0.3s ease; 
                line-height: 1.2;
                max-height: 2.4em;
            }
            
            .mobile-typing-placeholder.typing::after {
                content: '|';
                animation: blink 1s infinite;
                color: #333;
                position: relative;
                top: -2px;
                font-weight: normal;
            }
           .mobile-input-wrapper .mobile-chat-input:focus ~ .mobile-typing-placeholder,
            .mobile-input-wrapper .mobile-chat-input:not(:placeholder-shown) ~ .mobile-typing-placeholder {
                opacity: 0;
                visibility: hidden;
            }
            
            .mobile-disclaimer {
                    display: none !important;
                }

           /* =================== TARJETAS DE PROPIEDADES PANTALLA COMPLETA MÓVIL =================== */
            .property-slide-card {
                position: fixed !important;
                top: 0 !important;
                left: 100% !important;
                width: 100vw !important;
                height: 100vh !important;
                background: white !important;
                z-index: 2000 !important; /* Mayor z-index para estar por encima de todo */
                transition: left 0.3s ease-in-out !important;
                overflow-y: auto !important;
                border-radius: 0 !important; /* Sin bordes redondeados en móvil */
                box-shadow: none !important; /* Sin sombra en pantalla completa */
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .property-slide-card.active {
                left: 0 !important; /* Completamente a la izquierda = pantalla completa */
            }
            
            /* Ajustar contenido para móvil */
            .property-slide-content {
                padding: 15px !important;
                height: 100% !important;
                box-sizing: border-box !important;
                display: block !important; /* Cambiar de grid a block en móvil */
                overflow-y: auto !important;
            }
            
            /* Reorganizar elementos para móvil */
            .property-slide-header {
                margin-top: 35px !important; /* Espacio para el botón cerrar */
                margin-bottom: 10px !important;
            }
            
            .property-slide-title {
                font-size: 20px !important;
                line-height: 1.3 !important;
            }
            
            .property-slide-location-area {
                margin-bottom: 15px !important;
            }
            
            .property-slide-price-area {
                margin-bottom: 15px !important;
                padding-bottom: 15px !important;
                border-bottom: 1px solid #eee !important;
            }
            
            .property-slide-specs-area {
                margin-bottom: 15px !important;
            }
            
            .contact-sales-btn {
                width: 100% !important;
                margin-bottom: 20px !important;
                padding: 15px !important;
                font-size: 16px !important;
            }
            
            /* Mapa en móvil */
            .property-slide-map {
                height: 200px !important;
                margin-bottom: 20px !important;
                border-radius: 8px !important;
            }
            
            /* Carrusel en móvil */
            .property-slide-carousel-area {
                margin-bottom: 20px !important;
            }
            
            .property-slide-carousel {
                height: 250px !important;
                border-radius: 8px !important;
            }
            
            /* Descripción en móvil */
            .property-slide-description-area {
                margin-bottom: 20px !important;
            }
            
            /* Feedback en móvil */
            .property-feedback-area {
                margin-bottom: 20px !important;
                padding: 15px !important;
            }
            
            /* Botón cerrar más visible en móvil */
            .property-slide-close {
                position: fixed !important;
                top: 15px !important;
                right: 30px !important;
                background: none;
                color: white !important;
                font-size: 24px !important;
                cursor: pointer;
                width: 40px !important;
                height: 40px !important;
                border-radius: 50% !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                font-weight: bold !important;
                z-index: 2001 !important;
                border: none !important;
            }
            
            .property-slide-close:hover {
                background: rgba(211, 211, 211, 0.3);
                transform: scale(1.1) !important;
            }
        
            /* =================== OCULTAR ELEMENTOS DESKTOP EN MÓVIL =================== */
            .welcome-screen {
                display: none !important;
            }
            
            .chat-screen {
                display: none !important;
            }
        
            /* =================== OTROS AJUSTES MÓVIL =================== */
            .message {
                max-width: 85%;
                font-size: 14px;
            }
            
            .chat-messages {
                padding: 20px 15px;
                overflow-y: auto;
            }
        }
            
      
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script>
    (function(h,o,t,j,a,r){
        h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
        h._hjSettings={hjid:6438880,hjsv:6};
        a=o.getElementsByTagName('head')[0];
        r=o.createElement('script');r.async=1;
        r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
        a.appendChild(r);
    })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
</script>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <!-- Logo AURA -->
        <div class="sidebar-logo">
            <div class="aura-logo">A</div>
            <div class="expand-arrow" data-tooltip="Expandir" onclick="toggleSidebar()">›</div>
        </div>
        
        <!-- Opciones del menú -->
        <div class="sidebar-options">
            <div class="sidebar-icons-container">
                <div class="sidebar-option" data-option="propiedades" data-tooltip="Propiedades">
                    <img src="https://cdn-icons-png.flaticon.com/512/9664/9664027.png" alt="Propiedades" class="sidebar-icon">
                    <span class="sidebar-text">Propiedades</span>
                </div>
                <div class="sidebar-option" data-option="financiacion" data-tooltip="Financiación">
                    <img src="https://cdn-icons-png.flaticon.com/512/2769/2769362.png" alt="Financiación" class="sidebar-icon">
                    <span class="sidebar-text">Financiación</span>
                </div>
                <div class="sidebar-option" data-option="tasaciones" data-tooltip="Tasaciones">
                    <img src="https://cdn-icons-png.flaticon.com/512/2169/2169846.png" alt="Tasaciones" class="sidebar-icon">
                    <span class="sidebar-text">Tasaciones</span>
                </div>
                <div class="sidebar-option" data-option="auditorias" data-tooltip="Auditorías">
                    <img src="https://cdn-icons-png.flaticon.com/512/4561/4561511.png" alt="Auditorías" class="sidebar-icon">
                    <span class="sidebar-text">Auditorías</span>
                </div>
                <div class="sidebar-option" data-option="mudanzas" data-tooltip="Mudanzas">
                    <img src="https://cdn-icons-png.flaticon.com/512/2787/2787413.png" alt="Mudanzas" class="sidebar-icon">
                    <span class="sidebar-text">Mudanzas</span>
                </div>
                <div class="sidebar-option" data-option="reformas" data-tooltip="Reformas">
                    <img src="https://cdn-icons-png.flaticon.com/512/2963/2963833.png" alt="Reformas" class="sidebar-icon">
                    <span class="sidebar-text">Reformas</span>
                </div>
                <div class="sidebar-option" data-option="suministros" data-tooltip="Gestión Suministros">
                    <img src="https://cdn-icons-png.flaticon.com/512/566/566359.png" alt="Gestión Suministros" class="sidebar-icon">
                    <span class="sidebar-text">Gestión Suministros</span>
                </div>
                <div class="sidebar-option sidebar-otros-servicios-mobile" data-option="otros-servicios" data-tooltip="Otros Servicios" style="display: none;">
                    <img src="https://cdn-icons-png.flaticon.com/512/10348/10348852.png" alt="Otros Servicios" class="sidebar-icon">
                    <span class="sidebar-text">Otros Servicios</span>
                </div>
            </div>
            
            <!-- Espaciador flexible -->
            <div style="flex: 1; min-height: 20px;"></div>
            
            <!-- Botones inferiores -->
            <div class="sidebar-bottom-buttons">
                <div class="sidebar-new-chat" data-tooltip="Nuevo Chat" onclick="startNewChat()">
                    <div class="new-chat-circle">
                        <span class="plus-icon">+</span>
                    </div>
                    <span class="sidebar-text">Nuevo Chat</span>
                </div>  
                <div class="sidebar-login" data-tooltip="Inicia Sesión" onclick="showLoginPopup()">
                    <div class="login-circle">
                        <img src="https://cdn-icons-png.flaticon.com/512/17468/17468741.png" alt="Login" class="login-icon">
                    </div>
                    <span class="sidebar-text">Inicia Sesión</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sub-sidebar de propiedades -->
    <div class="properties-sub-sidebar" id="propertiesSubSidebar">
        <div class="sub-sidebar-option" data-sub-option="buscar">
            <img src="https://cdn-icons-png.flaticon.com/512/9479/9479251.png" alt="Buscar" class="sub-sidebar-icon">
            <span class="sub-sidebar-text">Buscar</span>
        </div>
        <div class="sub-sidebar-option" data-sub-option="favoritos">
            <img src="https://cdn-icons-png.flaticon.com/512/1077/1077035.png" alt="Favoritos" class="sub-sidebar-icon">
            <span class="sub-sidebar-text">Favoritos</span>
        </div>
        <div class="sub-sidebar-option" data-sub-option="ofertas">
            <img src="https://cdn-icons-png.flaticon.com/512/9018/9018942.png" alt="Ofertas" class="sub-sidebar-icon">
            <span class="sub-sidebar-text">Ofertas</span>
        </div>
    </div>
    
    <div class="container sidebar-active">
         <!-- Topbar -->
        <div class="topbar">
            <div class="language-selector-topbar">
                <img src="https://flagcdn.com/w40/es.png" alt="Español" class="flag-btn-small active" onclick="changeLanguage('spanish')" data-lang="spanish">
                <img src="https://flagcdn.com/w40/gb.png" alt="English" class="flag-btn-small" onclick="changeLanguage('english')" data-lang="english">
                <img src="https://flagcdn.com/w40/fr.png" alt="Français" class="flag-btn-small" onclick="changeLanguage('french')" data-lang="french">
            </div>
        </div>
        
        <!-- Área principal -->
        <div class="main-area">
            <!-- Columna izquierda: Chat existente -->
            <div class="chat-column">
                <!-- Pantalla de bienvenida -->
                <div class="welcome-screen" id="welcomeScreen">
                    <div class="language-selector">
                        <img src="https://flagcdn.com/w40/es.png" alt="Español" class="flag-btn active" onclick="changeLanguage('spanish')" data-lang="spanish">
                        <img src="https://flagcdn.com/w40/gb.png" alt="English" class="flag-btn" onclick="changeLanguage('english')" data-lang="english">
                        <img src="https://flagcdn.com/w40/fr.png" alt="Français" class="flag-btn" onclick="changeLanguage('french')" data-lang="french">
                    </div>
                    <h1 class="welcome-title">Hola, soy Luci. ¿Qué vivienda buscas?</h1>
                    <p class="welcome-subtitle">Ey, estoy aquí para ayudarte a encontrar tu vivienda. Pregúntame lo que quieras relacionado con la compra de propiedades.</p>
                    
                    <div class="welcome-chat-input-container">
                        <div class="chat-input-wrapper">
                            <textarea 
                                class="chat-input" 
                                id="welcomeChatInput" 
                                placeholder=""
                                rows="1"
                            ></textarea>
                            <div class="typing-placeholder" id="typingPlaceholder"></div>
                            <button class="send-button" id="welcomeSendButton" onclick="sendWelcomeMessage()">
                                ➤
                            </button>
                        </div>
                        <div class="disclaimer">
                            Luci se encuentra actualmente en <span class="beta-badge">BETA</span>, por lo que puede cometer errores. Considera verificar la información importante.
                        </div>
                    </div>
                </div>
        
                <!-- Pantalla de chat -->
                <div class="chat-screen" id="chatScreen">
                    <div class="chat-header">
                        <h2 class="chat-title">Hola, soy Luci. ¿Con qué te puedo ayudar?</h2>
                    </div>
                    
                    <div class="chat-messages" id="chatMessages">
                        <!-- Los mensajes aparecerán aquí -->
                    </div>
        
                    <div class="chat-input-container">
                        <div class="chat-input-wrapper">
                            <textarea 
                                class="chat-input" 
                                id="chatInput" 
                                placeholder=""
                                rows="1"
                            ></textarea>
                            <button class="send-button" id="sendButton" onclick="sendMessage()">
                                ➤
                            </button>
                        </div>
                        <div class="disclaimer">
                            Luci se encuentra actualmente en <span class="beta-badge">BETA</span>, por lo que puede cometer errores. Considera verificar la información importante.
                        </div>
                    </div>
                </div>
                <!-- Secciones móviles -->
                <div class="mobile-welcome-section">
                    <h1 class="mobile-welcome-title">Hola, soy Luci. ¿Qué vivienda buscas?</h1>
                    <p class="mobile-welcome-subtitle">Ey, estoy aquí para ayudarte a encontrar tu vivienda. Pregúntame lo que quieras relacionado con la compra de propiedades.</p>
                </div>
                <div class="mobile-chat-area">
                    <div class="mobile-chat-messages" id="mobileChatMessages">
                        <!-- Los mensajes aparecerán aquí -->
                    </div>
                </div>
                
                <div class="mobile-input-area">
                    <div class="mobile-input-wrapper">
                        <textarea 
                            class="mobile-chat-input" 
                            id="mobileChatInput" 
                            placeholder=""
                            rows="1"
                        ></textarea>
                        <div class="mobile-typing-placeholder" id="mobileTypingPlaceholder"></div>
                        <button class="mobile-send-button" id="mobileSendButton">
                            ➤
                        </button>
                    </div>
                    <div class="mobile-disclaimer">
                        Luci se encuentra actualmente en <span class="beta-badge">BETA</span>, por lo que puede cometer errores. Considera verificar la información importante.
                    </div>
                </div>
                <!-- Área de chat móvil (oculta inicialmente) -->
                <div class="mobile-chat-area" style="display: none;">
                    <div class="mobile-chat-messages" id="mobileChatMessages">
                        <!-- Los mensajes aparecerán aquí -->
                    </div>
                </div>
            </div>
        
            <!-- Columna derecha: Mosaico de propiedades -->
            <div class="properties-column">
                <div class="properties-grid" id="propertiesGrid">
                    <div class="properties-header">
                        <h3>Nuestras Propiedades</h3>
                    </div>
                    <div class="grid-container">
                    <!-- Propiedad 1 -->
                    <div class="property-card" onclick="openPropertyDetail(1)">
                        <div class="property-image" style="background-image: url('https://f003.backblazeb2.com/b2api/v1/b2_download_file_by_id?fileId=4_z8d6e5dd5a5cccbf59d6b0816_f111c9c7653cb0e93_d20250710_m075738_c003_v0312029_t0056_u01752134258027'); background-size: cover; background-position: center;">
                            <div class="amenities-icons">
                                <div class="amenity-icon" title="Terraza">
                                    <img src="https://cdn-icons-png.flaticon.com/512/3623/3623094.png" alt="Terraza">
                                </div>
                                <div class="amenity-icon" title="Jardín">
                                    <img src="https://cdn-icons-png.flaticon.com/512/1973/1973668.png" alt="Jardín">
                                </div>
                            </div>
                        </div>
                        <div class="property-info">
                            <div class="property-price">1.480.000€</div>
                            <div class="property-location">Palacio, Madrid</div>
                        </div>
                    </div>
                        
                    <!-- Propiedad 2 -->
                    <div class="property-card" onclick="openPropertyDetail(2)">
                        <div class="property-image" style="background-image: url('https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/be/b2/f1/1217657644.webp'); background-size: cover; background-position: center;">
                            <div class="amenities-icons">
                                <div class="amenity-icon" title="Ascensor">
                                    <img src="https://cdn-icons-png.flaticon.com/512/948/948747.png" alt="Ascensor">
                                </div>
                                <div class="amenity-icon" title="Parking">
                                    <img src="https://cdn-icons-png.flaticon.com/512/75/75905.png" alt="Parking">
                                </div>
                                <div class="amenity-icon" title="Terraza">
                                    <img src="https://cdn-icons-png.flaticon.com/512/3623/3623094.png" alt="Terraza">
                                </div>
                                <div class="amenity-icon" title="Piscina">
                                    <img src="https://cdn-icons-png.flaticon.com/512/2932/2932366.png" alt="Piscina">
                                </div>
                                <div class="amenity-icon" title="Jardín">
                                    <img src="https://cdn-icons-png.flaticon.com/512/1973/1973668.png" alt="Jardín">
                                </div>
                            </div>
                        </div>
                        <div class="property-info">
                            <div class="property-price">332.000€</div>
                            <div class="property-location">Puerto de Sotogrande-La Marina</div>
                        </div>
                    </div>
                    
                    <!-- Propiedad 3 -->
                    <div class="property-card" onclick="openPropertyDetail(3)">
                        <div class="property-image" style="background-image: url('https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/47/aa/2a/1217657655.webp'); background-size: cover; background-position: center;">
                            <div class="amenities-icons">
                                <div class="amenity-icon" title="Ascensor">
                                    <img src="https://cdn-icons-png.flaticon.com/512/948/948747.png" alt="Ascensor">
                                </div>
                                <div class="amenity-icon" title="Parking">
                                    <img src="https://cdn-icons-png.flaticon.com/512/75/75905.png" alt="Parking">
                                </div>
                                <div class="amenity-icon" title="Piscina">
                                    <img src="https://cdn-icons-png.flaticon.com/512/2932/2932366.png" alt="Piscina">
                                </div>
                            </div>
                        </div>
                        <div class="property-info">
                            <div class="property-price">489.000€</div>
                            <div class="property-location">Puerto de Sotogrande-La Marina</div>
                        </div>
                    </div>
                    
                    <!-- Propiedad 4 -->
                    <div class="property-card" onclick="openPropertyDetail(4)">
                        <div class="property-image" style="background-image: url('https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/ef/da/02/1352099408.webp'); background-size: cover; background-position: center;">
                            <div class="amenities-icons">
                                <div class="amenity-icon" title="Ascensor">
                                    <img src="https://cdn-icons-png.flaticon.com/512/948/948747.png" alt="Ascensor">
                                </div>
                                <div class="amenity-icon" title="Terraza">
                                    <img src="https://cdn-icons-png.flaticon.com/512/3623/3623094.png" alt="Terraza">
                                </div>
                            </div>
                        </div>
                        <div class="property-info">
                            <div class="property-price">459.000€</div>
                            <div class="property-location">Nueva Atalaya, Estepona</div>
                        </div>
                    </div>
                    
                    <!-- Propiedad 5 -->
                    <div class="property-card" onclick="openPropertyDetail(5)">
                        <div class="property-image" style="background-image: url('https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/26/87/e3/1257669860.webp'); background-size: cover; background-position: center;">
                            <div class="amenities-icons">
                                <div class="amenity-icon" title="Ascensor">
                                    <img src="https://cdn-icons-png.flaticon.com/512/948/948747.png" alt="Ascensor">
                                </div>
                                <div class="amenity-icon" title="Parking">
                                    <img src="https://cdn-icons-png.flaticon.com/512/75/75905.png" alt="Parking">
                                </div>
                            </div>
                        </div>
                        <div class="property-info">
                            <div class="property-price">849.000€</div>
                            <div class="property-location">Lomas de Marbella Club, Marbella</div>
                        </div>
                    </div>
                    
                    <!-- Propiedad 6 -->
                    <div class="property-card" onclick="openPropertyDetail(6)">
                        <div class="property-image" style="background-image: url('https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/5a/c4/85/1347007848.webp'); background-size: cover; background-position: center;">
                            <div class="amenities-icons">
                                <div class="amenity-icon" title="Ascensor">
                                    <img src="https://cdn-icons-png.flaticon.com/512/948/948747.png" alt="Ascensor">
                                </div>
                            </div>
                        </div>
                        <div class="property-info">
                            <div class="property-price">320.000€</div>
                            <div class="property-location">Retiro, Madrid</div>
                        </div>
                    </div>
                    
                    <!-- Propiedad 7 -->
                    <div class="property-card" onclick="openPropertyDetail(7)">
                        <div class="property-image" style="background-image: url('https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/3c/54/a2/1347007801.webp'); background-size: cover; background-position: center;">
                            <div class="amenities-icons">
                                <div class="amenity-icon" title="Terraza">
                                    <img src="https://cdn-icons-png.flaticon.com/512/3623/3623094.png" alt="Terraza">
                                </div>
                            </div>
                        </div>
                        <div class="property-info">
                            <div class="property-price">550.000€</div>
                            <div class="property-location">Malasaña, Madrid</div>
                        </div>
                    </div>
                    
                    <!-- Propiedad 8 -->
                    <div class="property-card" onclick="openPropertyDetail(8)">
                        <div class="property-image" style="background-image: url('https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/96/6b/9a/1347007850.webp'); background-size: cover; background-position: center;">
                            <div class="amenities-icons">
                                <div class="amenity-icon" title="Ascensor">
                                    <img src="https://cdn-icons-png.flaticon.com/512/948/948747.png" alt="Ascensor">
                                </div>
                                <div class="amenity-icon" title="Terraza">
                                    <img src="https://cdn-icons-png.flaticon.com/512/3623/3623094.png" alt="Terraza">
                                </div>
                            </div>
                        </div>
                        <div class="property-info">
                            <div class="property-price">680.000€</div>
                            <div class="property-location">Chueca, Madrid</div>
                        </div>
                    </div>
                    
                    <!-- Propiedad 9 -->
                    <div class="property-card" onclick="openPropertyDetail(9)">
                        <div class="property-image" style="background-image: url('https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/77/54/29/1347007867.webp'); background-size: cover; background-position: center;">
                            <div class="amenities-icons">
                                <div class="amenity-icon" title="Parking">
                                    <img src="https://cdn-icons-png.flaticon.com/512/75/75905.png" alt="Parking">
                                </div>
                            </div>
                        </div>
                        <div class="property-info">
                            <div class="property-price">395.000€</div>
                            <div class="property-location">Lavapiés, Madrid</div>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </div>

    <!-- Popup Crear Cuenta -->
    <div class="popup-overlay" id="loginPopup">
        <div class="popup-content">
            <button class="popup-close" onclick="closeLoginPopup()">&times;</button>
            <h2 class="popup-title">Crea tu cuenta</h2>
            <p class="popup-subtitle">Crear tu cuenta es gratis y muy sencillo</p>
            
            <div class="login-method">
                <button class="login-btn active" onclick="selectLoginMethod('whatsapp')">WhatsApp</button>
                <button class="login-btn" onclick="selectLoginMethod('email')">Email</button>
            </div>
            
            <div id="whatsappLogin">
                <input type="tel" class="phone-input" placeholder="+34 123 456 789" id="phoneInput">
            </div>
            
            <div id="emailLogin" style="display: none;">
                <input type="email" class="email-input" placeholder="tu@email.com" id="emailInput">
            </div>
            
            <button class="send-code-btn" onclick="sendLoginCode()">Enviar código</button>
        </div>
    </div>

    <script>
        // Variables globales
        let isWaitingForResponse = false;
        let currentSessionId = null;
        let deviceId = null;
        let userIP = null;
        let currentConversation = [];
        let supabase = null;
        let currentTopic = null;
        let pendingCallback = false;
        let realtimeChannel = null;
        // Variables para timeout y popup
        let callbackTimeout = null;
        let shownTimeoutPopups = new Set();
        let currentPollingInterval = null;
        let pollingTimeout = null;
        let currentConversationTitle = null;
        let currentLoginMethod = 'whatsapp';
        // Variables para sidebar
        let activeSidebarOption = null;
        
        // URLs de iconos activos e inactivos
        const iconStates = {
            'propiedades': {
                active: 'https://cdn-icons-png.flaticon.com/512/9664/9664027.png',
                inactive: 'https://cdn-icons-png.flaticon.com/512/9643/9643115.png'
            },
            'financiacion': {
                active: 'https://cdn-icons-png.flaticon.com/512/2769/2769402.png',
                inactive: 'https://cdn-icons-png.flaticon.com/512/2769/2769362.png'
            },
            'tasaciones': {
                active: 'https://cdn-icons-png.flaticon.com/512/2169/2169830.png',
                inactive: 'https://cdn-icons-png.flaticon.com/512/2169/2169846.png'
            },
            'auditorias': {
                active: 'https://cdn-icons-png.flaticon.com/512/4561/4561848.png',
                inactive: 'https://cdn-icons-png.flaticon.com/512/4561/4561511.png'
            },
            'mudanzas': {
                active: 'https://cdn-icons-png.flaticon.com/512/2787/2787368.png',
                inactive: 'https://cdn-icons-png.flaticon.com/512/2787/2787413.png'
            },
            'reformas': {
                active: 'https://cdn-icons-png.flaticon.com/512/2963/2963823.png',
                inactive: 'https://cdn-icons-png.flaticon.com/512/2963/2963833.png'
            },
            'suministros': {
                active: 'https://cdn-icons-png.flaticon.com/512/566/566410.png',
                inactive: 'https://cdn-icons-png.flaticon.com/512/566/566359.png'
            }
        };
                
        // Variables para idiomas
        let currentLanguage = 'spanish';
        const translations = {
            spanish: {
                welcomeTitle: 'Hola, soy Luci. ¿Qué vivienda buscas?',
                welcomeSubtitle: 'Ey, estoy aquí para ayudarte a encontrar tu vivienda. Pregúntame lo que quieras relacionado con la compra de propiedades.',
                typingOptions: [
                    'Un piso en un barrio seguro de Valencia',
                    '3 habitaciones cerca del metro',
                    'Propiedades por menos de 350k€ en la Costa del Sol'
                ],
                newChat: 'Nuevo Chat',
                expandSidebar: 'Expandir barra principal',
                collapseSidebar: 'Recoger barra principal',
                showConversations: 'Mostrar conversaciones',
                hideConversations: 'Ocultar conversaciones',
                inputPlaceholder: 'Escribe aquí tu mensaje...',
                disclaimer: 'Luci se encuentra actualmente en <span class="beta-badge">BETA</span>, por lo que puede cometer errores. Considera verificar la información importante.',
            },
            english: {
                welcomeTitle: 'Hello, I\'m Luci. What home are you looking for?',
                welcomeSubtitle: 'Hey, I\'m here to help you find your home. Ask me anything related to buying properties.',
                typingOptions: [
                    'An apartment in a safe neighborhood in Valencia',
                    '3 bedrooms near the metro',
                    'Properties under 350k€ on the Costa del Sol'
                ],
                newChat: 'New Chat',
                expandSidebar: 'Expand sidebar',
                collapseSidebar: 'Collapse sidebar',
                showConversations: 'Show conversations',
                hideConversations: 'Hide conversations',
                inputPlaceholder: 'Type your message here...',
                disclaimer: 'Luci is currently in <span class="beta-badge">BETA</span>, so it may make mistakes. Consider verifying important information.',
            },
            french: {
                welcomeTitle: 'Bonjour, je suis Luci. Quel logement cherchez-vous?',
                welcomeSubtitle: 'Hé, je suis là pour vous aider à trouver votre logement. Demandez-moi tout ce qui concerne l\'achat de propriétés.',
                typingOptions: [
                    'Un appartement dans un quartier sûr de Valence',
                    '3 chambres près du métro',
                    'Propriétés à moins de 350k€ sur la Costa del Sol'
                ],
                newChat: 'Nouveau Chat',
                expandSidebar: 'Développer la barre latérale',
                collapseSidebar: 'Réduire la barre latérale',
                showConversations: 'Afficher les conversations',
                hideConversations: 'Masquer les conversations',
                inputPlaceholder: 'Tapez votre message ici...',
                disclaimer: 'Luci est actuellement en <span class="beta-badge">BETA</span>, elle peut donc faire des erreurs. Considérez vérifier les informations importantes.',
            }
        };
        
        
        // Configuración de Supabase
        const SUPABASE_URL = 'https://uxyxxhsgkprnuxohjhbc.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV4eXh4aHNna3BybnV4b2hqaGJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1NTM3ODEsImV4cCI6MjA1ODEyOTc4MX0.P_ggSy3oU2AvS55fQdwpnk3aFgznfVr6uCdqWH36IwY';
        
        // Inicializar Supabase cuando la librería esté cargada
       function initializeSupabase() {
            return new Promise((resolve) => {
                const checkSupabase = () => {
                    if (window.supabase) {
                        try {
                            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
                                auth: {
                                    autoRefreshToken: true,
                                    persistSession: true,
                                    detectSessionInUrl: true
                                },
                                realtime: {
                                    params: {
                                        eventsPerSecond: 10
                                    },
                                    headers: {},
                                    heartbeatIntervalMs: 30000,
                                    reconnectAfterMs: function (tries) {
                                        return Math.min(tries * 1000, 10000);
                                    }
                                }
                            });
                            console.log('Supabase inicializado correctamente con Auth');
                            resolve(true);
                        } catch (error) {
                            console.error('Error al inicializar Supabase:', error);
                            resolve(false);
                        }
                    } else {
                        console.log('window.supabase no está disponible aún, reintentando...');
                        setTimeout(checkSupabase, 200);
                    }
                };
                
                setTimeout(checkSupabase, 500);
            });
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('=== DOM CONTENT LOADED ===');
            
            try {
                await initializeSupabase();
                await initializeApp();
                updateTexts();
                supabaseClient = supabase;
                initSidebar();
                handleResizeToMobile();
                
                if (supabase) {
                    await checkExistingSession();
                }
                
                // Exponemos estas dos funciones para poder invocarlas desde consola o botones
                window.activateTestMode = function(sessionId) {
                    if (!sessionId) {
                        console.error('Se necesita un session_id para activar el modo test');
                        return false;
                    }   
                    currentSessionId = sessionId;
                    pendingCallback = true; 
                    console.log(`Modo test activado para sesión: ${sessionId}`);
                    console.log(`Callback pendiente: ${pendingCallback}`);
                    return true;
                };
                
                window.sendCallbackManually = async function(textoUsuario) {
                    if (!currentSessionId) return;
                    addMessage(textoUsuario, 'user');
                    try {
                      const response = await fetch(`/api/callback?sessionId=${currentSessionId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                          message: textoUsuario,
                          session_id: currentSessionId
                        })
                      });
                      const json = await response.json();
                      console.log('Respuesta /api/callback:', json);
                    } catch (err) {
                      console.error('Error enviando callback:', err);
                    }
                };
                
                document.getElementById('sendButton').addEventListener('click', () => {
                    const texto = document.getElementById('chatInput').value.trim();
                    if (texto) {
                      sendCallbackManually(texto);
                      document.getElementById('chatInput').value = '';
                    }
                });

                // Event listeners para welcome input
                document.getElementById('welcomeChatInput').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendWelcomeMessage();
                    }
                });
                
                // Auto-resize textarea de welcome
                document.getElementById('welcomeChatInput').addEventListener('input', () => {
                    if (document.getElementById('welcomeChatInput').value.length > 0) {
                        stopTypingAnimation();
                    }
                });
                
                window.addEventListener('beforeunload', () => {
                    if (realtimeChannel) {
                      supabase.removeChannel(realtimeChannel);
                      realtimeChannel = null;
                      console.log('Suscripción Realtime cancelada por navegación');
                    }
                });
                
                const expandArrow = document.querySelector('.expand-arrow');
                const sidebar = document.querySelector('.sidebar');
                const container = document.querySelector('.container');
                
                if (expandArrow && sidebar && container) {
                    expandArrow.addEventListener('click', () => {
                      sidebar.classList.toggle('expanded');
                      container.classList.toggle('sidebar-expanded');
                    });
                }
                
                // VERIFICACIÓN FINAL
                setTimeout(() => {
                    console.log('=== VERIFICACIÓN POST-INICIALIZACIÓN ===');
                    
                    const sidebarOptions = document.querySelectorAll('.sidebar-option');
                    const loginPopup = document.getElementById('loginPopup');
                    
                    console.log('Opciones sidebar encontradas:', sidebarOptions.length);
                    console.log('Login popup encontrado:', loginPopup ? 'SÍ' : 'NO');
                    
                    // Exponer funciones de testing
                    window.testSidebarClicks = function() {
                        console.log('=== TESTING SIDEBAR CLICKS ===');
                        
                        sidebarOptions.forEach((option, index) => {
                            const optionName = option.dataset.option;
                            console.log(`Opción ${index + 1}: ${optionName}`);
                            
                            if (optionName !== 'propiedades') {
                                console.log(`Simulando click en ${optionName}...`);
                                option.click();
                                return; // Solo probar la primera opción no-propiedades
                            }
                        });
                    };
                    
                    window.forceShowLoginPopup = function() {
                        console.log('Forzando mostrar popup...');
                        if (typeof showLoginPopup === 'function') {
                            showLoginPopup();
                        } else {
                            console.error('showLoginPopup no está definida');
                        }
                    };
                    
                    console.log('Funciones de testing disponibles:');
                    console.log('- testSidebarClicks()');
                    console.log('- forceShowLoginPopup()');
                    
                }, 2000);
                
            } catch (error) {
                console.error('Error en DOMContentLoaded:', error);
            }

            // Inicializar animación typing
            setTimeout(() => {
                startTypingAnimation();
            }, 1000);
            
            // Pausar typing cuando el usuario está escribiendo
            document.getElementById('welcomeChatInput').addEventListener('focus', () => {
                stopTypingAnimation();
            });

            document.getElementById('welcomeChatInput').addEventListener('click', () => {
                stopTypingAnimation();
            });
            
            document.getElementById('welcomeChatInput').addEventListener('blur', function() {
                if (!this.value.trim()) {
                    setTimeout(() => {
                        resumeTypingAnimation();
                    }, 500);
                }
            });
            // Manejar display móvil inicial
            handleMobileDisplay();
            
            // Event listener para cambios de orientación en móvil
            window.addEventListener('orientationchange', function() {
                setTimeout(handleMobileDisplay, 100);
            });
            // Event listeners móviles - añadir después de los existentes
            const mobileChatInput = document.getElementById('mobileChatInput');
            const mobileSendButton = document.getElementById('mobileSendButton');
            
            console.log('=== VERIFICANDO ELEMENTOS MÓVILES ===');
            console.log('Mobile input encontrado:', mobileChatInput);
            console.log('Mobile button encontrado:', mobileSendButton);
            
            if (mobileChatInput) {
                // Event listener para Enter
                mobileChatInput.addEventListener('keypress', function(e) {
                    console.log('Tecla presionada en mobile input:', e.key);
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        console.log('Enter detectado, enviando mensaje móvil...');
                        sendMobileMessage();
                    }
                });
                
                // Otros event listeners...
                mobileChatInput.addEventListener('input', () => {
                    stopTypingAnimation();
                    mobileChatInput.style.height = 'auto';
                    mobileChatInput.style.height = Math.min(mobileChatInput.scrollHeight, 120) + 'px';
                });
            } else {
                console.error('Mobile chat input NO encontrado!');
            }
            
            if (mobileSendButton) {
                mobileSendButton.addEventListener('click', function() {
                    console.log('Botón móvil clickeado');
                    sendMobileMessage();
                });
            } else {
                console.error('Mobile send button NO encontrado!');
            }
        });
        
        function startRealtimeSubscription(sessionId) {
            // Limpiar suscripción anterior
            if (realtimeChannel) {
                try {
                    supabase.removeChannel(realtimeChannel);
                } catch (error) {
                    console.log('Error limpiando canal anterior:', error);
                }
                realtimeChannel = null;
            }
            
            currentSessionId = sessionId;
            console.log('Iniciando nueva suscripción para session:', sessionId);
            
            // Configuración corregida del canal
            realtimeChannel = supabase
                .channel('callbacks-channel', {
                    config: {
                        broadcast: { self: false },
                        presence: { key: sessionId },
                        // Eliminar headers problemáticos
                        headers: {}
                    }
                })
                .on(
                    'postgres_changes',
                    {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'callbacks',
                        filter: `session_id=eq.${sessionId}`
                    },
                    (payload) => {
                        console.log('Callback recibido:', payload);
                        const row = payload.new;
                        
                        if (row.session_id !== sessionId) {
                            console.log('Callback ignorado - session_id no coincide');
                            return;
                        }
                        
                        const messageObj = row.payload;
                        const id = row.id;
                        
                        const result = handleCallback({ type: 'callback', ...messageObj });
                        console.log('HandleCallback result:', result);
                        markProcessed(id);
                        
                        // Limpiar suscripción después de procesar
                        if (realtimeChannel) {
                            supabase.removeChannel(realtimeChannel);
                            realtimeChannel = null;
                            console.log('Suscripción cerrada después de procesar callback');
                        }
                    }
                )
                .subscribe((status, err) => {
                    console.log('Estado de suscripción:', status);
                    if (status === 'SUBSCRIBED') {
                        console.log('Suscripción activa para session:', sessionId);
                    } else if (status === 'CHANNEL_ERROR') {
                        console.error('Error en canal Realtime:', err);
                        realtimeChannel = null;
                        
                        // Intentar reconectar después de 3 segundos
                        setTimeout(() => {
                            if (currentSessionId === sessionId && pendingCallback) {
                                console.log('Intentando reconectar...');
                                startRealtimeSubscription(sessionId);
                            }
                        }, 3000);
                    } else if (status === 'TIMED_OUT') {
                        console.error('Timeout en suscripción Realtime');
                        realtimeChannel = null;
                        
                        // Intentar reconectar
                        setTimeout(() => {
                            if (currentSessionId === sessionId && pendingCallback) {
                                console.log('Reconectando después de timeout...');
                                startRealtimeSubscription(sessionId);
                            }
                        }, 2000);
                    } else if (status === 'CLOSED') {
                        console.log('Canal cerrado');
                        realtimeChannel = null;
                    }
                });
        }
        
        function startHybridSubscription(sessionId, isSafariMobile = false) {
            // Sistema híbrido para TODOS los dispositivos
            let pollingInterval = null;
            let realtimeWorking = false;
            
            // Configuraciones específicas según el dispositivo
            const config = isSafariMobile ? {
                heartbeat_interval_ms: 10000, // Más frecuente para Safari
                timeout_ms: 8000,
                pollingDelay: 5000 // Esperar 5s antes de activar polling
            } : {
                heartbeat_interval_ms: 15000, // Configuración estándar
                timeout_ms: 10000,
                pollingDelay: 10000 // Esperar 10s antes de activar polling
            };
            
            console.log('Iniciando suscripción híbrida:', isSafariMobile ? 'Safari móvil' : 'Dispositivo estándar');
            
            // Iniciar Realtime
            realtimeChannel = supabase
                .channel(`public:callbacks:session_id=eq.${sessionId}`, {
                    config: {
                        broadcast: { self: false },
                        presence: { key: sessionId },
                        heartbeat_interval_ms: config.heartbeat_interval_ms,
                        timeout_ms: config.timeout_ms
                    }
                })
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'callbacks',
                    filter: `session_id=eq.${sessionId}`
                }, (payload) => {
                    console.log('Callback recibido via Realtime (híbrido):', payload);
                    realtimeWorking = true;
                    // Detener polling si Realtime funciona
                    if (pollingInterval) {
                        clearInterval(pollingInterval);
                        pollingInterval = null;
                        console.log('Polling detenido - Realtime funcionando');
                    }
                    handleRealtimeCallback(payload, sessionId);
                })
                .subscribe((status, err) => {
                    console.log('Estado suscripción híbrida:', status);
                    if (status === 'SUBSCRIBED') {
                        console.log(`Realtime conectado - esperando ${config.pollingDelay/1000}s antes de activar polling de respaldo`);
                        // Dar tiempo a Realtime, luego activar polling como respaldo
                        setTimeout(() => {
                            if (!realtimeWorking && currentSessionId === sessionId && pendingCallback) {
                                console.log('Activando polling como respaldo');
                                startCallbackPolling(sessionId);
                            }
                        }, config.pollingDelay);
                    } else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') {
                        console.log('Error en Realtime - activando polling inmediatamente');
                        if (!pollingInterval) {
                            startCallbackPolling(sessionId);
                        }
                    }
                });
        }
        
        function startCallbackPolling(sessionId) {
            // Limpiar polling anterior si existe
            if (currentPollingInterval) {
                clearInterval(currentPollingInterval);
                currentPollingInterval = null;
            }
            
            if (pollingTimeout) {
                clearTimeout(pollingTimeout);
                pollingTimeout = null;
            }
            
            console.log('Iniciando polling para session:', sessionId);
            
            // Timeout de 3 minutos
            pollingTimeout = setTimeout(() => {
                console.log('Timeout de polling alcanzado (3 minutos)');
                if (currentPollingInterval) {
                    clearInterval(currentPollingInterval);
                    currentPollingInterval = null;
                }
                pollingTimeout = null;
            }, 180000);
            
            currentPollingInterval = setInterval(async () => {
                if (currentSessionId !== sessionId || !pendingCallback) {
                    clearInterval(currentPollingInterval);
                    currentPollingInterval = null;
                    if (pollingTimeout) {
                        clearTimeout(pollingTimeout);
                        pollingTimeout = null;
                    }
                    console.log('Polling detenido');
                    return;
                }
                
                try {
                    console.log('Haciendo polling para callbacks...');
                    const { data, error } = await supabase
                        .from('callbacks')
                        .select('*')
                        .eq('session_id', sessionId)
                        .eq('pending', true)
                        .order('created_at', { ascending: false })
                        .limit(1);
                        
                    if (error) {
                        console.error('Error en polling:', error);
                        return;
                    }
                    
                    if (data && data.length > 0) {
                        const callback = data[0];
                        console.log('Callback encontrado via polling:', callback);
                        
                        const payload = { new: callback, eventType: 'INSERT' };
                        handleRealtimeCallback(payload, sessionId);
                        
                        clearInterval(currentPollingInterval);
                        currentPollingInterval = null;
                        if (pollingTimeout) {
                            clearTimeout(pollingTimeout);
                            pollingTimeout = null;
                        }
                        console.log('Polling detenido - callback procesado');
                    }
                } catch (error) {
                    console.error('Error en polling:', error);
                }
            }, 6000);
        }
        
        function handleRealtimeCallback(payload, sessionId) {
            const row = payload.new;
            console.log('Procesando callback:', row);
            
            if (row.session_id !== sessionId) {
                console.log('Callback ignorado - session_id no coincide');
                return;
            }
            
            const messageObj = row.payload;
            const id = row.id;
            
            const result = handleCallback({ type: 'callback', ...messageObj });
            console.log('HandleCallback result:', result);
            markProcessed(id);
            
            // Limpiar suscripción después de procesar
            if (realtimeChannel) {
                supabase.removeChannel(realtimeChannel);
                realtimeChannel = null;
                console.log('Suscripción cerrada después de procesar callback');
            }
            
            // Limpiar polling Y su timeout si existen
            if (window.currentPollingInterval) {
                clearInterval(window.currentPollingInterval);
                window.currentPollingInterval = null;
                console.log('Polling interval limpiado después de procesar callback');
            }
            
            if (window.pollingTimeout) {
                clearTimeout(window.pollingTimeout);
                window.pollingTimeout = null;
                console.log('Polling timeout limpiado después de procesar callback');
            }
        }
        
        function handleSubscriptionStatus(status, err, sessionId) {
            if (status === 'SUBSCRIBED') {
                console.log('Suscripción activa para session:', sessionId);
            } else if (status === 'CHANNEL_ERROR') {
                console.error('Error en canal Realtime:', err);
                realtimeChannel = null;
                // Para Safari, activar polling inmediatamente
                const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
                if (isSafari) {
                    console.log('Error en Safari - activando polling');
                    startCallbackPolling(sessionId);
                } else {
                    setTimeout(() => {
                        if (currentSessionId === sessionId && pendingCallback) {
                            console.log('Intentando reconectar...');
                            startRealtimeSubscription(sessionId);
                        }
                    }, 2000);
                }
            } else if (status === 'TIMED_OUT') {
                console.error('Timeout en suscripción Realtime');
                realtimeChannel = null;
                startCallbackPolling(sessionId); // Activar polling en timeout
            } else if (status === 'CLOSED') {
                console.log('Canal cerrado');
                realtimeChannel = null;
            }
        }
            
        async function markProcessed(id) {
            try {
                const response = await fetch(`/api/mark_processed?id=${id}`, {
                    method: 'POST'
                });
                const json = await response.json();
            } catch (err) {
                console.error('Error marcando como procesado:', err);
            }
            }
            
        
        function handleCallback(data) {
            console.log('handleCallback ejecutado con:', data);
            console.log('currentSessionId:', currentSessionId);
            console.log('pendingCallback:', pendingCallback);
            
            // Verificar que el callback es para la sesión actual
            if (!data.session_id || data.session_id !== currentSessionId) {
                console.log('Session ID mismatch:', data.session_id, 'vs', currentSessionId);
                return { success: false, message: 'Session ID mismatch or missing' };
            }
            
            if (!currentSessionId) {
                console.log('No active session');
                return { success: false, message: 'No active session' };
            }
        
            console.log('Processing callback - pendingCallback:', pendingCallback);
            
            // Actualizar topic si viene en la respuesta
            if (data.topic && data.topic !== currentTopic) {
                currentTopic = data.topic;
            }
            
            // Siempre añadir el mensaje si existe
            if (data.message) {
                addMessage(data.message, 'assistant');
            }
        
            // Si hay propiedades, actualizar el grid
            if (data.properties && Array.isArray(data.properties) && data.properties.length > 0) {
                console.log('Propiedades en array:', data.properties.length);
                console.log('Total propiedades del callback:', data.total_properties);
                updateGridWithResults(data.properties, data.total_properties);
            } else if (data.total_properties && data.total_properties > 0) {
                // Si no hay propiedades en el array pero sí un total, mostrar solo el botón
                console.log('Solo total sin propiedades:', data.total_properties);
                addViewMoreButton(data.total_properties);
            }
            
            // Resetear estado de callback pendiente
            pendingCallback = false;
            hideLoading(); 
            console.log('Callback procesado exitosamente');
            return { success: true, message: 'Callback procesado correctamente' };
        }
        
        // Función para intentar recuperar conversaciones por IP cuando no hay device_id match
        async function tryRecoverConversationsByIP() {
            if (!supabase || !userIP) return [];
            
            try {
                console.log('Intentando recuperar conversaciones por IP:', userIP);
                
                const { data, error } = await supabase
                    .from('chat_sessions')
                    .select('*')
                    .eq('ip', userIP)
                    .order('updated_at', { ascending: false })
                    .limit(5); // Solo las 5 más recientes para no sobrecargar
                    
                if (error) {
                    console.error('Error al recuperar por IP:', error);
                    return [];
                }
                
                console.log('Conversaciones encontradas por IP:', data);
                return data || [];
            } catch (error) {
                console.error('Error en recuperación por IP:', error);
                return [];
            }
        }

        // Función para generar session_id único
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Función para obtener la IP del usuario
        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.error('Error al obtener IP:', error);
                return 'unknown';
            }
        }

        // Función para obtener información del navegador
        function getBrowserInfo() {
            return {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                screenResolution: `${screen.width}x${screen.height}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                timestamp: new Date().toISOString()
            };
        }

        // Función para inicializar la aplicación
        async function initializeApp() {
            console.log('=== INICIALIZANDO APP ===');
            
            try {
                deviceId = generateDeviceId();
                console.log('Device ID generado:', deviceId);
                
                userIP = await getUserIP();
                console.log('IP obtenida:', userIP);
                
                // Esperar un poco para asegurar que Supabase esté listo
                setTimeout(async () => {
                    await loadPreviousConversations();
                }, 500);
                
                console.log('App inicializada correctamente');
            } catch (error) {
                console.error('Error al inicializar app:', error);
            }
        }

        // Función para generar device_id único
        function generateDeviceId() {
            // Comprobar si ya existe en localStorage
            let deviceId = localStorage.getItem('luci_device_id');
            
            if (!deviceId) {
                // Generar nuevo device_id
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                // Guardar en localStorage
                try {
                    localStorage.setItem('luci_device_id', deviceId);
                } catch (error) {
                    console.log('No se pudo guardar en localStorage:', error);
                }
            }
            
            console.log('Device ID:', deviceId);
            return deviceId;
        }
        
        // Función para cambiar idioma
        function changeLanguage(language) {
            currentLanguage = language;
            
            // Actualizar banderas activas (tanto las originales como las del topbar)
            document.querySelectorAll('.flag-btn, .flag-btn-small').forEach(flag => {
                flag.classList.remove('active');
                if (flag.dataset.lang === language) {
                    flag.classList.add('active');
                }
            });
            
            // Actualizar textos
            updateTexts();
        }
        
        function updateTexts() {
            const texts = translations[currentLanguage];
            
            // Actualizar elementos específicos
            const welcomeTitle = document.querySelector('.welcome-title');
            if (welcomeTitle) welcomeTitle.textContent = texts.welcomeTitle;
            
            const welcomeSubtitle = document.querySelector('.welcome-subtitle');
            if (welcomeSubtitle) welcomeSubtitle.textContent = texts.welcomeSubtitle;
            
            // Actualizar nuevo chat
            const newChatBtn = document.querySelector('.sidebar-new-chat');
            if (newChatBtn) {
                newChatBtn.setAttribute('data-tooltip', texts.newChat);
            }
            
            // Actualizar placeholder de los inputs
            const chatInput = document.getElementById('chatInput');
            if (chatInput) chatInput.placeholder = texts.inputPlaceholder;
            
            // Actualizar disclaimer
            const disclaimers = document.querySelectorAll('.disclaimer');
            disclaimers.forEach(disclaimer => {
                disclaimer.innerHTML = texts.disclaimer;
            });
        
            // Actualizar textos de la sidebar
            const sidebarTexts = {
                spanish: {
                    propiedades: 'Propiedades',
                    financiacion: 'Financiación', 
                    tasaciones: 'Tasaciones',
                    auditorias: 'Auditorías',
                    mudanzas: 'Mudanzas',
                    reformas: 'Reformas',
                    suministros: 'Gestión Suministros'
                },
                english: {
                    propiedades: 'Properties',
                    financiacion: 'Financing',
                    tasaciones: 'Valuations', 
                    auditorias: 'Audits',
                    mudanzas: 'Moving',
                    reformas: 'Renovations',
                    suministros: 'Utilities Management'
                },
                french: {
                    propiedades: 'Propriétés',
                    financiacion: 'Financement',
                    tasaciones: 'Évaluations',
                    auditorias: 'Audits', 
                    mudanzas: 'Déménagement',
                    reformas: 'Rénovations',
                    suministros: 'Gestion Services'
                }
            };
            
            // Actualizar textos de sidebar
            Object.keys(sidebarTexts[currentLanguage]).forEach(key => {
                const element = document.querySelector(`[data-option="${key}"] .sidebar-text`);
                if (element) {
                    element.textContent = sidebarTexts[currentLanguage][key];
                }
            }); 
            
            // Reiniciar animación typing si estamos en welcome screen
            const welcomeScreen = document.getElementById('welcomeScreen');
            if (welcomeScreen && welcomeScreen.style.display !== 'none') {
                setTimeout(() => {
                    resumeTypingAnimation();
                }, 100);
            }
        }

        // Función para detectar móvil y manejar visibilidad correcta
        function handleMobileDisplay() {
            const isMobileDevice = window.innerWidth <= 768;
            
            if (isMobileDevice) {
                // En móvil, siempre mostrar las secciones móviles
                const mobileWelcomeSection = document.querySelector('.mobile-welcome-section');
                const mobileInputArea = document.querySelector('.mobile-input-area');
                const welcomeScreen = document.getElementById('welcomeScreen');
                const chatScreen = document.getElementById('chatScreen');
                
                // Ocultar versiones desktop
                if (welcomeScreen) welcomeScreen.style.display = 'none';
                if (chatScreen) chatScreen.style.display = 'none';
                
                // Mostrar versiones móviles
                if (mobileWelcomeSection) {
                    mobileWelcomeSection.style.display = 'block';
                    mobileWelcomeSection.style.visibility = 'visible';
                }
                if (mobileInputArea) {
                    mobileInputArea.style.display = 'block';
                    mobileInputArea.style.visibility = 'visible';
                }
                
                // Iniciar animación typing para móvil si estamos en welcome
                setTimeout(() => {
                    if (mobileWelcomeSection && mobileWelcomeSection.style.display !== 'none') {
                        resumeTypingAnimation();
                    }
                }, 1000);
                
                console.log('Modo móvil activado - secciones móviles mostradas');
            } else {
                // En desktop, ocultar secciones móviles
                const mobileWelcomeSection = document.querySelector('.mobile-welcome-section');
                const mobileInputArea = document.querySelector('.mobile-input-area');
                
                if (mobileWelcomeSection) mobileWelcomeSection.style.display = 'none';
                if (mobileInputArea) mobileInputArea.style.display = 'none';
            }
        }
        
        
        // Variables para animación typing
        let typingInterval = null;
        let currentTypingIndex = 0;
        let currentCharIndex = 0;
        let isTyping = false;
        let typingPaused = false;
        // Variables para animación typing 
        let mobileTypingInterval = null;
        let mobileCurrentTypingIndex = 0;
        let mobileCurrentCharIndex = 0;
        let mobileIsTyping = false;
        let mobileTypingPaused = false;

        function isMobileView() {
            return window.innerWidth <= 768;
        }

        function getTypingPlaceholder() {
            if (isMobileView()) {
                return document.getElementById('mobileTypingPlaceholder');
            } else {
                return document.getElementById('typingPlaceholder');
            }
        }
        
        function startTypingAnimation() {
            const typingPlaceholder = getTypingPlaceholder();
            if (!typingPlaceholder) return;
            
            const texts = translations[currentLanguage].typingOptions;
            
            function typeText() {
                const currentPaused = isMobileView() ? mobileTypingPaused : typingPaused;
                if (currentPaused) return;
                
                const currentIndex = isMobileView() ? mobileCurrentTypingIndex : currentTypingIndex;
                const currentCharIdx = isMobileView() ? mobileCurrentCharIndex : currentCharIndex;
                const currentText = texts[currentIndex];
                
                if (currentCharIdx <= currentText.length) {
                    const displayText = currentText.substring(0, currentCharIdx);
                    typingPlaceholder.textContent = displayText;
                    typingPlaceholder.classList.add('typing');
                    
                    if (isMobileView()) {
                        mobileCurrentCharIndex++;
                    } else {
                        currentCharIndex++;
                    }
                    
                    // Velocidad de typing variable para más naturalidad
                    const delay = Math.random() * 50 + 30;
                    setTimeout(typeText, delay);
                } else {
                    // Pausa al final del texto
                    setTimeout(() => {
                        const stillPaused = isMobileView() ? mobileTypingPaused : typingPaused;
                        if (!stillPaused) {
                            // Borrar texto
                            eraseText();
                        }
                    }, 2000);
                }
            }
            
            function eraseText() {
                const currentPaused = isMobileView() ? mobileTypingPaused : typingPaused;
                if (currentPaused) return;
                
                const currentIndex = isMobileView() ? mobileCurrentTypingIndex : currentTypingIndex;
                const currentCharIdx = isMobileView() ? mobileCurrentCharIndex : currentCharIndex;
                const currentText = texts[currentIndex];
                
                if (currentCharIdx > 0) {
                    const displayText = currentText.substring(0, currentCharIdx - 1);
                    typingPlaceholder.textContent = displayText;
                    
                    if (isMobileView()) {
                        mobileCurrentCharIndex--;
                    } else {
                        currentCharIndex--;
                    }
                    
                    setTimeout(eraseText, 20);
                } else {
                    // Cambiar al siguiente texto
                    if (isMobileView()) {
                        mobileCurrentTypingIndex = (mobileCurrentTypingIndex + 1) % texts.length;
                    } else {
                        currentTypingIndex = (currentTypingIndex + 1) % texts.length;
                    }
                    
                    typingPlaceholder.classList.remove('typing');
                    
                    setTimeout(() => {
                        const stillPaused = isMobileView() ? mobileTypingPaused : typingPaused;
                        if (!stillPaused) {
                            typeText();
                        }
                    }, 500);
                }
            }
            
            // Iniciar la animación
            typeText();
        }
        
        function stopTypingAnimation() {
            console.log('Stopping typing animation, mobile view:', isMobileView());
            
            if (isMobileView()) {
                mobileTypingPaused = true;
            } else {
                typingPaused = true;
            }
            
            const typingPlaceholder = getTypingPlaceholder();
            if (typingPlaceholder) {
                typingPlaceholder.classList.remove('typing');
                // AÑADIDO: Ocultar completamente el placeholder cuando se pausa
                typingPlaceholder.style.opacity = '0';
            }
        }
        
        function resumeTypingAnimation() {
            console.log('Resuming typing animation, mobile view:', isMobileView());
            
            const typingPlaceholder = getTypingPlaceholder();
            if (!typingPlaceholder) return;
            
            // Verificar que realmente no hay texto en el input correspondiente
            const input = isMobileView() ? 
                document.getElementById('mobileChatInput') : 
                document.getElementById('welcomeChatInput');
                
            if (input && input.value.trim()) {
                console.log('Input has content, not resuming typing');
                return;
            }
            
            // Restaurar visibilidad del placeholder
            typingPlaceholder.style.opacity = '1';
            
            if (isMobileView()) {
                mobileTypingPaused = false;
                mobileCurrentCharIndex = 0;
                mobileCurrentTypingIndex = 0;
            } else {
                typingPaused = false;
                currentCharIndex = 0;
                currentTypingIndex = 0;
            }
            
            startTypingAnimation();
        }
        
        // Función para cargar conversaciones previas
        async function loadPreviousConversations() {
            if (!supabase) {
                console.log('Supabase no está inicializado aún');
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('chat_sessions')
                    .select('*')
                    .eq('device_id', deviceId)
                    .neq('hide', true)
                    .order('updated_at', { ascending: false });
        
                if (error) {
                    console.error('Error al cargar conversaciones:', error);
                    return;
                }
                
                let conversationsToShow = data;
                if (!data || data.length === 0) {
                    conversationsToShow = await tryRecoverConversationsByIP();
                }
                
                // Solo log por ahora - no mostrar en UI
                console.log('Conversaciones cargadas:', conversationsToShow?.length || 0);
            } catch (error) {
                console.error('Error al cargar conversaciones:', error);
            }
        }


        // Función para cargar una conversación específica
        function loadConversation(conversation) {
            // Limpiar suscripción anterior al cargar conversación histórica
            if (realtimeChannel) {
                try {
                    supabase.removeChannel(realtimeChannel);
                    realtimeChannel.unsubscribe();
                } catch (error) {
                    console.log('Error limpiando canal en loadConversation:', error);
                }
                realtimeChannel = null;
            }
            currentSessionId = conversation.session_id;
            currentConversation = conversation.conversations || [];
            currentTopic = conversation.topic || null;
            pendingCallback = false;
        
            // Cambiar a vista de chat
            showChatScreen();
        
            // Cargar mensajes
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';
        
            currentConversation.forEach(msg => {
                addMessage(msg.text, msg.sender, false);
            });
            
            // Marcar conversación como activa
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Encontrar el elemento clickeado y marcarlo como activo
            const clickedItem = event.target.closest('.conversation-item');
            if (clickedItem) {
                clickedItem.classList.add('active');
            }
        }

        // Función para mostrar la pantalla de chat
        function showChatScreen() {
            const welcomeScreen = document.getElementById('welcomeScreen');
            const chatScreen = document.getElementById('chatScreen');

            welcomeScreen.style.display = 'none';
            chatScreen.style.display = 'flex';
            setTimeout(() => {
                chatScreen.classList.add('fade-in');
            }, 50);
        }

        // Función para guardar conversación en Supabase
        async function saveConversationToSupabase() {
            if (!supabase) {
                console.log('Supabase no está disponible para guardar');
                return;
            }
            
            try {
                const conversationData = {
                    device_id: deviceId,
                    session_id: currentSessionId,
                    ip: userIP,
                    topic: currentTopic,
                    conversation_title: currentConversationTitle,
                    conversations: currentConversation,
                    browser_info: getBrowserInfo(),
                    updated_at: new Date().toISOString()
                };

                const { data, error } = await supabase
                    .from('chat_sessions')
                    .upsert(conversationData, { 
                        onConflict: 'session_id' 
                    });

                if (error) {
                    console.error('Error al guardar conversación:', error);
            } 
            } catch (error) {
                console.error('Error al guardar conversación:', error);
            }
        }

        function addMessage(text, sender, save = true) {
            // Si estamos en móvil y hay chat móvil visible, usar esa función
            if (isMobileView() && document.querySelector('.mobile-chat-area')?.style.display !== 'none') {
                addMobileMessage(text, sender, save);
                return;
            }
            
            // Código existente para desktop
            const messagesContainer = document.getElementById('chatMessages');
            
            // Marcar todos los mensajes existentes como antiguos
            const existingMessages = messagesContainer.querySelectorAll('.message:not(.loading-message)');
            existingMessages.forEach(msg => {
                if (!msg.classList.contains('old')) {
                    msg.classList.add('old');
                }
            });
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.textContent = text;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
            if (save) {
                currentConversation.push({
                    text: text,
                    sender: sender,
                    timestamp: new Date().toISOString()
                });
        
                saveConversationToSupabase();
        
                if (sender === 'user') {
                    setTimeout(() => loadPreviousConversations(), 1000);
                }
            }
        }

        function addMobileMessage(text, sender, save = true) {
            console.log('=== addMobileMessage ejecutada ===');
            console.log('Texto:', text, 'Sender:', sender);
            
            const mobileChatMessages = document.getElementById('mobileChatMessages');
            console.log('Mobile chat messages container:', mobileChatMessages);
            
            if (!mobileChatMessages) {
                console.error('ERROR: Mobile chat messages container not found');
                return;
            }
            
            // Marcar todos los mensajes existentes como antiguos
            const existingMessages = mobileChatMessages.querySelectorAll('.message:not(.loading-message)');
            existingMessages.forEach(msg => {
                if (!msg.classList.contains('old')) {
                    msg.classList.add('old');
                }
            });
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.textContent = text;
            mobileChatMessages.appendChild(messageDiv);
            setTimeout(() => scrollToLastMessage(), 100);
            
            console.log('Mensaje añadido al DOM');
            
            // Scroll al final
            mobileChatMessages.scrollTop = mobileChatMessages.scrollHeight;
            
            if (save) {
                currentConversation.push({
                    text: text,
                    sender: sender,
                    timestamp: new Date().toISOString()
                });
                
                saveConversationToSupabase();
                
                if (sender === 'user') {
                    setTimeout(() => loadPreviousConversations(), 1000);
                }
            }
            
            console.log('addMobileMessage completada');
        }

        function showLoading() {
            const messagesContainer = document.getElementById('chatMessages');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading-message';
            loadingDiv.id = 'loadingMessage';
            loadingDiv.innerHTML = '<div class="loader"></div>';
            messagesContainer.appendChild(loadingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideLoading() {
            const loadingMessage = document.getElementById('loadingMessage');
            if (loadingMessage) {
                loadingMessage.remove();
            }
        }

    

        function formatConversationAsText() {
            let conversationText = "Historial de conversación:\n\n";
            
            currentConversation.forEach((msg, index) => {
                const role = msg.sender === 'user' ? 'Usuario' : 'Luci';
                conversationText += `${role}: ${msg.text}\n\n`;
            });
            
            return conversationText;
        }
        
        function sendWebhook(message) {
            isWaitingForResponse = true;
            updateSendButton();
            showLoading();
            
            const conversationText = formatConversationAsText();
            const webhookData = {
                method: 'POST',
                url: 'https://luci-aura.app.n8n.cloud/webhook/c3b65321-b14c-47b5-80e2-0d6646bf00cd/chat', 
                data: {
                    conversation_text: conversationText,
                    current_message: message,
                    session_id: currentSessionId,
                    device_id: deviceId,
                    topic: currentTopic,
                    language: currentLanguage,
                    timestamp: new Date().toISOString(),
                    user_ip: userIP,
                    conversation_stats: {
                        total_messages: currentConversation.length,
                        user_messages: currentConversation.filter(m => m.sender === 'user').length,
                        assistant_messages: currentConversation.filter(m => m.sender === 'assistant').length
                    }
                }
            };


            fetch(webhookData.url, {
                method: webhookData.method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(webhookData.data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                return response.json();
            })
            .then(data => {
                hideLoading();
                
                // Actualizar topic si viene en la respuesta
                if (data.topic && data.topic !== currentTopic) {
                    currentTopic = data.topic;
                }

                // Actualizar título de conversación si viene en la respuesta
                if (data.conversation_title) {
                    currentConversationTitle = data.conversation_title;
                }

                 // Verificar si se espera un callback
                if (data.started_search === "yes") {
                    pendingCallback = true;
                    startRealtimeSubscription(currentSessionId);
                    startGridSearch();
                } else {
                    pendingCallback = false;
                }
                
                // Añadir respuesta del asistente
                addMessage(data.message || data.response || 'Respuesta recibida del servidor', 'assistant');
                isWaitingForResponse = false;
                updateSendButton();
            })
            .catch(error => {
                hideLoading();
                addErrorMessage('Error de conexión, inténtalo de nuevo más tarde');
                isWaitingForResponse = false;
                updateSendButton();
                console.error('Error:', error);
            });
        }

        function addErrorMessage(text) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message error';
            messageDiv.textContent = text;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Exponer función globalmente para el endpoint
        window.handleCallback = handleCallback;

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message && !isWaitingForResponse) {
                // Si no hay sesión actual, crear una nueva
                if (!currentSessionId) {
                    currentSessionId = generateSessionId();
                    currentConversation = [];
                    
                    // Si estamos en pantalla de bienvenida, cambiar a chat
                    if (document.getElementById('welcomeScreen').style.display !== 'none') {
                        showChatScreen();
                        const texts = translations[currentLanguage];
                        addMessage(texts.welcomeTitle, 'assistant');
                    }
                }

                addMessage(message, 'user');
                input.value = '';
                input.style.height = 'auto';
                sendWebhook(message);
            }
        }

        function sendWelcomeMessage() {
            const input = document.getElementById('welcomeChatInput');
            const message = input.value.trim();
            
            if (message && !isWaitingForResponse) {
                // Detener animación typing
                stopTypingAnimation();
                
                // Crear nueva sesión con topic fijo
                currentSessionId = generateSessionId();
                currentConversation = [];
                currentTopic = 'Buscar propiedades para comprar';
                
                // Crear transición del input
                createInputTransition(message, input);
            }
        }

        function sendMobileMessage() {
            console.log('=== sendMobileMessage ejecutada ===');
            
            const input = document.getElementById('mobileChatInput');
            const message = input.value.trim();
            
            console.log('Input encontrado:', input);
            console.log('Mensaje:', message);
            console.log('isWaitingForResponse:', isWaitingForResponse);
            
            if (message && !isWaitingForResponse) {
                console.log('Condiciones cumplidas, procesando mensaje...');
                
                // Detener animación typing móvil
                stopTypingAnimation();
                
                // Crear nueva sesión con topic fijo
                currentSessionId = generateSessionId();
                currentConversation = [];
                currentTopic = 'Buscar propiedades para comprar';
                
                console.log('Llamando a createMobileInputTransition...');
                // En móvil, cambiar directamente al chat sin transición
                createMobileInputTransition(message, input);
            } else {
                console.log('Condiciones NO cumplidas');
                if (!message) console.log('- No hay mensaje');
                if (isWaitingForResponse) console.log('- Esperando respuesta');
            }
        }
        
        function createMobileInputTransition(message, originalInput) {
            console.log('=== TRANSICIÓN MÓVIL INICIADA ===');
            
            const mobileWelcomeSection = document.querySelector('.mobile-welcome-section');
            const mobileInputArea = document.querySelector('.mobile-input-area');
            const mobileChatArea = document.querySelector('.mobile-chat-area');
            
            // 1. Desvanecer welcome section
            if (mobileWelcomeSection) {
                mobileWelcomeSection.classList.add('fade-out');
                console.log('Welcome section desvaneciendo...');
                
                // Ocultar completamente después de la transición
                setTimeout(() => {
                    mobileWelcomeSection.style.setProperty('display', 'none', 'important');
                }, 400);
            }
            
            // 2. Mostrar chat area con transición
            if (mobileChatArea) {
                mobileChatArea.style.setProperty('display', 'block', 'important');
                
                // Forzar reflow y activar transición
                setTimeout(() => {
                    mobileChatArea.classList.add('fade-in');
                    console.log('Chat area apareciendo...');
                }, 100);
            }
            
            // 3. Añadir mensajes
            setTimeout(() => {
                const texts = translations[currentLanguage];
                addMobileMessage(texts.welcomeTitle, 'assistant');
                addMobileMessage(message, 'user');
                
                // 4. Scroll automático a la última respuesta
                scrollToLastMessage();
                
                // Limpiar input
                originalInput.value = '';
                
                // Enviar webhook
                sendWebhook(message);
            }, 200);
        }

        function scrollToLastMessage() {
            const mobileChatArea = document.querySelector('.mobile-chat-area');
            if (mobileChatArea) {
                setTimeout(() => {
                    mobileChatArea.scrollTo({
                        top: mobileChatArea.scrollHeight,
                        behavior: 'smooth'
                    });
                }, 100);
            }
        }
        
        function createInputTransition(message, originalInput) {
            // Crear overlay
            const overlay = document.createElement('div');
            overlay.className = 'transition-overlay';
            const chatColumn = document.querySelector('.chat-column');
            chatColumn.appendChild(overlay);
            
            // Obtener el wrapper del input original
            const originalWrapper = originalInput.closest('.chat-input-wrapper');
            const wrapperRect = originalWrapper.getBoundingClientRect();
            
            // Crear una copia del input wrapper para la transición
            const transitionInput = document.createElement('div');
            transitionInput.className = 'input-transition';
            transitionInput.style.left = wrapperRect.left + 'px';
            transitionInput.style.top = wrapperRect.top + 'px';
            transitionInput.style.width = wrapperRect.width + 'px';
            transitionInput.style.height = wrapperRect.height + 'px';
            transitionInput.style.display = 'flex';
            transitionInput.style.alignItems = 'flex-end';
            
            // Crear textarea con el contenido
            const textarea = document.createElement('textarea');
            textarea.className = 'chat-input';
            textarea.value = message;
            textarea.readOnly = true;
            textarea.rows = 1;
            
            // Crear botón
            const button = document.createElement('button');
            button.className = 'send-button';
            button.innerHTML = '➤';
            
            transitionInput.appendChild(textarea);
            transitionInput.appendChild(button);
            document.body.appendChild(transitionInput);
            
            // Ocultar el input original
            originalWrapper.style.opacity = '0';
            
            // Activar overlay
            setTimeout(() => {
                overlay.classList.add('active');
            }, 50);
            
            // Cambiar a pantalla de chat (preparar destino)
            setTimeout(() => {
                showChatScreen();
                
                // Añadir mensaje del asistente (oculto por ahora)
                const texts = translations[currentLanguage];
                addMessage(texts.welcomeTitle, 'assistant');
                
                // Obtener la posición final del input del chat
                const chatInputContainer = document.querySelector('.chat-input-container');
                const chatInputWrapper = chatInputContainer.querySelector('.chat-input-wrapper');
                const finalRect = chatInputWrapper.getBoundingClientRect();
                
                // Ocultar temporalmente el input del chat
                chatInputWrapper.style.opacity = '0';
                
                // Animar el input a su posición final
                transitionInput.style.left = finalRect.left + 'px';
                transitionInput.style.top = finalRect.top + 'px';
                transitionInput.style.width = finalRect.width + 'px';
                transitionInput.style.height = finalRect.height + 'px';
                
                // Después de la animación
                setTimeout(() => {
                    // Añadir mensaje del usuario al chat
                    addMessage(message, 'user');
                    
                    // Mostrar el input del chat real
                    chatInputWrapper.style.opacity = '1';
                    
                    // Limpiar input del chat
                    const chatInput = document.getElementById('chatInput');
                    if (chatInput) {
                        chatInput.value = '';
                        chatInput.style.height = 'auto';
                    }
                    
                    // Quitar elementos de transición
                    transitionInput.remove();
                    overlay.remove();
                    
                    // Restaurar input original (por si vuelven a bienvenida)
                    originalWrapper.style.opacity = '1';
                    originalInput.value = '';
                    
                    // Enviar webhook
                    sendWebhook(message);
                }, 800);
                
            }, 300);
        }
        
        function updateSendButton() {
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = isWaitingForResponse;
        }

        function newChat() {
            // Limpiar suscripción activa
            if (realtimeChannel) {
                try {
                    supabase.removeChannel(realtimeChannel);
                    realtimeChannel.unsubscribe();
                } catch (error) {
                    console.log('Error limpiando canal en newChat:', error);
                }
                realtimeChannel = null;
            }
            currentSessionId = null;
            currentConversation = [];
            currentTopic = null;
            pendingCallback = false;
            
            // Mostrar pantalla de bienvenida
            const welcomeScreen = document.getElementById('welcomeScreen');
            const chatScreen = document.getElementById('chatScreen');
            
            chatScreen.style.display = 'none';
            chatScreen.classList.remove('fade-in');
            welcomeScreen.style.display = 'flex';
            welcomeScreen.classList.remove('fade-out');
        
            // Limpiar mensajes
            document.getElementById('chatMessages').innerHTML = '';
        
            shownTimeoutPopups.clear();
        }

        // Event listeners
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Auto-resize textarea
        document.getElementById('chatInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Endpoint para recibir callbacks de n8n
        if (typeof window !== 'undefined') {
            // Crear endpoint simulado usando postMessage para desarrollo local
            window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'n8n_callback') {
                    handleCallback(event.data.payload);
                }
            });
            
            // Endpoint real para producción (esto requerirá configuración adicional en Vercel)
            window.callbackEndpoint = function(data) {
                return handleCallback(data);
            };
        }
        
        // Para desarrollo: función de prueba del callback
        window.testCallback = function(message) {
            const testData = {
                message: message || 'Mensaje de prueba del callback',
                topic: currentTopic
            };
            return handleCallback(testData);
        };     
    
        
        function formatPrice(price) {
            return new Intl.NumberFormat('es-ES', {
                style: 'currency',
                currency: 'EUR',
                maximumFractionDigits: 0
            }).format(price);
        }
     
  
        function sendEmailNotification() {
            const email = document.getElementById('timeoutEmail').value;
            const texts = translations[currentLanguage];
            
            if (!email) {
                const alertText = currentLanguage === 'spanish' ? 'Por favor, introduce un email válido' : 
                                 currentLanguage === 'english' ? 'Please enter a valid email' : 
                                 'Veuillez entrer un email valide';
                alert(alertText);
                return;
            }
            
            // Validar formato de email básico
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                const alertText = currentLanguage === 'spanish' ? 'Por favor, introduce un email válido' : 
                                 currentLanguage === 'english' ? 'Please enter a valid email' : 
                                 'Veuillez entrer un email valide';
                alert(alertText);
                return;
            }
            
            console.log('Enviando notificación de timeout a:', email);
            
            // Preparar datos para el webhook según el formato especificado
            const webhookData = {
                session_id: currentSessionId || 'unknown',
                nombre: 'Timeout',
                contact_method: 'email',
                phone_or_email: email,
                liked_property: 'no_properties',
                all_shown_properties: []
            };
            
            // Enviar webhook
            fetch('https://luci-aura.app.n8n.cloud/webhook/5da544a2-525c-44d4-8647-3efac12a9e99', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(webhookData)
            })
            .then(response => {
                console.log('Webhook de timeout enviado exitosamente');
                if (!response.ok) {
                    console.warn('Respuesta del webhook no OK:', response.status);
                }
            })
            .catch(error => {
                console.error('Error enviando webhook de timeout:', error);
                // Intentar con FormData como fallback
                const formData = new FormData();
                formData.append('session_id', webhookData.session_id);
                formData.append('nombre', webhookData.nombre);
                formData.append('contact_method', webhookData.contact_method);
                formData.append('phone_or_email', webhookData.phone_or_email);
                formData.append('liked_property', webhookData.liked_property);
                formData.append('all_shown_properties', JSON.stringify(webhookData.all_shown_properties));
                
                fetch('https://luci-aura.app.n8n.cloud/webhook/5da544a2-525c-44d4-8647-3efac12a9e99', {
                    method: 'POST',
                    mode: 'no-cors',
                    body: formData
                })
                .then(() => {
                    console.log('Webhook de timeout enviado con FormData (fallback)');
                })
                .catch(fallbackError => {
                    console.error('Error en fallback del webhook de timeout:', fallbackError);
                });
            });
            
            // Cerrar popup
            const popup = document.getElementById('timeoutPopup');
            if (popup) popup.remove();
            
            // Mostrar mensaje al usuario
            addMessage(texts.timeoutEmailSent, 'assistant');
        }
        
        // Función para mostrar popup de información de contacto
        function showContactInfoPopup(propertyTitle) {
            const popup = document.createElement('div');
            popup.className = 'popup-overlay';
            popup.id = 'contactInfoPopup';
            
            popup.innerHTML = `
                <div class="popup-content">
                    <div class="popup-title">¡Gracias por tu interés en esta propiedad!</div>
                    <p>Te enviaremos los datos completos al método de envío que selecciones a continuación</p>
                    
                    <input type="text" class="popup-input" id="userName" placeholder="Tu nombre">
                    
                    <p style="margin: 20px 0 10px 0;">Elige entre estos dos métodos de envío:</p>
                    
                    <div class="contact-method-buttons">
                        <button class="contact-method-btn" id="whatsappBtn" onclick="selectContactMethod('whatsapp')">WhatsApp</button>
                        <button class="contact-method-btn" id="emailBtn" onclick="selectContactMethod('email')">Email</button>
                    </div>
                    
                    <div id="contactInput" style="display: none;">
                        <div class="input-with-send">
                            <input type="text" class="popup-input" id="contactValue" placeholder="">
                            <button class="send-icon-btn" onclick="sendContactInfo('${propertyTitle}')">➤</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(popup);
            popup.style.display = 'flex';
            
            // Cerrar con click fuera
            popup.addEventListener('click', function(e) {
                if (e.target === popup) {
                    popup.remove();
                }
            });
        }
        
        function selectContactMethod(method) {
            const whatsappBtn = document.getElementById('whatsappBtn');
            const emailBtn = document.getElementById('emailBtn');
            const contactInput = document.getElementById('contactInput');
            const contactValue = document.getElementById('contactValue');
            
            // Resetear selección
            whatsappBtn.classList.remove('selected');
            emailBtn.classList.remove('selected');
            
            // Seleccionar método
            if (method === 'whatsapp') {
                whatsappBtn.classList.add('selected');
                contactValue.placeholder = 'Tu número de WhatsApp';
                contactValue.type = 'tel';
            } else {
                emailBtn.classList.add('selected');
                contactValue.placeholder = 'Tu email';
                contactValue.type = 'email';
            }
            
            contactInput.style.display = 'block';
        }
        
        function sendContactInfo(propertyTitle) {
            const name = document.getElementById('userName').value;
            const contactValue = document.getElementById('contactValue').value;
            const method = document.getElementById('whatsappBtn').classList.contains('selected') ? 'whatsapp' : 'email';
            
            if (!name || !contactValue) {
                alert('Por favor, completa todos los campos');
                return;
            }
            
            // Preparar datos para el webhook en formato FormData
            const formData = new FormData();
            formData.append('session_id', currentSessionId);
            formData.append('nombre', name);
            formData.append('contact_method', method);
            formData.append('phone_or_email', contactValue);
            formData.append('liked_property', window.currentPropertyId || 'unknown');
            formData.append('all_shown_properties', JSON.stringify(shownProperties));
            
            // Enviar webhook usando FormData
            fetch('https://luci-aura.app.n8n.cloud/webhook/5da544a2-525c-44d4-8647-3efac12a9e99', {
                method: 'POST',
                mode: 'no-cors',
                body: formData
            })
            .then(() => {
                console.log('Webhook de contacto enviado');
            })
            .catch(error => {
                console.error('Error enviando webhook de contacto:', error);
            });
            
            // Cerrar popup
            const popup = document.getElementById('contactInfoPopup');
            if (popup) popup.remove();
            
            // Mostrar popup de agradecimiento
            showThankYouPopup();
        }

        function showThankYouPopup() {
            // Crear popup de agradecimiento
            const popup = document.createElement('div');
            popup.className = 'popup-overlay';
            popup.id = 'thankYouPopup';
            popup.style.opacity = '0';
            popup.style.transition = 'opacity 0.3s ease-in-out';
            
            popup.innerHTML = `
                <div class="popup-content" style="text-align: center; max-width: 600px;">
                    <div class="popup-title">¡Gracias por tu interés!</div>
                    <p style="margin: 20px 0; line-height: 1.5;">
                        En breve te mandaremos la información completa por la vía que has elegido. 
                        Tardamos un máximo de 5 minutos.<br><br>
                        Si no hubieras recibido la información en este tiempo, ponte en contacto con nosotros a través de email, en 
                        <strong>info@aura-app.es</strong> o en el teléfono <strong>910 62 66 48</strong>
                    </p>
                </div>
            `;
            
            document.body.appendChild(popup);
            popup.style.display = 'flex';
            
            // Fade in
            setTimeout(() => {
                popup.style.opacity = '1';
            }, 100);
            
            // Fade out y eliminar después de 10 segundos
            setTimeout(() => {
                popup.style.opacity = '0';
                setTimeout(() => {
                    if (popup && popup.parentNode) {
                        popup.remove();
                    }
                }, 300);
            }, 10000);
            
            // Permitir cerrar con click
            popup.addEventListener('click', function(e) {
                if (e.target === popup) {
                    popup.style.opacity = '0';
                    setTimeout(() => {
                        if (popup && popup.parentNode) {
                            popup.remove();
                        }
                    }, 300);
                }
            });
        }

        function openImageZoom(imageSrc) {
            const modal = document.createElement('div');
            modal.className = 'image-zoom-modal';
            modal.innerHTML = `
                <span class="zoom-close">&times;</span>
                <img src="${imageSrc}" alt="Imagen ampliada">
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'flex';
            
            // Cerrar con click
            modal.addEventListener('click', function() {
                modal.remove();
            });
            
            // Cerrar con Escape
            const escapeHandler = function(e) {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
        }

        // Función para mostrar popup de funcionalidad no disponible
        function showNotAvailablePopup() {
            const popup = document.createElement('div');
            popup.className = 'not-available-popup';
            popup.id = 'notAvailablePopup';
            
            popup.innerHTML = `
                <div class="not-available-content">
                    <div class="not-available-title">Funcionalidad no disponible</div>
                    <p>Esta funcionalidad estará disponible próximamente.</p>
                    <button class="not-available-btn" onclick="closeNotAvailablePopup()">
                        Entendido
                    </button>
                </div>
            `;
            
            document.body.appendChild(popup);
            popup.style.display = 'flex';
            
            // Cerrar con click fuera
            popup.addEventListener('click', function(e) {
                if (e.target === popup) {
                    closeNotAvailablePopup();
                }
            });
        }
        
        function closeNotAvailablePopup() {
            const popup = document.getElementById('notAvailablePopup');
            if (popup) {
                popup.remove();
            }
        }

       

        function showWelcomeScreen() {
            const welcomeScreen = document.getElementById('welcomeScreen');
            const chatScreen = document.getElementById('chatScreen');
            
            chatScreen.style.display = 'none';
            chatScreen.classList.remove('fade-in');
            welcomeScreen.style.display = 'flex';
            welcomeScreen.classList.remove('fade-out');
        }
        
        function startNewChat() {
            // Limpiar suscripción activa
            if (realtimeChannel) {
                try {
                    supabase.removeChannel(realtimeChannel);
                    realtimeChannel.unsubscribe();
                } catch (error) {
                    console.log('Error limpiando canal en newChat:', error);
                }
                realtimeChannel = null;
            }
            
            // Resetear variables de sesión
            currentSessionId = null;
            currentConversation = [];
            currentTopic = null;
            pendingCallback = false;
            
            // Resetear título de conversación
            document.getElementById('conversationTitle').textContent = 'Nuevo chat';
            
            // Mostrar pantalla de bienvenida
            const welcomeScreen = document.getElementById('welcomeScreen');
            const chatScreen = document.getElementById('chatScreen');
            
            chatScreen.style.display = 'none';
            chatScreen.classList.remove('fade-in');
            welcomeScreen.style.display = 'flex';
            welcomeScreen.classList.remove('fade-out');
        
            // Limpiar mensajes
            document.getElementById('chatMessages').innerHTML = '';
        
            shownTimeoutPopups.clear();
            
            console.log('Nuevo chat iniciado');

            // Reiniciar animación typing
            setTimeout(() => {
                resumeTypingAnimation();
            }, 500);
            
            console.log('Nuevo chat iniciado');
        }
        
        function showChatInterface() {
            const welcomeScreen = document.getElementById('welcomeScreen');
            const chatScreen = document.getElementById('chatScreen');
            
            // Si ya estamos en chat, no hacer nada
            if (chatScreen.style.display === 'flex') {
                return;
            }
            
            // Si no hay conversación activa, mostrar la pantalla de bienvenida
            if (!currentConversation || currentConversation.length === 0) {
                welcomeScreen.style.display = 'flex';
                chatScreen.style.display = 'none';
            } else {
                // Si hay conversación, mostrar el chat
                welcomeScreen.style.display = 'none';
                chatScreen.style.display = 'flex';
                chatScreen.classList.add('fade-in');
            }
        }
       
        // Función para limpiar el chat
        function clearChat() {
            const messagesContainer = document.querySelector('.chat-messages');
            if (messagesContainer) {
                messagesContainer.innerHTML = '';
            }
            
            // Limpiar historial de la sesión
            window.conversationHistory = [];
        }
     
        
        // =================== POPUP CREAR CUENTA ===================
        function showLoginPopup() {
            console.log('=== EJECUTANDO showLoginPopup ===');
            
            const popup = document.getElementById('loginPopup');
            console.log('Popup encontrado:', popup);
            
            if (popup) {
                popup.style.display = 'flex';
                console.log('Popup mostrado exitosamente');
                
                // Forzar reflow para asegurar que se muestre
                popup.offsetHeight;
                
                // Verificar que se mostró
                const computedStyle = window.getComputedStyle(popup);
                console.log('Display del popup después de mostrar:', computedStyle.display);
            } else {
                console.error('¡Popup con ID loginPopup no encontrado!');
                
                // Listar todos los popups disponibles
                const allPopups = document.querySelectorAll('[id*="popup"], [class*="popup"]');
                console.log('Popups disponibles:', allPopups);
            }
        }
        
        function closeLoginPopup() {
            document.getElementById('loginPopup').style.display = 'none';
        }

        function selectLoginMethod(method) {
            currentLoginMethod = method;
            const buttons = document.querySelectorAll('.login-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            if (method === 'whatsapp') {
                buttons[0].classList.add('active');
                document.getElementById('whatsappLogin').style.display = 'block';
                document.getElementById('emailLogin').style.display = 'none';
            } else {
                buttons[1].classList.add('active');
                document.getElementById('whatsappLogin').style.display = 'none';
                document.getElementById('emailLogin').style.display = 'block';
            }
        }
        
        // Verificar sesión existente al cargar la página
        async function checkExistingSession() {
            if (!supabase) {
                console.log('Supabase no inicializado, saltando verificación de sesión');
                return;
            }
            
            try {
                const { data: { session } } = await supabase.auth.getSession();
                
                if (session && session.user) {
                    console.log('Sesión existente encontrada:', session.user);
                    // updateUserProfile(session.user); // Comentar esta línea si la función no existe
                }
            } catch (error) {
                console.error('Error verificando sesión:', error);
            }
        }
                
        // =================== FUNCIONES SIDEBAR ===================
        function initSidebar() {
            console.log('=== INICIALIZANDO SIDEBAR ===');
            
            // Verificar que el popup existe
            const loginPopup = document.getElementById('loginPopup');
            console.log('Popup de login encontrado:', loginPopup);
            
            // Obtener todas las opciones de la sidebar
            const options = document.querySelectorAll('.sidebar-option');
            console.log('Opciones de sidebar encontradas:', options.length);
            
            // Listar todas las opciones encontradas
            options.forEach((option, index) => {
                const optionName = option.dataset.option;
                console.log(`Opción ${index + 1}: ${optionName}`);
            });
            
            // Remover event listeners existentes (si los hay)
            options.forEach(option => {
                const newOption = option.cloneNode(true);
                option.parentNode.replaceChild(newOption, option);
            });
            
            // Obtener las opciones refrescadas después del cloning
            const refreshedOptions = document.querySelectorAll('.sidebar-option');
            
            // Manejar clicks en opciones de la sidebar
            refreshedOptions.forEach((option, index) => {
                const optionName = option.dataset.option;
                
                option.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log(`=== CLICK EN SIDEBAR ===`);
                    console.log('Opción clickeada:', optionName);
                    console.log('Elemento clickeado:', this);
                    
                    if (optionName === 'propiedades') {
                        console.log('Opción propiedades - gestionando sub-sidebar');
                        
                        // Si la sidebar está expandida, contraerla primero
                        const sidebar = document.getElementById('sidebar');
                        const container = document.querySelector('.container');
                        
                        if (sidebar.classList.contains('expanded')) {
                            // Contraer sidebar principal
                            sidebar.classList.remove('expanded');
                            container.classList.remove('sidebar-expanded');
                        }
                        
                        // Activar propiedades ANTES de mostrar sub-sidebar
                        setActiveSidebarOption('propiedades');
                        
                        // Luego mostrar/ocultar sub-sidebar
                        togglePropertiesSubSidebar();
                        
                    } else {
                        console.log('Opción NO propiedades - mostrando login popup');
                        
                        // Verificar que la función existe
                        if (typeof showLoginPopup === 'function') {
                            console.log('Función showLoginPopup existe, ejecutando...');
                            showLoginPopup();
                        } else {
                            console.error('Función showLoginPopup no existe!');
                        }
                        
                        return false;
                    }
                });
                
                console.log(`Event listener añadido a: ${optionName}`);
            });
            
            // Inicializar sub-sidebar
            initPropertiesSubSidebar();
        
            // Manejar expand arrow
            const expandArrow = document.querySelector('.expand-arrow');
            if (expandArrow) {
                expandArrow.addEventListener('click', toggleSidebar);
                console.log('Event listener añadido a expand arrow');
            }
            
            console.log('=== SIDEBAR INICIALIZADA ===');

            setTimeout(() => {
                // Asegurar que no hay opción activa al inicio
                activeSidebarOption = null;
                
                // Remover cualquier clase active del HTML
                document.querySelectorAll('.sidebar-option').forEach(opt => {
                    opt.classList.remove('active');
                });
                
                // Actualizar iconos a estado inactivo
                updateSidebarIcons();
                updateSubSidebarIcons(null);
                
                console.log('Sidebar inicializada con estado limpio');
            }, 100);
        }
        
        // Función para detectar si estamos en móvil
        function isMobile() {
            return window.innerWidth <= 768;
        }
        
        // Función para expandir/contraer sidebar
        function toggleSidebar() {
            // Si estamos en móvil, no hacer nada
            if (isMobile()) {
                console.log('Toggle sidebar deshabilitado en móvil');
                return;
            }
            
            const sidebar = document.getElementById('sidebar');
            const container = document.querySelector('.container');
            
            // Guardar el estado activo ANTES de cualquier cambio
            const currentActiveOption = activeSidebarOption;
            console.log('Estado activo antes de toggle:', currentActiveOption);
            
            // Si la sub-sidebar está activa, ocultarla primero
            const subSidebar = document.getElementById('propertiesSubSidebar');
            if (subSidebar && subSidebar.classList.contains('active')) {
                hidePropertiesSubSidebar();
                // Restaurar el estado activo después de ocultar sub-sidebar
                if (currentActiveOption) {
                    activeSidebarOption = currentActiveOption;
                }
            }
            
            sidebar.classList.toggle('expanded');
            container.classList.toggle('sidebar-expanded');
            
            // Restaurar el estado activo después de expandir/contraer
            if (currentActiveOption) {
                setTimeout(() => {
                    console.log('Restaurando estado activo:', currentActiveOption);
                    setActiveSidebarOption(currentActiveOption);
                }, 100);
            }
            
            // Actualizar tooltip del botón
            const expandArrow = document.querySelector('.expand-arrow');
            if (expandArrow) {
                if (sidebar.classList.contains('expanded')) {
                    expandArrow.setAttribute('data-tooltip', 'Contraer');
                } else {
                    expandArrow.setAttribute('data-tooltip', 'Expandir');
                }
            }
        }
        
        // Función para limpiar estados de expansión al cambiar a móvil
        function handleResizeToMobile() {
            if (isMobile()) {
                const sidebar = document.getElementById('sidebar');
                const container = document.querySelector('.container');
                
                // Remover clases de expansión si existen
                if (sidebar) {
                    sidebar.classList.remove('expanded');
                }
                if (container) {
                    container.classList.remove('sidebar-expanded');
                }
                
                console.log('Estados de expansión limpiados para móvil');
            }
            
            // AÑADIR: Manejar visibilidad móvil
            handleMobileDisplay();
        }
        
        
        function setActiveSidebarOption(optionName) {
            console.log('Estableciendo opción activa:', optionName);
            
            // Actualizar variable global
            activeSidebarOption = optionName;
            
            // Remover clase active de todas las opciones
            document.querySelectorAll('.sidebar-option').forEach(opt => {
                opt.classList.remove('active');
            });
            
            // Añadir clase active a la opción seleccionada
            if (optionName) {
                const selectedOption = document.querySelector(`[data-option="${optionName}"]`);
                if (selectedOption) {
                    selectedOption.classList.add('active');
                    console.log('Opción marcada como activa:', optionName);
                } else {
                    console.warn('No se encontró la opción:', optionName);
                }
            }
            
            // Actualizar iconos
            updateSidebarIcons();
        }
        
        function updateSidebarIcons() {
            // Actualizar iconos según el estado activo/inactivo
            Object.keys(iconStates).forEach(optionName => {
                const option = document.querySelector(`[data-option="${optionName}"]`);
                const icon = option?.querySelector('.sidebar-icon');
                
                if (icon) {
                    if (optionName === activeSidebarOption) {
                        // Usar icono activo
                        icon.src = iconStates[optionName].active;
                    } else {
                        // Usar icono inactivo
                        icon.src = iconStates[optionName].inactive;
                    }
                }
            });
        }

    function openPropertyDetail(propertyId) {
        // Datos hardcodeados de las 9 propiedades destacadas
        const propertyData = {
            1: {
                title: "Ático en la Calle San Bernardo",
                location: "Palacio, Madrid",
                price: 1480000,
                pricePerSqm: 7668,
                priceComparison: "2% por debajo de la media de precios de la zona",
                builtArea: 193,
                usefulArea: 193,
                bedrooms: 4,
                bathrooms: 3,
                lat: 40.4271276,
                lng: -3.7090447,
                images: [
                    "https://f003.backblazeb2.com/b2api/v1/b2_download_file_by_id?fileId=4_z8d6e5dd5a5cccbf59d6b0816_f111c9c7653cb0e93_d20250710_m075738_c003_v0312029_t0056_u01752134258027",
                    "https://f003.backblazeb2.com/b2api/v1/b2_download_file_by_id?fileId=4_z8d6e5dd5a5cccbf59d6b0816_f108148655c92f14e_d20250710_m075738_c003_v0312006_t0012_u01752134258167",
                    "https://f003.backblazeb2.com/b2api/v1/b2_download_file_by_id?fileId=4_z8d6e5dd5a5cccbf59d6b0816_f109c229b2e483ef1_d20250710_m075737_c003_v0312030_t0047_u01752134257742",
                    "https://f003.backblazeb2.com/b2api/v1/b2_download_file_by_id?fileId=4_z8d6e5dd5a5cccbf59d6b0816_f1018df8439e96569_d20250710_m075735_c003_v0312026_t0021_u01752134255919",
                    "https://f003.backblazeb2.com/b2api/v1/b2_download_file_by_id?fileId=4_z8d6e5dd5a5cccbf59d6b0816_f115d407cf7494da2_d20250710_m075735_c003_v0312030_t0045_u01752134255810",
                    "https://f003.backblazeb2.com/b2api/v1/b2_download_file_by_id?fileId=4_z8d6e5dd5a5cccbf59d6b0816_f117377c1f2e3d498_d20250710_m075735_c003_v0312027_t0048_u01752134255686",
                    "https://f003.backblazeb2.com/b2api/v1/b2_download_file_by_id?fileId=4_z8d6e5dd5a5cccbf59d6b0816_f101dd24dad0d27f8_d20250710_m075737_c003_v0312006_t0001_u01752134257587",
                    "https://f003.backblazeb2.com/b2api/v1/b2_download_file_by_id?fileId=4_z8d6e5dd5a5cccbf59d6b0816_f11520901c09c86fb_d20250710_m075737_c003_v0312029_t0024_u01752134257453",
                    "https://f003.backblazeb2.com/b2api/v1/b2_download_file_by_id?fileId=4_z8d6e5dd5a5cccbf59d6b0816_f11520901c09c86e7_d20250710_m075737_c003_v0312029_t0058_u01752134257129",
                    "https://f003.backblazeb2.com/b2api/v1/b2_download_file_by_id?fileId=4_z8d6e5dd5a5cccbf59d6b0816_f103615958493990d_d20250710_m075736_c003_v0312030_t0056_u01752134256882",
                    "https://f003.backblazeb2.com/b2api/v1/b2_download_file_by_id?fileId=4_z8d6e5dd5a5cccbf59d6b0816_f110e59e4d8226765_d20250710_m075736_c003_v0312029_t0026_u01752134256795",
                    "https://f003.backblazeb2.com/b2api/v1/b2_download_file_by_id?fileId=4_z8d6e5dd5a5cccbf59d6b0816_f107dc00bfc03aaa4_d20250710_m075736_c003_v0312030_t0010_u01752134256646",
                    "https://f003.backblazeb2.com/b2api/v1/b2_download_file_by_id?fileId=4_z8d6e5dd5a5cccbf59d6b0816_f101f8e484316ca95_d20250710_m075736_c003_v0312030_t0037_u01752134256510",
                    "https://f003.backblazeb2.com/b2api/v1/b2_download_file_by_id?fileId=4_z8d6e5dd5a5cccbf59d6b0816_f102ec6766fcecf04_d20250710_m075736_c003_v0312025_t0042_u01752134256115",
                    "https://f003.backblazeb2.com/b2api/v1/b2_download_file_by_id?fileId=4_z8d6e5dd5a5cccbf59d6b0816_f106644fc076e3ffd_d20250710_m075737_c003_v0312029_t0005_u01752134257877",
                    "https://f003.backblazeb2.com/b2api/v1/b2_download_file_by_id?fileId=4_z8d6e5dd5a5cccbf59d6b0816_f1040b92a63110d18_d20250710_m075735_c003_v0312025_t0037_u01752134255458",
                    "https://f003.backblazeb2.com/b2api/v1/b2_download_file_by_id?fileId=4_z8d6e5dd5a5cccbf59d6b0816_f113a34687de01619_d20250710_m075735_c003_v0312022_t0030_u01752134255361",
                    "https://f003.backblazeb2.com/b2api/v1/b2_download_file_by_id?fileId=4_z8d6e5dd5a5cccbf59d6b0816_f1101264d7de44031_d20250710_m075735_c003_v0312028_t0031_u01752134255211",
                    "https://f003.backblazeb2.com/b2api/v1/b2_download_file_by_id?fileId=4_z8d6e5dd5a5cccbf59d6b0816_f10119252554c7a45_d20250710_m075735_c003_v0312024_t0053_u01752134255036",
                    "https://f003.backblazeb2.com/b2api/v1/b2_download_file_by_id?fileId=4_z8d6e5dd5a5cccbf59d6b0816_f1159b3b4a075cc4c_d20250710_m075735_c003_v0312026_t0010_u01752134255579",
                    "https://f003.backblazeb2.com/b2api/v1/b2_download_file_by_id?fileId=4_z8d6e5dd5a5cccbf59d6b0816_f1113cb5c48b3d9c3_d20250710_m075734_c003_v0312018_t0019_u01752134254731"
                ],
                description: "Ático exclusivo en el corazón de Madrid: Una oportunidad única para vivir en un espectacular ático exterior de 193 m², completamente reformado y recién amueblado con piezas de diseño, listo para entrar a vivir. Sus 4 dormitorios, 3 baños y espacios amplios y luminosos ofrecen el máximo confort y estilo. Al ser un ático en la quinta planta, disfruta de abundante luz natural durante todo el día, vistas despejadas sobre los tejados de la ciudad y una privacidad excepcional. Ubicado en una finca clásica con ascensor, cuenta con 4 balcones, detalles arquitectónicos singulares y modernas instalaciones domóticas. A solo dos minutos de Gran Vía, en una zona vibrante y perfectamente comunicada. Ven a descubrir esta joya antes de que te la quiten."
            },
            2: {
                title: "Piso en venta en avenida de la Marina, 5",
                location: "Puerto de Sotogrande-La Marina, Sotogrande",
                price: 332000,
                pricePerSqm: 2338,
                priceComparison: "9% por debajo de la media de precios de la zona",
                builtArea: 142,
                usefulArea: 142,
                bedrooms: 2,
                bathrooms: 2,
                lat: 36.2874961,
                lng: -5.2828522,
                images: [
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/be/b2/f1/1217657644.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/f4/c7/a1/1217657634.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/04/d1/fb/1217657636.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/2d/91/23/1217657638.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/a9/74/c1/1217657639.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/4e/28/61/1217657640.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/98/f2/5e/1217657641.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/8b/14/46/1217657642.webp"
                ],
                description: "Sin comisión de Agencia! Vendemos un lote de apartamentos. Pisos chollo. Desde 332.000€ (Alquilado) Últimas unidades, ya hemos vendido la mayoría de la promoción. Solo quedan 2 libres y alquilados. Esta promoción de viviendas a estrenar te ofrece la oportunidad de vivir en un entorno privilegiado, con precios desde 332.000€. Disponemos de pisos con 2 y 3 habitaciones, perfectos para adaptarse a tus necesidades. Con amplios espacios que varían entre 140 y 180 metros construidos, disfrutarás de una comodidad sin igual. Cada vivienda cuenta con terrazas de 20 a 50 metros, ideales para relajarte al aire libre. Además, los armarios empotrados, suelos de mármol y calefacción garantizan un confort absoluto. Aunque se venden sin amueblar, incluyen plaza de parking y trastero, añadiendo un valor extra a tu inversión. La ubicación es simplemente inmejorable: cercana a la playa, campos de golf y servicios de primer nivel. Este piso en particular tiene 142 m² construidos, 2 dormitorios y 2 baños, y está en excelente estado a pesar de ser de segunda mano (año de construcción: 2006). Situado en un bajo exterior con orientación oeste, cuenta con ascensor, aire acondicionado, calefacción eléctrica (bomba de frío/calor), piscina y jardín. No pierdas la oportunidad de vivir en uno de los lugares más exclusivos del sur de España. ¡Visítalo y llama para más información!"
            },
            3: {
                title: "Piso en venta en Av Puerto Sotogrande (ps), 26",
                location: "Puerto de Sotogrande-La Marina, Sotogrande",
                price: 489000,
                pricePerSqm: 2794,
                priceComparison: "1% por debajo de la media de precios de la zona",
                builtArea: 174,
                usefulArea: 174,
                bedrooms: 3,
                bathrooms: 2,
                lat: 36.2871823,
                lng: -5.2825606,
                images: [
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/47/aa/2a/1217657655.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/1c/87/26/1217657656.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/75/16/da/1217657654.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/bc/ce/c8/1217657664.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/48/29/c2/1217657666.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/8c/c9/d4/1217657672.webp"
                ],
                description: "Piso reformado con 3 habitaciones, dos plazas de garaje, trastero y piscina. Se vende este piso recién reformado, muy luminoso y con una distribución cómoda. Tiene tres habitaciones, dos plazas de garaje, trastero y acceso a piscina comunitaria. La reforma es reciente y se entrega amueblado y con todos los electrodomésticos incluidos, decorado con mucho gusto, se puede entrar a vivir desde el día 1. Está en un edificio tranquilo, bien mantenido y con buena orientación, lo que hace que tenga mucha luz natural durante el día. Ideal tanto para vivir como para invertir y alquilar desde el primer momento. Contactar para más información!"
            },
            4: {
                title: "Chalet adosado en venta en avenida Pernet, 23",
                location: "Nueva Atalaya, Estepona",
                price: 459000,
                pricePerSqm: 2022,
                priceComparison: "1% por encima de la media de precios de la zona",
                builtArea: 227,
                usefulArea: 227,
                bedrooms: 3,
                bathrooms: 3,
                lat: 36.4726642,
                lng: -5.0179132,
                images: [
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/0e/a6/38/1305149519.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/2c/93/90/1305149507.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/2d/4a/df/1305149428.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/36/84/8d/1305149553.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/3b/d8/21/1305149551.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/3d/bc/71/1305149506.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/44/49/4e/1305149431.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/54/38/a5/1305149509.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/69/f0/4b/1305149505.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/6b/e6/c4/1305149554.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/76/49/e9/1305149427.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/79/0a/ee/1305149518.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/8e/ba/7d/1305149432.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/92/66/4e/1305149426.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/9d/66/84/1305149430.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/b9/12/ce/1305149550.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/c6/a4/c8/1305149422.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/c9/db/5e/1305149517.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/d0/a0/c6/1305149563.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/d5/29/6e/1305149516.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/d9/5a/88/1305149515.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/ee/e9/96/1305149429.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/fc/90/da/1305149508.webp"
                ],
                description: "Sin Comisión de Agencia! Se vende encantadora casa adosada en la codiciada zona de Monte Biarritz, a tan solo 5 minutos de la playa. Esta propiedad, recién reformada, ofrece un entorno moderno y confortable, ideal para quienes buscan calidad y estilo. La casa dispone de 3 habitaciones y 3 baños, perfectos para acomodar tanto a familias como a aquellos que disfrutan de tener espacio adicional para invitados u oficina en casa. Todos los espacios del adosado están en perfectas condiciones, gracias a una reforma reciente que garantiza un acabado impecable. Con gran atención al diseño interior, este adosado es muy iluminado, creando un ambiente cálido y acogedor en cada rincón. Las amplias ventanas permiten que la luz natural inunde el hogar, destacando sus características modernas. Ubicado en Monte Biarritz, disfrutarás de la tranquilidad y comodidad de un vecindario exclusivo, con la ventaja de estar cerca del mar.  Para más información y para concertar una visita, no dudes en contactarnos. ¡Es tu oportunidad para vivir cerca de la playa en una casa perfectamente acondicionada!"
            },
            5: {
                title: "Piso en venta en calle Sierra Cazorla",
                location: "Lomas de Marbella Club, Marbella",
                price: 849000,
                pricePerSqm: 3343,
                priceComparison: "3% por debajo de la media de precios de la zona",
                builtArea: 254,
                usefulArea: 254,
                bedrooms: 3,
                bathrooms: 3,
                lat: 36.5118884,
                lng: -4.9380596,
                images: [
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/03/2e/95/1257669958.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/14/2c/c9/1257669913.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/14/c1/2b/1257669928.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/18/18/46/1257669956.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/19/94/db/1257669973.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/26/87/e3/1257669860.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/28/39/6b/1257669917.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/2e/3a/1c/1257669892.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/30/b8/42/1257669924.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/38/86/f1/1257669949.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/62/fb/b8/1257669875.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/74/e5/bc/1257669879.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/79/e9/c2/1257669950.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/7c/27/9c/1257669945.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/7e/14/1f/1257669955.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/85/0a/06/1257669884.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/8c/8a/40/1257669952.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/8d/ae/f5/1257669951.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/8d/f0/d6/1257669947.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/90/8f/e2/1257669890.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/a9/69/b3/1257669900.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/aa/f8/c9/1257669946.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/bc/af/e9/1252620617.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/d1/67/b7/1257669908.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/d4/bc/2c/1257669909.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/d8/8e/84/1257669889.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/dc/57/6f/1257669904.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/ee/d6/b2/1257669911.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/f1/e0/a7/1257669886.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/f7/30/9e/1257669861.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/f9/91/a6/1257669882.webp",
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/fd/0d/9a/1257669906.webp"
                ],
                description: "Sin Comisión de Agencia! PRECIO NEGOCIABLE - HACER OFERTA ¡Descubre tu nuevo hogar en la prestigiosa Milla de Oro! Este amplio apartamento orientado al este te ofrece una vida de lujo y comodidad. Con 254m² construidos, ampliables hasta 300m², disfrutarás de espacios generosos y luminosos. La comunidad es un oasis de tranquilidad, rodeada de vegetación y con varias piscinas para tu disfrute. Además, tendrás acceso directo a una de ellas desde tu propia vivienda. El apartamento cuenta con 3 dormitorios, 3 baños, armarios empotrados y se encuentra en excelente estado. Construido en 2002, dispone de aire acondicionado, ascensor y una plaza de garaje incluida en el precio. También incluye un trastero para mayor comodidad. La ubicación es estratégica, con fácil acceso a la autopista y cerca de supermercados, farmacias y colegios. La comunidad se mantiene en condiciones impecables, ofreciendo un entorno seguro y agradable para toda la familia. Con una clase energética A tanto en consumo de energía como en emisiones de CO2, este hogar es eficiente y respetuoso con el medio ambiente. No pierdas la oportunidad de vivir en uno de los lugares más exclusivos y bien ubicados de la ciudad. ¡Ven a conocerlo y enamórate!"
            },
            6: {
                title: "Estudio en venta en Retiro",
                location: "Retiro, Madrid",
                price: 320000,
                pricePerSqm: 8000,
                priceComparison: "igual a la media de precios de la zona",
                builtArea: 40,
                usefulArea: 38,
                bedrooms: 1,
                bathrooms: 1,
                lat: 40.4150,
                lng: -3.6850,
                images: [
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/5a/c4/85/1347007848.webp"
                ],
                description: "Acogedor estudio cerca del Parque del Retiro, ideal para jóvenes profesionales."
            },
            7: {
                title: "Piso en venta en Malasaña",
                location: "Malasaña, Madrid",
                price: 550000,
                pricePerSqm: 6875,
                priceComparison: "3% por encima de la media de precios de la zona",
                builtArea: 80,
                usefulArea: 75,
                bedrooms: 2,
                bathrooms: 2,
                lat: 40.4250,
                lng: -3.7050,
                images: [
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/3c/54/a2/1347007801.webp"
                ],
                description: "Moderno piso en el vibrante barrio de Malasaña, rodeado de cafeterías y vida nocturna."
            },
            8: {
                title: "Piso en venta en Chueca",
                location: "Chueca, Madrid",
                price: 680000,
                pricePerSqm: 7556,
                priceComparison: "4% por encima de la media de precios de la zona",
                builtArea: 90,
                usefulArea: 85,
                bedrooms: 2,
                bathrooms: 2,
                lat: 40.4220,
                lng: -3.6950,
                images: [
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/96/6b/9a/1347007850.webp"
                ],
                description: "Piso de diseño en Chueca, con todas las comodidades y un estilo contemporáneo único."
            },
            9: {
                title: "Piso en venta en Lavapiés",
                location: "Lavapiés, Madrid",
                price: 395000,
                pricePerSqm: 5642,
                priceComparison: "1% por debajo de la media de precios de la zona",
                builtArea: 70,
                usefulArea: 65,
                bedrooms: 2,
                bathrooms: 1,
                lat: 40.4080,
                lng: -3.7000,
                images: [
                    "https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/77/54/29/1347007867.webp"
                ],
                description: "Piso con carácter en el multicultural barrio de Lavapiés, lleno de arte y diversidad."
            }
        };
    
        const property = propertyData[propertyId] || propertyData[1];
    
        // Determinar la clase CSS para el precio comparativo
        let priceComparisonClass = 'neutral';
        if (property.priceComparison.includes('por encima')) {
            priceComparisonClass = 'above-average';
        } else if (property.priceComparison.includes('por debajo')) {
            priceComparisonClass = 'below-average';
        }
    
        // Obtener el contenedor del grid
        const propertiesColumn = document.querySelector('.properties-column');
        
        // Crear la tarjeta deslizante
        const slideCard = document.createElement('div');
        slideCard.className = 'property-slide-card';
        slideCard.id = 'propertySlideCard';
        
        slideCard.innerHTML = `
            <div class="property-slide-content">
                <button class="property-slide-close" onclick="closePropertySlide()">
                    <img src="https://cdn-icons-png.flaticon.com/512/2723/2723639.png" alt="Cerrar" style="width: 16px; height: 16px;">
                </button>
                
                <div class="property-slide-header">
                    <div class="property-slide-title">${property.title}</div>
                </div>
                
                <div class="property-slide-location-area">
                    <div class="property-slide-location">${property.location}</div>
                </div>
                
                <div class="property-slide-price-area">
                    <div class="property-slide-price">${formatPrice(property.price)}</div>
                    <div class="property-slide-price-per-sqm">${property.pricePerSqm.toLocaleString('es-ES', { maximumFractionDigits: 2 })} €/m²</div>
                    <div class="price-comparison">
                        <span class="price-percentage">${getPricePercentage(property.priceComparison)}</span>
                        <span class="price-comparison-text">${getPriceComparisonText(property.priceComparison)}</span>
                    </div>
                </div>
                
                <div class="property-slide-specs-area">
                    <div class="property-slide-specs">
                        <div class="property-slide-spec">${property.builtArea} m² construidos, ${property.usefulArea} m² útiles</div>
                        <div class="property-slide-spec">${property.bedrooms} habitaciones</div>
                        <div class="property-slide-spec">${property.bathrooms} baños</div>
                    </div>
                </div>
                
                <button class="contact-sales-btn" onclick="showContactInfoPopup('${property.title}')">
                    Más Información
                </button>
                
                <div class="property-slide-map">
                    <iframe 
                        width="100%" 
                        height="100%" 
                        frameborder="0" 
                        style="border:0"
                        src="https://www.google.com/maps/embed/v1/view?key=AIzaSyAf-L38UI3hGyYrMJjeFO0Ij2n1p1mCyMk&center=${property.lat},${property.lng}&zoom=16"
                        allowfullscreen>
                    </iframe>
                </div>
                
                <div class="property-slide-carousel-area">
                    <div class="property-slide-carousel" id="slideCarousel">
                        ${property.images.map((img, index) => 
                            `<img src="${img}" alt="${property.title}" ${index === 0 ? 'class="active"' : ''} onclick="openImageZoom('${img}')">`
                        ).join('')}
                        ${property.images.length > 1 ? `
                            <button class="slide-carousel-nav slide-carousel-prev" onclick="changeSlideImage(-1)">‹</button>
                            <button class="slide-carousel-nav slide-carousel-next" onclick="changeSlideImage(1)">›</button>
                        ` : ''}
                    </div>
                    
                    ${property.images.length > 1 ? `
                        <div class="carousel-indicators">
                            ${property.images.map((_, index) => 
                                `<div class="carousel-dot ${index === 0 ? 'active' : ''}" onclick="goToSlideImage(${index})"></div>`
                            ).join('')}
                        </div>
                    ` : ''}
                </div>
                
                <div class="property-slide-description-area">
                    <div class="description-title">Descripción</div>
                    <div class="property-slide-description">${property.description}</div>
                </div>
                
                <div class="property-feedback-area">
                    <div class="feedback-question">¿Qué te parece esta propiedad?</div>
                    <div class="feedback-buttons">
                        <button class="feedback-btn" onclick="selectFeedback('like', this)" data-property-id="${propertyId}">👍</button>
                        <button class="feedback-btn" onclick="selectFeedback('dislike', this)" data-property-id="${propertyId}">👎</button>
                    </div>
                </div>
            </div>
        `;
        
        // Añadir la tarjeta al contenedor de propiedades
        propertiesColumn.appendChild(slideCard);
        
        // Activar la animación de deslizamiento
        setTimeout(() => {
            slideCard.classList.add('active');
        }, 10);
        
        // Inicializar índice de imagen actual
        window.currentSlideImageIndex = 0;
    }
        
    function closePropertySlide() {
    const slideCard = document.getElementById('propertySlideCard');
    if (slideCard) {
        slideCard.classList.remove('active');
        setTimeout(() => {
            slideCard.remove();
        }, 300);
    }
}

    function changeSlideImage(direction) {
        const carousel = document.getElementById('slideCarousel');
        const images = carousel.querySelectorAll('img');
        const dots = document.querySelectorAll('.carousel-dot');
        
        // Remover clase active de imagen y dot actuales
        images[window.currentSlideImageIndex].classList.remove('active');
        if (dots.length > 0) {
            dots[window.currentSlideImageIndex].classList.remove('active');
        }
        
        // Calcular nuevo índice
        window.currentSlideImageIndex += direction;
        
        if (window.currentSlideImageIndex >= images.length) {
            window.currentSlideImageIndex = 0;
        } else if (window.currentSlideImageIndex < 0) {
            window.currentSlideImageIndex = images.length - 1;
        }
        
        // Activar nueva imagen y dot
        images[window.currentSlideImageIndex].classList.add('active');
        if (dots.length > 0) {
            dots[window.currentSlideImageIndex].classList.add('active');
        }
    }
    
    function goToSlideImage(index) {
        const carousel = document.getElementById('slideCarousel');
        const images = carousel.querySelectorAll('img');
        const dots = document.querySelectorAll('.carousel-dot');
        
        // Remover clase active de imagen y dot actuales
        images[window.currentSlideImageIndex].classList.remove('active');
        if (dots.length > 0) {
            dots[window.currentSlideImageIndex].classList.remove('active');
        }
        
        // Establecer nuevo índice
        window.currentSlideImageIndex = index;
        
        // Activar nueva imagen y dot
        images[window.currentSlideImageIndex].classList.add('active');
        if (dots.length > 0) {
            dots[window.currentSlideImageIndex].classList.add('active');
        }
    }

    // Cerrar tarjeta deslizante con tecla Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const slideCard = document.getElementById('propertySlideCard');
            if (slideCard) {
                closePropertySlide();
            }
        }
    });

        function selectFeedback(type, button) {
            const propertyId = button.dataset.propertyId;
            const allFeedbackBtns = document.querySelectorAll('.feedback-btn');
            
            // Remover selección previa
            allFeedbackBtns.forEach(btn => btn.classList.remove('selected'));
            
            // Marcar el botón seleccionado
            button.classList.add('selected');
            
            // Aquí puedes enviar el feedback a tu backend
            console.log(`Feedback para propiedad ${propertyId}: ${type}`);
            
            // No mostrar mensaje de confirmación, solo mantener la selección
        }

        function getPricePercentage(priceComparison) {
            // Extraer solo el porcentaje (ej: "3%")
            const match = priceComparison.match(/(\d+%)/);
            return match ? match[1] : '';
        }
        
        function getPriceComparisonText(priceComparison) {
            // Extraer todo excepto el porcentaje
            return priceComparison.replace(/(\d+%)\s*/, '');
        }

        function startGridSearch() {
            const propertiesHeader = document.querySelector('.properties-header h3');
            const gridContainer = document.querySelector('.grid-container');
            
            // Cambiar título con animación
            let searchTitleInterval;
            let visible = true;
            
            function animateSearchTitle() {
                if (visible) {
                    propertiesHeader.style.opacity = '0';
                    setTimeout(() => {
                        propertiesHeader.textContent = 'Buscando propiedades...';
                        propertiesHeader.style.opacity = '1';
                    }, 300);
                } else {
                    propertiesHeader.style.opacity = '0';
                    setTimeout(() => {
                        propertiesHeader.textContent = '';
                        propertiesHeader.style.opacity = '1';
                    }, 300);
                }
                visible = !visible;
            }
            
            // Iniciar animación del título
            animateSearchTitle();
            searchTitleInterval = setInterval(animateSearchTitle, 2500);
            
            // Guardar el intervalo para poder limpiarlo después
            window.gridSearchInterval = searchTitleInterval;
            
            // Aplicar overlays y loading a las propiedades
            const propertyCards = document.querySelectorAll('.property-card');
            propertyCards.forEach(card => {
                card.classList.add('searching');
                
                // Cambiar precio a "Búsqueda en curso..."
                const priceElement = card.querySelector('.property-price');
                if (priceElement) {
                    priceElement.textContent = 'Búsqueda en curso...';
                }
                
                // Ocultar ubicación
                const locationElement = card.querySelector('.property-location');
                if (locationElement) {
                    locationElement.style.display = 'none';
                }
                
                // Añadir overlay con loading
                const overlay = document.createElement('div');
                overlay.className = 'search-overlay';
                overlay.innerHTML = '<div class="search-loader"></div>';
                card.appendChild(overlay);
            });
            
            console.log('Estado de búsqueda activado en el grid');
        }

        function stopGridSearch(propertiesCount = null) {
            // Limpiar intervalo del título
            if (window.gridSearchInterval) {
                clearInterval(window.gridSearchInterval);
                window.gridSearchInterval = null;
            }
            
            // Restaurar/actualizar título
            const propertiesHeader = document.querySelector('.properties-header h3');
            propertiesHeader.style.opacity = '1';
            
            if (propertiesCount !== null) {
                // Mostrar número de propiedades encontradas con el icono ajustado
                propertiesHeader.innerHTML = `<img src="https://cdn-icons-png.flaticon.com/512/3355/3355672.png" alt="Encontradas" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 5px; margin-top: -3px;"> ${propertiesCount} propiedades encontradas`;
            } else {
                // Restaurar título original
                propertiesHeader.textContent = 'Nuestras Propiedades';
            }
            
            // Remover overlays
            const overlays = document.querySelectorAll('.search-overlay');
            overlays.forEach(overlay => overlay.remove());
            
            // Remover clase searching
            const propertyCards = document.querySelectorAll('.property-card');
            propertyCards.forEach(card => {
                card.classList.remove('searching');
                
                // Mostrar ubicación de nuevo
                const locationElement = card.querySelector('.property-location');
                if (locationElement) {
                    locationElement.style.display = 'block';
                }
            });
            
            console.log('Estado de búsqueda desactivado en el grid');
        }

        function updateGridWithResults(properties, totalPropertiesFromCallback = null) {
            console.log('Actualizando grid con propiedades:', properties.length);
            console.log('Total propiedades del callback:', totalPropertiesFromCallback);
            
            // Usar el número del callback si está disponible, sino usar el length del array
            const totalProperties = totalPropertiesFromCallback || properties.length;
            
            // Detener estado de búsqueda con el número de propiedades
            stopGridSearch(totalProperties);
            
            // Añadir botón "Ver más propiedades" basándose en el número del callback
            addViewMoreButton(totalProperties);
            
            const propertyCards = document.querySelectorAll('.property-card');
            
            // Actualizar hasta 9 propiedades
            const propertiesToShow = properties.slice(0, 9);
            
            propertiesToShow.forEach((property, index) => {
                if (index < propertyCards.length) {
                    const card = propertyCards[index];
                    
                    // Restaurar opacidad y funcionalidad
                    card.style.opacity = '1';
                    
                    // Actualizar imagen de fondo
                    const imageDiv = card.querySelector('.property-image');
                    if (imageDiv && property.thumbnail) {
                        imageDiv.style.backgroundImage = `url('${property.thumbnail}')`;
                        imageDiv.style.backgroundSize = 'cover';
                        imageDiv.style.backgroundPosition = 'center';
                    }
                    
                    // Actualizar precio
                    const priceElement = card.querySelector('.property-price');
                    if (priceElement && property.price) {
                        priceElement.textContent = formatPrice(property.price);
                        priceElement.style.color = '#333';
                        priceElement.style.fontSize = '14px';
                    }
                    
                    // Actualizar ubicación
                    const locationElement = card.querySelector('.property-location');
                    if (locationElement && property.location) {
                        locationElement.textContent = property.location;
                        locationElement.style.display = 'block';
                    }
                    
                    // Actualizar amenities
                    updateCardAmenities(card, property.amenities || {});
                    
                    // Actualizar click handler para abrir la propiedad correcta
                    card.onclick = () => openDynamicPropertyDetail(property);
                    
                    // Guardar datos de la propiedad en el elemento para futura referencia
                    card.dataset.propertyData = JSON.stringify(property);
                }
            });
            
            // Si hay menos de 9 propiedades, atenuar las tarjetas sobrantes
            for (let i = propertiesToShow.length; i < propertyCards.length; i++) {
                propertyCards[i].style.opacity = '0.3';
                propertyCards[i].onclick = null;
                
                // Limpiar contenido de tarjetas vacías
                const imageDiv = propertyCards[i].querySelector('.property-image');
                const priceElement = propertyCards[i].querySelector('.property-price');
                const locationElement = propertyCards[i].querySelector('.property-location');
                const amenitiesContainer = propertyCards[i].querySelector('.amenities-icons');
                
                if (imageDiv) imageDiv.style.backgroundImage = '';
                if (priceElement) priceElement.textContent = '';
                if (locationElement) locationElement.textContent = '';
                if (amenitiesContainer) amenitiesContainer.innerHTML = '';
            }
            
            console.log(`Grid actualizado con ${propertiesToShow.length} de ${totalProperties} propiedades`);
        }

        function addViewMoreButton(totalProperties) {
            console.log('Intentando añadir botón ver más. Total propiedades:', totalProperties);
            
            // Remover botón existente si lo hay
            const existingButton = document.getElementById('viewMorePropertiesBtn');
            if (existingButton) {
                existingButton.remove();
                console.log('Botón existente removido');
            }
            
            // Solo añadir si hay más de 9 propiedades
            if (totalProperties > 9) {
                const propertiesHeader = document.querySelector('.properties-header');
                console.log('Properties header encontrado:', propertiesHeader);
                
                if (propertiesHeader) {
                    const viewMoreBtn = document.createElement('button');
                    viewMoreBtn.id = 'viewMorePropertiesBtn';
                    viewMoreBtn.className = 'view-more-btn';
                    viewMoreBtn.textContent = 'Ver más propiedades'; // CAMBIO: texto fijo
                    viewMoreBtn.onclick = function() {
                        console.log('Botón ver más clicked');
                        showLoginPopup();
                    };
                    
                    propertiesHeader.appendChild(viewMoreBtn);
                    console.log('Botón ver más añadido exitosamente');
                } else {
                    console.error('No se encontró properties-header');
                }
            } else {
                console.log('No se añade botón ver más - solo', totalProperties, 'propiedades');
            }
        }
        
        function updateCardAmenities(card, amenities) {
            const amenitiesContainer = card.querySelector('.amenities-icons');
            if (!amenitiesContainer) return;
            
            // Limpiar amenities existentes
            amenitiesContainer.innerHTML = '';
            
            // Mapeo de amenities a iconos
            const amenityIcons = {
                elevator: { icon: 'https://cdn-icons-png.flaticon.com/512/948/948747.png', title: 'Ascensor' },
                parking: { icon: 'https://cdn-icons-png.flaticon.com/512/75/75905.png', title: 'Parking' },
                terrace: { icon: 'https://cdn-icons-png.flaticon.com/512/3623/3623094.png', title: 'Terraza' },
                pool: { icon: 'https://cdn-icons-png.flaticon.com/512/2932/2932366.png', title: 'Piscina' },
                garden: { icon: 'https://cdn-icons-png.flaticon.com/512/1973/1973668.png', title: 'Jardín' }
            };
            
            // Añadir iconos para amenities activos (máximo 5 para que no se desborde)
            let count = 0;
            Object.keys(amenities).forEach(amenityKey => {
                if (count < 5 && amenities[amenityKey] && amenityIcons[amenityKey]) {
                    const amenityDiv = document.createElement('div');
                    amenityDiv.className = 'amenity-icon';
                    amenityDiv.title = amenityIcons[amenityKey].title;
                    
                    const img = document.createElement('img');
                    img.src = amenityIcons[amenityKey].icon;
                    img.alt = amenityIcons[amenityKey].title;
                    
                    amenityDiv.appendChild(img);
                    amenitiesContainer.appendChild(amenityDiv);
                    count++;
                }
            });
        }

        function openDynamicPropertyDetail(property) {
            // Similar a openPropertyDetail pero usando datos dinámicos
            const propertiesColumn = document.querySelector('.properties-column');
            
            const slideCard = document.createElement('div');
            slideCard.className = 'property-slide-card';
            slideCard.id = 'propertySlideCard';
            
            const priceComparisonClass = getPriceComparisonClass(property.priceComparison || '');
            
            slideCard.innerHTML = `
                <div class="property-slide-content">
                    <button class="property-slide-close" onclick="closePropertySlide()">×</button>
                    
                    <div class="property-slide-header">
                        <div class="property-slide-title">${property.title}</div>
                    </div>
                    
                    <div class="property-slide-location-area">
                        <div class="property-slide-location">${property.location}</div>
                    </div>
                    
                    <div class="property-slide-price-area">
                        <div class="property-slide-price">${formatPrice(property.price)}</div>
                        <div class="property-slide-price-per-sqm">${property.pricePerSqm?.toLocaleString('es-ES', { maximumFractionDigits: 2 }) || 'N/A'} €/m²</div>
                        ${property.priceComparison ? `
                            <div class="price-comparison ${priceComparisonClass}">
                                <span class="price-comparison-text">${property.priceComparison}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="property-slide-specs-area">
                        <div class="property-slide-specs">
                            <div class="property-slide-spec">${property.builtArea || 'N/A'} m² construidos, ${property.usefulArea || 'N/A'} m² útiles</div>
                            <div class="property-slide-spec">${property.bedrooms || 'N/A'} habitaciones</div>
                            <div class="property-slide-spec">${property.bathrooms || 'N/A'} baños</div>
                        </div>
                    </div>
                    
                    <button class="contact-sales-btn" onclick="showContactInfoPopup('${property.title}')">
                        Más Información
                    </button>
                    
                    <div class="property-slide-map">
                        ${property.lat && property.lng ? `
                            <iframe 
                                width="100%" 
                                height="100%" 
                                frameborder="0" 
                                style="border:0"
                                src="https://www.google.com/maps/embed/v1/view?key=AIzaSyAf-L38UI3hGyYrMJjeFO0Ij2n1p1mCyMk&center=${property.lat},${property.lng}&zoom=16"
                                allowfullscreen>
                            </iframe>
                        ` : '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #888;">Ubicación no disponible</div>'}
                    </div>
                    
                    <div class="property-slide-carousel-area">
                        <div class="property-slide-carousel" id="slideCarousel">
                            ${property.images && property.images.length > 0 ? 
                                property.images.map((img, index) => 
                                    `<img src="${img}" alt="${property.title}" ${index === 0 ? 'class="active"' : ''} onclick="openImageZoom('${img}')">`
                                ).join('') :
                                `<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #888;">No hay imágenes disponibles</div>`
                            }
                            ${property.images && property.images.length > 1 ? `
                                <button class="slide-carousel-nav slide-carousel-prev" onclick="changeSlideImage(-1)">‹</button>
                                <button class="slide-carousel-nav slide-carousel-next" onclick="changeSlideImage(1)">›</button>
                            ` : ''}
                        </div>
                        
                        ${property.images && property.images.length > 1 ? `
                            <div class="carousel-indicators">
                                ${property.images.map((_, index) => 
                                    `<div class="carousel-dot ${index === 0 ? 'active' : ''}" onclick="goToSlideImage(${index})"></div>`
                                ).join('')}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="property-slide-description-area">
                        <div class="description-title">Descripción</div>
                        <div class="property-slide-description">${property.description || 'No hay descripción disponible.'}</div>
                    </div>
                    
                    <div class="property-feedback-area">
                        <div class="feedback-question">¿Qué te parece esta propiedad?</div>
                        <div class="feedback-buttons">
                            <button class="feedback-btn" onclick="selectFeedback('like', this)" data-property-id="${property.property_id}">👍</button>
                            <button class="feedback-btn" onclick="selectFeedback('dislike', this)" data-property-id="${property.property_id}">👎</button>
                        </div>
                    </div>
                </div>
            `;
            
            propertiesColumn.appendChild(slideCard);
            
            setTimeout(() => {
                slideCard.classList.add('active');
            }, 10);
            
            window.currentSlideImageIndex = 0;
        }

        function getPriceComparisonClass(priceComparison) {
            if (priceComparison.includes('por encima')) return 'above-average';
            if (priceComparison.includes('por debajo')) return 'below-average';
            return 'neutral';
        }

        // Función para probar el botón "Ver más propiedades"
        window.testViewMoreButton = function() {
            // Simular propiedades para testing
            const mockProperties = [];
            for (let i = 1; i <= 15; i++) {
                mockProperties.push({
                    id: i,
                    title: `Propiedad ${i}`,
                    price: 300000 + (i * 10000),
                    location: `Ubicación ${i}`,
                    thumbnail: 'https://img4.idealista.com/blur/480_360_mq/0/id.pro.es.image.master/be/b2/f1/1217657644.webp'
                });
            }
            
            console.log('Probando con', mockProperties.length, 'propiedades');
            updateGridWithResults(mockProperties);
        };

        // =================== FUNCIONES SUB-SIDEBAR PROPIEDADES ===================
        function initPropertiesSubSidebar() {
            console.log('Inicializando sub-sidebar de propiedades');
            
            const subOptions = document.querySelectorAll('.sub-sidebar-option');
            
            subOptions.forEach(option => {
                const subOptionName = option.dataset.subOption;
                
                option.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('Sub-opción clickeada:', subOptionName);
                    
                    if (subOptionName === 'buscar') {
                        hidePropertiesSubSidebar();
                        return;
                    } else {
                        // Mostrar popup de login para favoritos y ofertas
                        if (typeof showLoginPopup === 'function') {
                            showLoginPopup();
                        } else {
                            console.error('Función showLoginPopup no existe!');
                        }
                    }
                });
            });
        }
        
        function togglePropertiesSubSidebar() {
            const subSidebar = document.getElementById('propertiesSubSidebar');
            const container = document.querySelector('.container');
            const isActive = subSidebar.classList.contains('active');
            
            if (isActive) {
                hidePropertiesSubSidebar();
            } else {
                showPropertiesSubSidebar();
            }
        }
        
       function showPropertiesSubSidebar() {
            const subSidebar = document.getElementById('propertiesSubSidebar');
            
            // Activar el icono de propiedades
            setActiveSidebarOption('propiedades');
            
            // Limpiar todas las selecciones de sub-opciones
            document.querySelectorAll('.sub-sidebar-option').forEach(opt => {
                opt.classList.remove('active');
            });
            
            // Resetear iconos de sub-sidebar a estado inactivo
            updateSubSidebarIcons(null);
            
            // Mostrar sub-sidebar
            subSidebar.classList.add('active');
            
            console.log('Sub-sidebar de propiedades mostrada con iconos limpios');
        }
        
        function hidePropertiesSubSidebar() {
            const subSidebar = document.getElementById('propertiesSubSidebar');
            
            // Desactivar sub-sidebar
            subSidebar.classList.remove('active');
            
            // CAMBIO: NO desactivar el icono de propiedades automáticamente
            // Solo limpiar las sub-opciones
            document.querySelectorAll('.sub-sidebar-option').forEach(opt => {
                opt.classList.remove('active');
            });
            
            // Resetear iconos de sub-sidebar
            updateSubSidebarIcons(null);
            
            console.log('Sub-sidebar de propiedades oculta, manteniendo estado principal');
        }
        
        function setActiveSubSidebarOption(optionName) {
            // Remover clase active de todas las sub-opciones
            document.querySelectorAll('.sub-sidebar-option').forEach(opt => {
                opt.classList.remove('active');
            });
            
            // Solo añadir clase active si se especifica una opción
            if (optionName) {
                const selectedSubOption = document.querySelector(`[data-sub-option="${optionName}"]`);
                if (selectedSubOption) {
                    selectedSubOption.classList.add('active');
                }
                // Actualizar iconos de sub-sidebar
                updateSubSidebarIcons(optionName);
            } else {
                // Si no hay opción activa, resetear todos los iconos
                updateSubSidebarIcons(null);
            }
        }
        
        function updateSubSidebarIcons(activeOption = null) {
            const subOptions = document.querySelectorAll('.sub-sidebar-option');
            
            subOptions.forEach(option => {
                const optionName = option.dataset.subOption;
                const icon = option.querySelector('.sub-sidebar-icon');
                
                if (icon) {
                    let iconSrc = '';
                    
                    switch(optionName) {
                        case 'buscar':
                            iconSrc = activeOption === 'buscar' ? 
                                'https://cdn-icons-png.flaticon.com/512/9479/9479330.png' :
                                'https://cdn-icons-png.flaticon.com/512/9479/9479251.png';
                            break;
                        case 'favoritos':
                            iconSrc = activeOption === 'favoritos' ? 
                                'https://cdn-icons-png.flaticon.com/512/1077/1077086.png' :
                                'https://cdn-icons-png.flaticon.com/512/1077/1077035.png';
                            break;
                        case 'ofertas':
                            iconSrc = activeOption === 'ofertas' ? 
                                'https://cdn-icons-png.flaticon.com/512/9018/9018946.png' :
                                'https://cdn-icons-png.flaticon.com/512/9018/9018942.png';
                            break;
                    }
                    
                    icon.src = iconSrc;
                }
            });
        }

        // Función para cambiar a vista de chat en móvil
        function switchToMobileChatView() {
            const mobileWelcome = document.querySelector('.mobile-welcome-section');
            const mobileChatArea = document.querySelector('.mobile-chat-area');
            
            if (mobileWelcome && mobileChatArea) {
                // Ocultar sección de bienvenida
                mobileWelcome.classList.add('fade-out');
                
                // Mostrar área de chat
                mobileChatArea.classList.add('fade-in');
            }
        }
                
    </script>
</body>
</html>
